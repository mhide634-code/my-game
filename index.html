<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chem-Verse: Origin</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0a0a12;
            --bg-panel: rgba(20, 20, 35, 0.95);
            --accent-blue: #00f2ff;
            --accent-gold: #ffd700;
            --accent-red: #ff0055;
            --accent-green: #00ff88;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --card-frame-n: #7f8c8d;
            --card-frame-r: #cd7f32;
            --card-frame-sr: #c0c0c0;
            --card-frame-ssr: #ffd700;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            margin: 0;
            user-select: none;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            height: 100vh;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(0, 242, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(255, 0, 85, 0.1) 0%, transparent 50%);
        }
        h1, h2, h3, .deck-title, .leader-name, .card-symbol {
            font-family: 'Orbitron', sans-serif;
            text-transform: uppercase;
        }

        /* --- ÂÖ±ÈÄö„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; box-sizing: border-box;
            transition: opacity 0.3s ease-in-out;
        }
        .hidden { display: none !important; opacity: 0; pointer-events: none; }

        .menu-btn {
            background: linear-gradient(45deg, rgba(0, 242, 255, 0.2), rgba(0,0,0,0));
            border: 2px solid var(--accent-blue);
            color: var(--accent-blue);
            padding: 15px 40px; margin: 10px;
            border-radius: 30px; font-size: 18px; font-weight: bold;
            cursor: pointer; transition: 0.3s;
            text-shadow: 0 0 5px var(--accent-blue);
            box-shadow: 0 0 10px rgba(0, 242, 255, 0.3), inset 0 0 10px rgba(0, 242, 255, 0.1);
            width: 80%; max-width: 300px;
            text-align: center;
            text-decoration: none; /* For disabled links */
        }
        .menu-btn:hover:not(.disabled) {
            background: var(--accent-blue); color: var(--bg-dark);
            box-shadow: 0 0 20px var(--accent-blue);
            transform: scale(1.05);
        }
        .menu-btn.disabled {
            border-color: #555; color: #888; text-shadow: none; box-shadow: none;
            cursor: not-allowed; background: rgba(50,50,50,0.2);
        }

        /* --- „Éõ„Éº„É†ÁîªÈù¢ --- */
        #home-screen {
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="2" fill="rgba(0,242,255,0.3)"/></svg>');
            animation: bgScroll 20s linear infinite;
        }
        @keyframes bgScroll { from { background-position: 0 0; } to { background-position: 0 100%; } }
        .game-title {
            font-size: 36px; margin-bottom: 50px; text-align: center;
            color: transparent;
            background: linear-gradient(to right, var(--accent-blue), #ff00ff, var(--accent-gold));
            -webkit-background-clip: text; background-clip: text;
            animation: titleShine 3s infinite linear;
        }
        @keyframes titleShine { 0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(360deg); } }

        /* --- „Éá„ÉÉ„Ç≠ÈÅ∏ÊäûÁîªÈù¢ --- */
        #deck-select-screen h2 { color: var(--accent-blue); text-shadow: 0 0 10px var(--accent-blue); }
        .deck-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
            width: 100%; max-width: 800px; padding: 20px 0;
            overflow-y: auto;
        }
        .deck-card {
            background: var(--bg-panel);
            border: 2px solid rgba(255,255,255,0.1);
            padding: 15px; border-radius: 12px; cursor: pointer;
            display: flex; flex-direction: column; justify-content: space-between;
            min-height: 120px; transition: 0.3s;
            position: relative; overflow: hidden;
        }
        .deck-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 5px;
            background: var(--accent-blue);
        }
        .deck-card:hover {
            border-color: var(--accent-blue);
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.3);
            transform: translateY(-5px);
        }
        .deck-title { font-size: 18px; color: var(--accent-blue); margin-bottom: 5px; }
        .deck-desc { font-size: 12px; color: var(--text-secondary); line-height: 1.4; }

        /* --- „Ç≤„Éº„É†„Éú„Éº„Éâ („Çπ„Éû„ÉõÁ∏¶) --- */
        #game-board {
            display: flex; /* ÂàùÊúüÁä∂ÊÖã„ÅØflex„Åß„ÄÅJS„ÅßÂà∂Âæ° */
        }
        
        #enemy-hand-area { height: 8%; background: rgba(20,20,30,0.8); display: flex; justify-content: center; align-items: center; gap: 2px; border-bottom: 1px solid #333; }
        #enemy-field { height: 22%; background: rgba(30,30,45,0.6); border-bottom: 2px solid var(--accent-blue); display: flex; justify-content: center; align-items: center; perspective: 1000px; }
        
        #info-area {
            height: 12%; background: var(--bg-panel);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px; z-index: 10; box-shadow: 0 0 25px rgba(0,0,0,0.8);
            border-top: 1px solid rgba(255,255,255,0.1); border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        #player-field { height: 22%; background: rgba(30,30,45,0.6); border-top: 2px solid var(--accent-blue); display: flex; justify-content: center; align-items: center; perspective: 1000px; }
        #player-hand-area { 
            height: 38%; background: rgba(20,20,35,0.9);
            overflow-x: auto; display: flex; align-items: center; 
            padding-left: 20px; gap: 10px;
        }

        /* --- „Ç´„Éº„Éâ„Éá„Ç∂„Ç§„É≥ (Âà∑Êñ∞) --- */
        .card {
            width: 80px; height: 115px; /* „Éï„Ç£„Éº„É´„Éâ„Çµ„Ç§„Ç∫ */
            background: #111;
            border-radius: 8px; position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            border: 2px solid #555; flex-shrink: 0;
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            overflow: hidden;
        }
        /* ÊâãÊú≠„ÅÆ„Ç´„Éº„Éâ„ÅØÂ§ß„Åç„Åè */
        #player-hand-area .card { 
            width: 100px; height: 140px; 
            box-shadow: -5px 5px 20px rgba(0,0,0,0.7);
            transform: rotate(-2deg); /* Â∞ë„ÅóÂÇæ„Åë„Å¶„É™„Ç¢„É´„Å´ */
            margin-right: -10px; /* Èáç„Å≠„Çã */
        }
        #player-hand-area .card:hover,
        #player-hand-area .card.selected {
            transform: rotate(0deg) translateY(-30px) scale(1.1);
            z-index: 100; margin-right: 10px;
        }

        /* „É¨„Ç¢„É™„ÉÜ„Ç£Âà•„Éï„É¨„Éº„É† */
        .card[data-rarity="N"] { border-color: var(--card-frame-n); }
        .card[data-rarity="R"] { border-color: var(--card-frame-r); background: linear-gradient(135deg, #222, #3a2a1a); }
        .card[data-rarity="SR"] { border-color: var(--card-frame-sr); background: linear-gradient(135deg, #222, #334); box-shadow: 0 0 10px rgba(192,192,192,0.3); }
        .card[data-rarity="SSR"] { 
            border-color: var(--card-frame-ssr); 
            background: linear-gradient(135deg, #332200, #554400);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
            animation: holoShine 3s infinite linear;
        }
        @keyframes holoShine { 0% { filter: brightness(1); } 50% { filter: brightness(1.2); } 100% { filter: brightness(1); } }

        /* „Ç§„É©„Çπ„ÉàÈ†òÂüü („Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº) */
        .card-art {
            width: 100%; height: 55%;
            background: #333;
            display: flex; justify-content: center; align-items: center;
            position: relative;
            overflow: hidden;
        }
        .card-art::after { content: ''; position: absolute; top:0; left:0; width:100%; height:100%; background: linear-gradient(to bottom, transparent, rgba(0,0,0,0.8)); }
        .art-placeholder { font-size: 30px; opacity: 0.5; }
        /* Á∞°ÊòìÁöÑ„Å™Â±ûÊÄßËâ≤ÂàÜ„Åë (CSS„Åß„Ç§„É©„Çπ„Éà„ÅÆ‰ª£„Çè„Çä) */
        .art-gas { background: linear-gradient(45deg, #bdc3c7, #2c3e50); color:#ecf0f1; }
        .art-liquid { background: linear-gradient(45deg, #3498db, #2980b9); color:#dcefff; }
        .art-solid { background: linear-gradient(45deg, #95a5a6, #7f8c8d); color:#2c3e50; }
        .art-metal { background: linear-gradient(45deg, #f1c40f, #e67e22); color:#fff; }
        .art-toxic { background: linear-gradient(45deg, #8e44ad, #c0392b); color:#fff; }
        
        .card-info {
            padding: 5px; height: 45%;
            display: flex; flex-direction: column; justify-content: space-between;
            background: rgba(0,0,0,0.6);
        }

        .card-symbol { font-size: 16px; color: var(--accent-blue); text-shadow: 0 0 5px var(--accent-blue); margin: 0; line-height: 1;}
        #player-hand-area .card-symbol { font-size: 20px; }
        .card-name { font-size: 9px; color: var(--text-secondary); overflow: hidden; white-space: nowrap; text-overflow: ellipsis;}
        
        .stats {
            display: flex; justify-content: space-between;
            font-weight: bold; font-size: 12px;
        }
        .stat-box {
            padding: 2px 6px; border-radius: 4px; display: flex; align-items: center; gap: 2px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.2);
        }
        .stat-atk { background: linear-gradient(to bottom, #e67e22, #d35400); }
        .stat-hp { background: linear-gradient(to bottom, #2ecc71, #27ae60); }

        /* „Éê„ÉÉ„Ç∏ */
        .ability-container { position: absolute; top: 2px; right: 2px; display: flex; gap: 2px; z-index: 10; }
        .badge {
            width: 20px; height: 20px; border-radius: 50%; color: white; font-size: 12px;
            display: flex; align-items: center; justify-content: center;
            border: 1px solid rgba(255,255,255,0.8); font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5); text-shadow: 1px 1px 2px black;
        }
        .badge-ward { background: linear-gradient(135deg, #3498db, #2980b9); }
        .badge-toxic { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
        .badge-storm { background: linear-gradient(135deg, #f1c40f, #f39c12); }
        .badge-stealth { background: linear-gradient(135deg, #95a5a6, #7f8c8d); }

        /* Áä∂ÊÖã */
        .card.selected { border-color: var(--accent-gold); box-shadow: 0 0 25px var(--accent-gold); }
        .card.can-attack { border-color: var(--accent-green); box-shadow: 0 0 15px var(--accent-green); animation: pulseGreen 2s infinite; }
        .card.attacking { border-color: var(--accent-red); box-shadow: 0 0 30px var(--accent-red); z-index: 200; transform: scale(1.2) !important; }
        @keyframes pulseGreen { 0% { box-shadow: 0 0 10px var(--accent-green); } 50% { box-shadow: 0 0 25px var(--accent-green); } 100% { box-shadow: 0 0 10px var(--accent-green); } }

        /* --- UI„Éë„Éº„ÉÑ --- */
        .leader { text-align: center; position: relative; padding: 5px; min-width: 70px; }
        .leader-name { font-size: 10px; font-weight: bold; color: var(--accent-blue); margin-bottom: 4px; letter-spacing: 1px;}
        .hp-circle { 
            background: linear-gradient(135deg, #c0392b, #96281b); color: white; border-radius: 50%; 
            width: 40px; height: 40px; line-height: 40px; 
            font-weight: bold; font-size: 16px; margin: 0 auto; 
            border: 3px solid #e74c3c; box-shadow: 0 0 15px #e74c3c, inset 0 0 10px rgba(0,0,0,0.5);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        .turn-info { text-align: center; }
        #turn-display { font-size: 14px; font-weight: bold; color: var(--text-secondary); }
        .mp-bar { font-size: 16px; color: var(--accent-green); font-weight: bold; text-shadow: 0 0 10px var(--accent-green); }

        /* „Éú„Çø„É≥ */
        .action-overlay { 
            position: absolute; bottom: 160px; right: 15px; 
            display: flex; flex-direction: column; gap: 12px; z-index: 50; 
        }
        .game-btn { 
            padding: 14px 20px; border-radius: 30px; border: none; 
            font-weight: bold; color: white; font-size: 12px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); 
            text-transform: uppercase; letter-spacing: 1px; cursor: pointer;
            transition: 0.2s; font-family: 'Orbitron', sans-serif;
        }
        .game-btn:active { transform: scale(0.95); box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .btn-draw { background: linear-gradient(to right, var(--accent-green), #27ae60); } 
        .btn-syn { background: linear-gradient(to right, var(--accent-gold), #f39c12); color: #111; }
        #btn-end-turn { 
            padding: 8px 15px; font-size: 11px; 
            background: linear-gradient(to right, #f39c12, #e67e22);
            border-radius: 20px; border: none; color: white; font-weight: bold;
            box-shadow: 0 0 10px rgba(243, 156, 18, 0.5); font-family: 'Orbitron', sans-serif;
        }
        #btn-end-turn:disabled { background: #555; color: #888; box-shadow: none; }

        #cancel-attack-btn {
            display: none;
            position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%);
            background: linear-gradient(to right, var(--accent-red), #c0392b); color: white;
            padding: 15px 40px; border-radius: 40px; border: 2px solid white;
            font-weight: bold; font-size: 16px; cursor: pointer;
            z-index: 200; box-shadow: 0 0 30px var(--accent-red);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-transform: uppercase; letter-spacing: 1px;
        }
        @keyframes popIn { from { transform: translate(-50%, -50%) scale(0); } to { transform: translate(-50%, -50%) scale(1); } }

        /* --- Ë©≥Á¥∞„Éë„Éç„É´ --- */
        #card-detail-panel {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
            width: 90%; max-width: 340px; background: rgba(15, 15, 25, 0.98);
            border: 2px solid var(--accent-blue); border-radius: 15px; padding: 20px;
            display: none; flex-direction: column; color: white; z-index: 3000;
            box-shadow: 0 0 50px rgba(0, 242, 255, 0.3);
            transition: 0.3s; opacity: 0;
        }
        #card-detail-panel.active { transform: translate(-50%, -50%) scale(1); opacity: 1; }

        .detail-close { position: absolute; top: 10px; right: 15px; font-size: 28px; cursor: pointer; color: var(--text-secondary); }
        .detail-header { text-align: center; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;}
        .detail-symbol { font-size: 42px; font-weight: bold; color: var(--accent-blue); text-shadow: 0 0 15px var(--accent-blue); }
        .detail-name { font-size: 18px; font-weight: bold; margin: 5px 0; }
        .detail-rarity { font-size: 12px; color: var(--accent-gold); margin-bottom: 5px; }
        .detail-stats-box { display: flex; justify-content: center; gap: 20px; margin-bottom: 15px; font-size: 20px; font-weight: bold; }
        .detail-skills { font-size: 13px; max-height: 250px; overflow-y: auto; padding-right: 5px; }
        .skill-item { margin-bottom: 12px; border-left: 4px solid var(--accent-gold); padding-left: 10px; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 0 8px 8px 0; }
        .skill-item-name { font-weight: bold; color: var(--accent-gold); font-size: 14px; }
        .skill-item-desc { color: var(--text-secondary); font-size: 12px; margin-top: 4px; line-height: 1.4; }

        /* --- „Éí„É≥„Éà & „É°„ÉÉ„Çª„Éº„Ç∏ --- */
        #craftable-list {
            position: absolute; bottom: 45%; left: 10px;
            display: flex; flex-direction: column; gap: 8px; z-index: 40; pointer-events: none;
        }
        .craft-hint-btn {
            background: rgba(10, 10, 20, 0.95); border: 1px solid var(--accent-gold); color: white;
            padding: 8px 12px; border-radius: 8px; pointer-events: auto;
            display: flex; flex-direction: column; min-width: 130px;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3); transition: 0.2s;
        }
        .craft-hint-btn:active { transform: scale(0.95); }
        
        #msg-box {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8); padding: 20px 40px; border-radius: 12px; border: 2px solid var(--accent-blue);
            font-size: 24px; font-weight: bold; pointer-events: none; opacity: 0; transition: 0.3s; z-index: 5000; text-align: center; white-space: nowrap;
            color: var(--accent-blue); text-shadow: 0 0 10px var(--accent-blue);
            font-family: 'Orbitron', sans-serif;
        }

        /* --- ÂãùÂà©/ÊïóÂåóÁîªÈù¢ --- */
        #result-screen {
            background: rgba(0,0,0,0.9); z-index: 6000;
        }
        .result-title {
            font-size: 60px; font-weight: bold; margin-bottom: 20px;
            text-transform: uppercase; letter-spacing: 5px;
            animation: resultText 1s ease-out;
        }
        .result-win { color: var(--accent-gold); text-shadow: 0 0 30px var(--accent-gold); }
        .result-lose { color: var(--accent-red); text-shadow: 0 0 30px var(--accent-red); }
        @keyframes resultText { from { opacity: 0; transform: scale(2); } to { opacity: 1; transform: scale(1); } }

        body.targeting .card { border-style: dashed; }
        .valid-target { animation: pulse 0.8s infinite; border-color: var(--accent-red) !important; box-shadow: 0 0 20px var(--accent-red); }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

    </style>
</head>
<body>

    <div id="home-screen" class="screen">
        <h1 class="game-title">INORGANIC<br>CARD GAME</h1>
        <div class="menu-btn" onclick="showDeckSelect()">CPU BATTLE</div>
        <div class="menu-btn disabled">PvP BATTLE (Coming Soon)</div>
        <div class="menu-btn disabled">CARD LIBRARY (Coming Soon)</div>
    </div>

    <div id="deck-select-screen" class="screen hidden">
        <h2>SELECT YOUR DECK</h2>
        <div class="deck-grid">
            </div>
        <div class="menu-btn" style="margin-top: 20px; padding: 10px 30px;" onclick="showHome()">BACK</div>
    </div>

    <div id="game-board" class="hidden">
        <div id="enemy-hand-area"></div>
        <div id="enemy-field" class="area"></div>
        <div id="info-area">
            <div class="leader" id="leader-enemy" onclick="onLeaderClick('enemy')">
                <div class="avatar" style="font-size:24px">ü§ñ</div>
                <div class="leader-name" id="enemy-name">CPU</div>
                <div id="enemy-hp" class="hp-circle">25</div>
            </div>
            <div class="turn-info">
                <div id="turn-display">TURN 1</div>
                <div id="mp-display" class="mp-bar">MP 1/1</div>
            </div>
            <button id="btn-end-turn" onclick="endTurn()">TURN END</button>
            <div class="leader" id="leader-player" onclick="onLeaderClick('player')">
                <div id="player-hp" class="hp-circle">25</div>
                <div class="leader-name">YOU</div>
                <div class="avatar" style="font-size:24px">üßë‚Äçüî¨</div>
            </div>
        </div>
        
        <div id="craftable-list"></div>

        <div id="player-field" class="area"></div>
        <div id="player-hand-area"></div>

        <div id="cancel-attack-btn" onclick="cancelAttack()">‚ùå ATTACK CANCEL</div>
    </div>

    <div id="card-detail-panel" onclick="hideDetail()">
        <div class="detail-close">√ó</div>
        <div class="detail-header">
            <div class="detail-symbol" id="detail-symbol"></div>
            <div class="detail-name" id="detail-name"></div>
            <div class="detail-rarity" id="detail-rarity"></div>
        </div>
        <div class="detail-stats-box" id="detail-stats"></div>
        <div class="detail-skills" id="detail-skills"></div>
        <div style="text-align:center; margin-top:15px; font-size:10px; color:var(--text-secondary);">(TAP TO CLOSE)</div>
    </div>

    <div class="action-overlay hidden" id="action-btns">
        <button class="game-btn btn-draw" onclick="actionDraw()">Ôºã DRAW (1MP)</button>
        <button class="game-btn btn-syn" onclick="actionSynthesize()">‚öóÔ∏è SYNTHESIZE</button>
    </div>

    <div id="skill-modal" class="screen hidden" style="background:rgba(0,0,0,0.9); z-index: 5000;">
        <h3 style="color:var(--accent-blue);">SELECT SKILL</h3>
        <div id="skill-list" style="display:flex; flex-direction:column; gap:15px; width:80%;"></div>
        <button class="menu-btn" style="margin-top:30px; border-color:var(--text-secondary); color:var(--text-secondary);" onclick="closeSkillModal()">CANCEL</button>
    </div>

    <div id="result-screen" class="screen hidden">
        <div class="result-title" id="result-title"></div>
        <div class="menu-btn" onclick="showHome()">RETURN TO TITLE</div>
    </div>

    <div id="msg-box"></div>

    <script>
        const MAX_HAND = 10; 
        const MAX_FIELD = 5;
        const INITIAL_HP = 25;

        // --- „Éá„Éº„ÇøÂÆöÁæ© ---
        const ELEM = {
            H: { symbol: 'H', name: 'Ê∞¥Á¥†', rarity: 'N', artClass: 'art-gas' },
            He: { symbol: 'He', name: '„Éò„É™„Ç¶„É†', rarity: 'SR', artClass: 'art-gas' },
            Li: { symbol: 'Li', name: '„É™„ÉÅ„Ç¶„É†', rarity: 'R', artClass: 'art-metal' },
            Be: { symbol: 'Be', name: '„Éô„É™„É™„Ç¶„É†', rarity: 'R', artClass: 'art-metal' },
            B: { symbol: 'B', name: '„Éõ„Ç¶Á¥†', rarity: 'R', artClass: 'art-solid' },
            C: { symbol: 'C', name: 'ÁÇ≠Á¥†', rarity: 'N', artClass: 'art-solid' },
            N: { symbol: 'N', name: 'Á™íÁ¥†', rarity: 'N', artClass: 'art-gas' },
            O: { symbol: 'O', name: 'ÈÖ∏Á¥†', rarity: 'N', artClass: 'art-gas' },
            F: { symbol: 'F', name: '„Éï„ÉÉÁ¥†', rarity: 'SR', artClass: 'art-toxic' },
            Ne: { symbol: 'Ne', name: '„Éç„Ç™„É≥', rarity: 'SR', artClass: 'art-gas' },
            Na: { symbol: 'Na', name: '„Éä„Éà„É™„Ç¶„É†', rarity: 'N', artClass: 'art-metal' },
            Mg: { symbol: 'Mg', name: '„Éû„Ç∞„Éç„Ç∑„Ç¶„É†', rarity: 'R', artClass: 'art-metal' },
            Al: { symbol: 'Al', name: '„Ç¢„É´„Éü„Éã„Ç¶„É†', rarity: 'R', artClass: 'art-metal' },
            Si: { symbol: 'Si', name: '„Ç±„Ç§Á¥†', rarity: 'R', artClass: 'art-solid' },
            P: { symbol: 'P', name: '„É™„É≥', rarity: 'R', artClass: 'art-solid' },
            S: { symbol: 'S', name: 'Á°´ÈªÑ', rarity: 'R', artClass: 'art-solid' },
            Cl: { symbol: 'Cl', name: 'Â°©Á¥†', rarity: 'N', artClass: 'art-toxic' },
            Ar: { symbol: 'Ar', name: '„Ç¢„É´„Ç¥„É≥', rarity: 'SR', artClass: 'art-gas' },
            K: { symbol: 'K', name: '„Ç´„É™„Ç¶„É†', rarity: 'N', artClass: 'art-metal' },
            Ca: { symbol: 'Ca', name: '„Ç´„É´„Ç∑„Ç¶„É†', rarity: 'R', artClass: 'art-metal' },
            Ti: { symbol: 'Ti', name: '„ÉÅ„Çø„É≥', rarity: 'SR', artClass: 'art-metal' },
            Cr: { symbol: 'Cr', name: '„ÇØ„É≠„É†', rarity: 'SR', artClass: 'art-metal' },
            Mn: { symbol: 'Mn', name: '„Éû„É≥„Ç¨„É≥', rarity: 'R', artClass: 'art-metal' },
            Fe: { symbol: 'Fe', name: 'ÈâÑ', rarity: 'N', artClass: 'art-metal' },
            Cu: { symbol: 'Cu', name: 'ÈäÖ', rarity: 'N', artClass: 'art-metal' },
            Zn: { symbol: 'Zn', name: '‰∫úÈâõ', rarity: 'R', artClass: 'art-metal' },
            Ag: { symbol: 'Ag', name: 'ÈäÄ', rarity: 'SR', artClass: 'art-metal' },
            Cd: { symbol: 'Cd', name: '„Ç´„Éâ„Éü„Ç¶„É†', rarity: 'R', artClass: 'art-toxic' },
            W:  { symbol: 'W', name: '„Çø„É≥„Ç∞„Çπ„ÉÜ„É≥', rarity: 'SSR', artClass: 'art-metal' },
            Pt: { symbol: 'Pt', name: '„Éó„É©„ÉÅ„Éä', rarity: 'SSR', artClass: 'art-metal' },
            Au: { symbol: 'Au', name: 'Èáë', rarity: 'SSR', artClass: 'art-metal' },
            Hg: { symbol: 'Hg', name: 'Ê∞¥ÈäÄ', rarity: 'SR', artClass: 'art-toxic' }
        };

        const RECIPES = [
            { ingredients: ['H', 'Cl'], product: { symbol: 'HCl', name: 'Â°©ÂåñÊ∞¥Á¥†', rarity:'R', atk: 5, hp: 1, artClass:'art-toxic', skills: [{name:'Âº∑ÈÖ∏ËÖêÈ£ü', power:5, desc:'È´òÁÅ´Âäõ„ÅÆÈÖ∏ÊîªÊíÉ'}] }},
            { ingredients: ['H', 'F'], product: { symbol: 'HF', name: '„Éï„ÉÉÂåñÊ∞¥Á¥†', rarity:'SR', atk: 4, hp: 2, ability:'toxic', artClass:'art-toxic', skills: [{name:'„Ç¨„É©„ÇπËÖêÈ£ü', power:4, desc:'ÈÄöÂ∏∏ÊîªÊíÉ'}, {name:'ÁåõÊØí', power:0, type:'toxic', desc:'Ëß¶„Çå„Çã„Å®Âç±Èô∫(ÂøÖÊÆ∫)'}] }},
            { ingredients: ['Na', 'H'], product: { symbol: 'NaH', name: 'Ê∞¥Á¥†ÂåñNa', rarity:'R', atk: 3, hp: 1, ability:'storm', artClass:'art-solid', skills: [{name:'ÈÇÑÂÖÉ‰ΩúÁî®', power:3, desc:'ÁñæËµ∞:Âç≥ÊîªÊíÉÂèØËÉΩ'}] }},
            { ingredients: ['H', 'H', 'O'], product: { symbol: 'H2O', name: 'Ê∞¥', rarity:'N', atk: 1, hp: 4, artClass:'art-liquid', skills: [{name:'Ê∞¥ÊµÅ', power:1, desc:'ÊîªÊíÉ'}, {name:'Âä†Ê∞¥ÂàÜËß£', power:3, type:'heal', desc:'„É™„Éº„ÉÄ„Éº„Çí3ÂõûÂæ©'}] }},
            { ingredients: ['Ag', 'Cl'], product: { symbol: 'AgCl', name: 'Â°©ÂåñÈäÄ', rarity:'SR', atk: 1, hp: 6, ability:'ward', artClass:'art-solid', skills: [{name:'ÊÑüÂÖâ', power:1, desc:'ÊîªÊíÉ'}, {name:'ÁôΩËâ≤Ê≤àÊÆø', power:0, type:'guard', desc:'ÂÆàË≠∑:Â£Å„Å´„Å™„Çã'}] }},
            { ingredients: ['Fe', 'O'], product: { symbol: 'FeO', name: 'ÈÖ∏ÂåñÈâÑ(II)', rarity:'N', atk: 3, hp: 5, artClass:'art-solid', skills: [{name:'ÈªíÈåÜ', power:3, desc:'ÈÄöÂ∏∏ÊîªÊíÉ'}] }},
            { ingredients: ['Fe', 'O', 'O'], product: { symbol: 'Fe2O3', name: 'Ëµ§ÈåÜ(‰∏çÂãïÊÖã)', rarity:'R', atk: 2, hp: 8, ability:'ward', artClass:'art-solid', skills: [{name:'‰∏çÂãïÊÖãÁöÆËÜú', power:2, desc:'È´ò„ÅÑÈò≤Âæ°Âäõ„ÅßÂÆà„Çã'}] }},
            { ingredients: ['Cu', 'O'], product: { symbol: 'CuO', name: 'ÈÖ∏ÂåñÈäÖ(II)', rarity:'N', atk: 3, hp: 4, artClass:'art-solid', skills: [{name:'ÈªíËâ≤Á≤âÊú´', power:3, desc:'ÈÄöÂ∏∏ÊîªÊíÉ'}] }},
            { ingredients: ['Zn', 'Cu'], product: { symbol: 'Brass', name: 'ÈªÑÈäÖ', rarity:'R', atk: 4, hp: 5, artClass:'art-metal', skills: [{name:'ÂêàÈáë„Ç¢„Çø„ÉÉ„ÇØ', power:4, desc:'ÂÆâÂÆö„Åó„ÅüÂº∑„Åï'}] }},
            { ingredients: ['Hg', 'Zn'], product: { symbol: 'Amalgam', name: '‰∫úÈâõ„Ç¢„Éû„É´„Ç¨„É†', rarity:'SR', atk: 3, hp: 6, ability:'ward', artClass:'art-metal', skills: [{name:'„Ç¢„Éû„É´„Ç¨„É†Âåñ', power:3, desc:'ÂÆàË≠∑„ÇíÊåÅ„Å§ÂêàÈáë'}] }},
            { ingredients: ['C', 'O'], product: { symbol: 'CO', name: '‰∏ÄÈÖ∏ÂåñÁÇ≠Á¥†', rarity:'R', atk: 1, hp: 2, ability:'toxic', artClass:'art-gas', skills: [{name:'‰∏çÂÆåÂÖ®ÁáÉÁÑº', power:1, desc:'ÊîªÊíÉ'}, {name:'„Éò„É¢„Ç∞„É≠„Éì„É≥ÁµêÂêà', power:0, type:'toxic', desc:'ÂøÖÊÆ∫:Âç≥Ê≠ª„Åï„Åõ„Çã'}] }},
            { ingredients: ['H', 'S'], product: { symbol: 'H2S', name: 'Á°´ÂåñÊ∞¥Á¥†', rarity:'R', atk: 2, hp: 3, ability:'toxic', artClass:'art-gas', skills: [{name:'ËÖêÂçµËá≠', power:2, desc:'ÊîªÊíÉ'}, {name:'Á°´Âåñ', power:0, type:'toxic', desc:'ÂøÖÊÆ∫ÊîªÊíÉ'}] }},
            { ingredients: ['Cl', 'Cl'], product: { symbol: 'Cl2', name: 'Â°©Á¥†„Ç¨„Çπ', rarity:'R', atk: 3, hp: 3, artClass:'art-gas', skills: [{name:'ÈÖ∏Âåñ‰ΩúÁî®', power:3, desc:'ÊîªÊíÉ'}, {name:'ÊØí„Ç¨„ÇπÊï£Â∏É', power:2, type:'aoe', desc:'ÊïµÂÖ®‰Ωì„Å´2„ÉÄ„É°„Éº„Ç∏'}] }},
            { ingredients: ['S', 'O', 'O'], product: { symbol: 'SO2', name: '‰∫åÈÖ∏ÂåñÁ°´ÈªÑ', rarity:'N', atk: 2, hp: 4, artClass:'art-gas', skills: [{name:'ÊºÇÁôΩ', power:2, desc:'ÊîªÊíÉ'}, {name:'ÈÖ∏ÊÄßÈõ®', power:1, type:'aoe', desc:'ÊïµÂÖ®‰Ωì„Å´1„ÉÄ„É°„Éº„Ç∏'}] }},
            { ingredients: ['Cd', 'S'], product: { symbol: 'CdS', name: 'Á°´Âåñ„Ç´„Éâ„Éü„Ç¶„É†', rarity:'SR', atk: 2, hp: 5, ability:'toxic', artClass:'art-toxic', skills: [{name:'„Ç§„Çø„Ç§„Ç§„Çø„Ç§', power:0, type:'toxic', desc:'ÁåõÊØí:Ëß¶„Çå„Çã„Å®Âç≥Ê≠ª'}] }},
            { ingredients: ['Na', 'O', 'H'], product: { symbol: 'NaOH', name: 'Ê∞¥ÈÖ∏ÂåñNa', rarity:'R', atk: 3, hp: 3, artClass:'art-solid', skills: [{name:'ÊΩÆËß£', power:3, desc:'ÊîªÊíÉ'}, {name:'‰∏≠ÂíåÁÜ±', power:2, type:'aoe_heal', desc:'ÊïµÂÖ®‰Ωì2„ÉÄ„É°/Ëá™ÂàÜ2ÂõûÂæ©'}] }},
            { ingredients: ['Al', 'O', 'O'], product: { symbol: 'Al2O3', name: '„Ç¢„É´„Éü„Éä', rarity:'R', atk: 2, hp: 7, ability:'ward', artClass:'art-solid', skills: [{name:'„Ç¢„É´„Éû„Ç§„Éà', power:2, desc:'ÈÖ∏ÂåñË¢´ËÜú„Éê„É™„Ç¢'}] }},
            { ingredients: ['Cl', 'Na'], product: { symbol: 'NaCl', name: 'Â°©ÂåñNa', rarity:'N', atk: 3, hp: 4, artClass:'art-solid', skills: [{name:'Â°©Âë≥', power:3, desc:'ÈÄöÂ∏∏ÊîªÊíÉ'}] }},
            { ingredients: ['Ca', 'O', 'H', 'H'], product: { symbol: 'Ca(OH)2', name: 'Ê∂àÁü≥ÁÅ∞', rarity:'N', atk: 1, hp: 6, ability:'ward', artClass:'art-solid', skills: [{name:'Áü≥ÁÅ∞Ê∞¥', power:1, desc:'ÊîªÊíÉ'}, {name:'‰∏≠ÂíåÂèçÂøú', power:4, type:'heal', desc:'HP4ÂõûÂæ©'}] }},
            { ingredients: ['C', 'C', 'C'], product: { symbol: 'Diamond', name: '„ÉÄ„Ç§„É§„É¢„É≥„Éâ', rarity:'SSR', atk: 4, hp: 10, ability:'ward', artClass:'art-solid', skills: [{name:'„É¢„Éº„ÇπÁ°¨Â∫¶10', power:4, desc:'ÊúÄÂº∑„ÅÆÁ°¨Â∫¶'}] }},
            { ingredients: ['Al', 'O', 'O', 'Cr'], product: { symbol: 'Ruby', name: '„É´„Éì„Éº', rarity:'SR', atk: 5, hp: 8, artClass:'art-solid', skills: [{name:'Ê∑±Á¥Ö„ÅÆËºù„Åç', power:5, desc:'È´ò„Çπ„ÉÜ„Éº„Çø„Çπ'}] }},
            { ingredients: ['Al', 'O', 'Ti'], product: { symbol: 'Sapphire', name: '„Çµ„Éï„Ç°„Ç§„Ç¢', rarity:'SR', atk: 4, hp: 9, artClass:'art-solid', skills: [{name:'ÈùíÁéâ', power:4, desc:'È´òËÄê‰πÖ'}] }},
            { ingredients: ['Si', 'O', 'O'], product: { symbol: 'SiO2', name: 'Áü≥Ëã±(Ê∞¥Êô∂)', rarity:'N', atk: 3, hp: 6, artClass:'art-solid', skills: [{name:'ÂúßÈõªÂäπÊûú', power:3, desc:'ÊîªÊíÉ'}, {name:'ÁµêÊô∂Âåñ', power:2, type:'aoe', desc:'ÂÖ®‰Ωì2„ÉÄ„É°„Éº„Ç∏'}] }},
            { ingredients: ['Au'], product: { symbol: 'Au', name: 'Èáë', rarity:'SSR', atk: 6, hp: 6, artClass:'art-metal', skills: [{name:'‰∏çÂ§â„ÅÆËºù„Åç', power:6, desc:'ÁéãÊ∞¥‰ª•Â§ñÁÑ°Êïµ„ÅÆÊîªÊíÉ'}] }},
            { ingredients: ['Pt'], product: { symbol: 'Pt', name: '„Éó„É©„ÉÅ„Éä', rarity:'SSR', atk: 5, hp: 7, artClass:'art-metal', skills: [{name:'Ëß¶Â™í‰ΩúÁî®', power:5, desc:'ÂèçÂøú„Çí‰øÉÈÄ≤„Åô„Çã‰∏ÄÊíÉ'}] }},
            { ingredients: ['W'], product: { symbol: 'W', name: '„Çø„É≥„Ç∞„Çπ„ÉÜ„É≥', rarity:'SSR', atk: 7, hp: 8, ability:'ward', artClass:'art-metal', skills: [{name:'ËûçÁÇπ3422‚ÑÉ', power:7, desc:'ÁÜ±„Å´Âº∑„ÅÑ‰∏ÄÊíÉ'}] }},
            { ingredients: ['Ti'], product: { symbol: 'Ti', name: '„ÉÅ„Çø„É≥', rarity:'SR', atk: 4, hp: 5, artClass:'art-metal', skills: [{name:'È´òÂº∑Â∫¶', power:4, desc:'ËªΩ„Åè„Å¶Âº∑„ÅÑ'}] }},
            { ingredients: ['He', 'He'], product: { symbol: 'He', name: '„Éò„É™„Ç¶„É†', rarity:'SR', atk: 2, hp: 2, ability:'stealth', artClass:'art-gas', skills: [{name:'‰∏çÊ¥ªÊÄß', power:2, desc:'ÊΩú‰ºèÊîªÊíÉ'}] }},
            { ingredients: ['Ne', 'Ne'], product: { symbol: 'Ne', name: '„Éç„Ç™„É≥', rarity:'SR', atk: 3, hp: 3, ability:'stealth', artClass:'art-gas', skills: [{name:'„Éç„Ç™„É≥„Çµ„Ç§„É≥', power:3, desc:'ÊΩú‰ºèÊîªÊíÉ'}] }},
            { ingredients: ['Ar', 'Ar'], product: { symbol: 'Ar', name: '„Ç¢„É´„Ç¥„É≥', rarity:'SR', atk: 4, hp: 4, ability:'stealth', artClass:'art-gas', skills: [{name:'„Éï„Ç£„É©„É°„É≥„Éà‰øùË≠∑', power:4, desc:'ÊΩú‰ºèÊîªÊíÉ'}] }},
            { ingredients: ['H', 'Cl', 'N', 'O', 'O', 'O'], product: { symbol: 'AquaRegia', name: 'ÁéãÊ∞¥', rarity:'SSR', atk: 0, hp: 0, type:'spell', artClass:'art-liquid', skills: [{name:'ÈáëÊ∫∂„Åã„Åó', power:99, type:'toxic', desc:'Âçò‰ΩìÁ¢∫ÂÆöÈô§Âéª'}] }},
            { ingredients: ['H', 'H', 'S', 'O', 'O', 'O', 'O'], product: { symbol: 'H2SO4', name: 'ÊøÉÁ°´ÈÖ∏', rarity:'SR', atk: 0, hp: 0, type:'spell', artClass:'art-liquid', skills: [{name:'ËÑ±Ê∞¥‰ΩúÁî®', power:5, type:'aoe', desc:'ÊïµÂÖ®‰Ωì5„ÉÄ„É°„Éº„Ç∏'}] }},
            { ingredients: ['K', 'Mn', 'O', 'O', 'O', 'O'], product: { symbol: 'KMnO4', name: 'ÈÅé„Éû„É≥„Ç¨„É≥ÈÖ∏K', rarity:'SR', atk: 0, hp: 0, type:'spell', artClass:'art-solid', skills: [{name:'Âº∑ÂäõÈÖ∏Âåñ', power:7, type:'damage', desc:'Âçò‰Ωì7„ÉÄ„É°„Éº„Ç∏'}] }},
        ];

        const DECKS = {
            aggro: { name: 'Ë∂ÖÈÄüÊîª (Aggro)', desc: 'HCl, HF„Å™„Å©‰Ωé„Ç≥„Çπ„ÉàÈ´òÁÅ´Âäõ„ÅßÈÄüÊîª„Çí‰ªïÊéõ„Åë„Çã„Éá„ÉÉ„Ç≠„ÄÇ', elements: ['H', 'H', 'Cl', 'F', 'Na', 'O'], recipes: ['HCl', 'HF', 'NaH', 'H2O'] },
            counter: { name: '„Ç´„Ç¶„É≥„Çø„Éº (Counter)', desc: 'AgCl„ÅÆÂÆàË≠∑„ÇÑFe2O3„ÅÆÈ´òËÄê‰πÖ„ÅßËÄê„Åà„Å¶ÂèçÊíÉ„Åô„Çã„Éá„ÉÉ„Ç≠„ÄÇ', elements: ['Ag', 'Cl', 'Fe', 'O', 'Cu', 'Zn', 'Hg'], recipes: ['AgCl', 'FeO', 'Fe2O3', 'Brass', 'Amalgam', 'CuO'] },
            toxic: { name: 'ÂÆ≥ÊÇ™ÊØí (Toxic)', desc: 'CO, H2S„Å™„Å©„ÅÆ„ÄåÂøÖÊÆ∫„ÄçÊåÅ„Å°„ÅßÂ§ßÂûã„É¶„Éã„ÉÉ„Éà„ÇíËë¨„Çã„Éá„ÉÉ„Ç≠„ÄÇ', elements: ['C', 'O', 'S', 'H', 'Cl', 'Cd'], recipes: ['CO', 'H2S', 'Cl2', 'SO2', 'CdS'] },
            control: { name: '„Ç≥„É≥„Éà„É≠„Éº„É´ (Control)', desc: 'NaOH„ÇÑAl2O3„ÅßÂõûÂæ©„ÇÑÈò≤Âæ°„ÇíË°å„ÅÑ„ÄÅÁõ§Èù¢„ÇíÊîØÈÖç„Åô„Çã„Éá„ÉÉ„Ç≠„ÄÇ', elements: ['Al', 'O', 'H', 'Na', 'Cl', 'Ca'], recipes: ['Al2O3', 'NaOH', 'H2O', 'NaCl', 'Ca(OH)2'] },
            gemstone: { name: 'ÂÆùÁü≥ (Gemstone)', desc: '„ÉÄ„Ç§„É§„É¢„É≥„Éâ„ÇÑ„É´„Éì„Éº„Å™„Å©„ÄÅÂúßÂÄíÁöÑ„Å™„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÊåÅ„Å§„Éá„ÉÉ„Ç≠„ÄÇ', elements: ['C', 'Al', 'O', 'Si', 'Cr', 'Ti'], recipes: ['Diamond', 'Ruby', 'Sapphire', 'SiO2'] },
            heavy: { name: 'ÈáçÈáëÂ±û (Heavy Metal)', desc: 'Èáë„ÄÅ„Éó„É©„ÉÅ„Éä„Å™„Å©„ÄÅ„Ç≥„Çπ„Éà„ÅØÈáç„ÅÑ„ÅåÂº∑Âäõ„Å™ÈáëÂ±û„Éá„ÉÉ„Ç≠„ÄÇ', elements: ['Au', 'Pt', 'W', 'Ti', 'Fe'], recipes: ['Au', 'Pt', 'W', 'Ti'] },
            noble: { name: 'Ë≤¥„Ç¨„Çπ (Noble Gas)', desc: '„Éò„É™„Ç¶„É†„Å™„Å©„ÄÅ„ÄåÊΩú‰ºè„ÄçËÉΩÂäõ„ÅßÈÅ∏„Å∞„Çå„Å™„ÅÑÊîªÊíÉ„ÇíË°å„ÅÜ„Éá„ÉÉ„Ç≠„ÄÇ', elements: ['He', 'He', 'Ne', 'Ne', 'Ar', 'Ar'], recipes: ['He', 'Ne', 'Ar'] },
            hazard: { name: 'Âç±Èô∫Áâ© (Hazard)', desc: 'ÁéãÊ∞¥„ÇÑÊøÉÁ°´ÈÖ∏„Å™„Å©„ÄÅÂº∑Âäõ„Å™Èô§Âéª„Çπ„Éö„É´„Çí‰∏ª‰Ωì„Å®„Åó„Åü„Éá„ÉÉ„Ç≠„ÄÇ', elements: ['H', 'Cl', 'N', 'O', 'S', 'K', 'Mn'], recipes: ['AquaRegia', 'H2SO4', 'KMnO4'] }
        };

        let gs = {
            playerDeck: null, enemyDeck: null,
            playerPool: [], enemyPool: [],
            playerRecipes: [], enemyRecipes: [],
            turn: 1, isPlayerTurn: true, mp: 1, maxMp: 1,
            player: { hp: INITIAL_HP, hand: [], field: [] },
            enemy: { hp: INITIAL_HP, hand: [], field: [], mp: 1, maxMp: 1 },
            selectedHandIds: [], attackingUnit: null,
        };

        // --- ÂàùÊúüÂåñ ---
        window.onload = () => {
            generateDeckSelectScreen();
            showHome();
        };

        function generateDeckSelectScreen() {
            const grid = document.querySelector('#deck-select-screen .deck-grid');
            Object.keys(DECKS).forEach(key => {
                const deck = DECKS[key];
                const div = document.createElement('div');
                div.className = 'deck-card';
                div.innerHTML = `<div class="deck-title">${deck.name}</div><div class="deck-desc">${deck.desc}</div>`;
                div.onclick = () => startGame(key);
                grid.appendChild(div);
            });
        }

        // --- ÁîªÈù¢ÈÅ∑Áßª ---
        function showHome() { hideAllScreens(); document.getElementById('home-screen').classList.remove('hidden'); }
        function showDeckSelect() { hideAllScreens(); document.getElementById('deck-select-screen').classList.remove('hidden'); }
        function showGame() { 
            hideAllScreens(); 
            document.getElementById('game-board').classList.remove('hidden'); 
            document.getElementById('action-btns').classList.remove('hidden');
        }
        function showResult(isWin) {
            const screen = document.getElementById('result-screen');
            const title = document.getElementById('result-title');
            screen.classList.remove('hidden');
            title.innerText = isWin ? "YOU WIN!" : "YOU LOSE...";
            title.className = 'result-title ' + (isWin ? 'result-win' : 'result-lose');
        }
        function hideAllScreens() {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById('game-board').classList.add('hidden');
            document.getElementById('action-btns').classList.add('hidden');
        }

        /* --- „Ç≤„Éº„É†ÈñãÂßã --- */
        function startGame(playerDeckKey) {
            resetGame(playerDeckKey);
            showGame();
            showMessage("BATTLE START!", 2000);
            updateView();
        }

        function resetGame(playerDeckKey) {
             const pConf = DECKS[playerDeckKey];
            gs.playerPool = pConf.elements.map(sym => ELEM[sym]);
            gs.playerRecipes = RECIPES.filter(r => pConf.recipes.includes(r.product.symbol));

            const keys = Object.keys(DECKS);
            const cpuKey = keys[Math.floor(Math.random() * keys.length)];
            const eConf = DECKS[cpuKey];
            gs.enemyPool = eConf.elements.map(sym => ELEM[sym]);
            gs.enemyRecipes = RECIPES.filter(r => eConf.recipes.includes(r.product.symbol));
            
            document.getElementById('enemy-name').innerText = `CPU (${eConf.name.split(' ')[0]})`;

            gs.turn = 1; gs.isPlayerTurn = true; gs.mp = 1; gs.maxMp = 1;
            gs.player = { hp: INITIAL_HP, hand: [], field: [] };
            gs.enemy = { hp: INITIAL_HP, hand: [], field: [], mp: 1, maxMp: 1 };
            gs.selectedHandIds = []; gs.attackingUnit = null;

            for(let i=0; i<5; i++) { drawCard(gs.player); drawCard(gs.enemy); }
            document.getElementById('btn-end-turn').disabled = false;
        }

        /* --- „Ç≤„Éº„É†„É≠„Ç∏„ÉÉ„ÇØ --- */
        function drawCard(target) {
            const pool = (target === gs.enemy) ? gs.enemyPool : gs.playerPool;
            if (target.hand.length >= MAX_HAND) {
                if(target === gs.enemy) target.hand.shift();
                else return null; 
            }
            const base = pool[Math.floor(Math.random() * pool.length)];
            const card = { ...base, id: Math.random().toString(36).substr(2, 9), type: 'element' };
            target.hand.push(card);
            return card;
        }

        function actionDraw() {
            if(!gs.isPlayerTurn || gs.mp < 1) { showMessage("MP‰∏çË∂≥"); return; }
            gs.mp--;
            drawCard(gs.player);
            updateView();
        }

        function actionSynthesize() {
            if(!gs.isPlayerTurn) return;
            if(gs.selectedHandIds.length === 0) return;

            if(gs.selectedHandIds.length === 1) {
                const card = gs.player.hand.find(c => c.id === gs.selectedHandIds[0]);
                const singleRecipe = gs.playerRecipes.find(r => r.ingredients.length === 1 && r.ingredients[0] === card.symbol);
                if(singleRecipe) { processSynth(singleRecipe); return; }
            }

            const selCards = gs.player.hand.filter(c => gs.selectedHandIds.includes(c.id));
            const symbols = selCards.map(c => c.symbol).sort();
            const recipe = gs.playerRecipes.find(r => JSON.stringify(r.ingredients.sort()) === JSON.stringify(symbols));

            if(recipe) processSynth(recipe);
            else { showMessage("ÂèçÂøú„Åó„Åæ„Åõ„Çì"); gs.selectedHandIds = []; updateView(); }
        }

        function processSynth(recipe) {
            // „Çπ„Éö„É´
            if(recipe.product.type === 'spell') {
                const skill = recipe.product.skills[0];
                gs.player.hand = gs.player.hand.filter(c => !gs.selectedHandIds.includes(c.id));
                gs.selectedHandIds = [];
                if(gs.enemy.field.length > 0) {
                    const target = gs.enemy.field.reduce((a,b)=>a.currentHp>b.currentHp?a:b);
                    showMessage(`${skill.name} -> ${target.name}!`);
                    if(skill.type === 'toxic') target.currentHp = -99;
                    else target.currentHp -= skill.power;
                } else {
                    showMessage(`${skill.name} -> „É™„Éº„ÉÄ„Éº!`);
                    gs.enemy.hp -= skill.power;
                }
                checkGameEnd(); updateView(); return;
            }

            // „É¶„Éã„ÉÉ„Éà
            if(gs.player.field.length >= MAX_FIELD) { showMessage("„Éï„Ç£„Éº„É´„ÉâÊ∫ÄÂì°"); return; }
            gs.player.hand = gs.player.hand.filter(c => !gs.selectedHandIds.includes(c.id));
            gs.selectedHandIds = [];
            const unit = { ...recipe.product, id: Math.random().toString(36).substr(2, 9), maxHp: recipe.product.hp, currentHp: recipe.product.hp, canAttack: recipe.product.ability === 'storm', type: 'unit' };
            gs.player.field.push(unit);
            showMessage(`Âè¨Âñö: ${unit.name}`);
            updateView();
        }

        /* --- „Ç§„É≥„Çø„É©„ÇØ„Ç∑„Éß„É≥ --- */
        function onHandClick(id) {
            if(!gs.isPlayerTurn) return;
            // Ë©≥Á¥∞Ë°®Á§∫
            const card = gs.player.hand.find(c => c.id === id);
            if(card) showDetail(card);

            // ÈÅ∏Êäû
            if(gs.selectedHandIds.includes(id)) gs.selectedHandIds = gs.selectedHandIds.filter(x => x !== id);
            else gs.selectedHandIds.push(id);
            updateView();
        }

        function onFieldCardClick(id, isPlayer) {
            if(!gs.isPlayerTurn) return;
            if(isPlayer) {
                const u = gs.player.field.find(x => x.id === id);
                if(u) showDetail(u);
                if(u && u.canAttack) {
                    gs.attackingUnit = u;
                    document.body.classList.add('targeting');
                    updateView(); // „Åì„Åì„Åß„Ç≠„É£„É≥„Çª„É´„Éú„Çø„É≥„ÅåË°®Á§∫„Åï„Çå„Çã
                }
            } else if(gs.attackingUnit) {
                const target = gs.enemy.field.find(x => x.id === id);
                if(target) showDetail(target);
                if(target.ability === 'stealth') { showMessage("ÊΩú‰ºè‰∏≠ÔºÅ"); return; }
                prepareAttack(gs.attackingUnit, target, 'unit');
            } else {
                const target = gs.enemy.field.find(x => x.id === id);
                if(target) showDetail(target);
            }
        }

        function onLeaderClick(side) {
            if(!gs.isPlayerTurn || side !== 'enemy' || !gs.attackingUnit) return;
            prepareAttack(gs.attackingUnit, 'leader', 'leader');
        }

        function prepareAttack(attacker, target, type) {
            if(type === 'leader' || (type === 'unit' && target.ability !== 'ward')) {
                const guards = gs.enemy.field.filter(u => u.ability === 'ward' && u.ability !== 'stealth');
                if(guards.length > 0) { showMessage("ÂÆàË≠∑„Å´Èòª„Åæ„Çå„ÅüÔºÅ"); return; }
            }
            if(attacker.skills.length > 1) openSkillModal(attacker, target);
            else executeSkill(attacker, target, attacker.skills[0]);
        }

        function openSkillModal(attacker, target) {
            const modal = document.getElementById('skill-modal');
            const list = document.getElementById('skill-list');
            list.innerHTML = '';
            attacker.skills.forEach(skill => {
                const btn = document.createElement('div');
                btn.className = 'menu-btn';
                btn.style.width = 'auto'; btn.style.margin = '0';
                let typeLabel = skill.type ? skill.type.toUpperCase() : 'NORMAL';
                btn.innerHTML = `<div class="skill-name">${skill.name} (Â®ÅÂäõ:${skill.power})</div><div class="skill-item-desc">${skill.desc}</div>`;
                btn.onclick = () => { executeSkill(attacker, target, skill); closeSkillModal(); };
                list.appendChild(btn);
            });
            modal.classList.remove('hidden');
        }
        function closeSkillModal() { document.getElementById('skill-modal').classList.add('hidden'); cancelAttack(); }

        function executeSkill(attacker, target, skill) {
            let log = `${attacker.name}„ÅÆÊîªÊíÉ!`;
            if(skill.type === 'aoe') {
                gs.enemy.field.forEach(u => u.currentHp -= skill.power); gs.enemy.hp -= skill.power;
            } else if(skill.type === 'aoe_heal') {
                gs.enemy.field.forEach(u => u.currentHp -= skill.power); gs.player.hp += skill.power;
            } else if(skill.type === 'heal') {
                gs.player.hp += skill.power;
            } else {
                const dmg = skill.power;
                if(target === 'leader') gs.enemy.hp -= dmg;
                else {
                    const counter = target.atk;
                    if(skill.type === 'toxic' && dmg > 0) target.currentHp = -99;
                    else target.currentHp -= dmg;
                    if(target.currentHp <= 0 && target.ability === 'toxic' && counter > 0) attacker.currentHp = -99;
                    else attacker.currentHp -= counter;
                }
            }
            attacker.canAttack = false; showMessage(log); cancelAttack(); checkGameEnd(); updateView();
        }

        // ‚òÖ „Ç≠„É£„É≥„Çª„É´Ê©üËÉΩ
        function cancelAttack() { 
            gs.attackingUnit = null; 
            document.body.classList.remove('targeting'); 
            updateView(); 
        }

        function checkGameEnd() {
            gs.player.field = gs.player.field.filter(u => u.currentHp > 0);
            gs.enemy.field = gs.enemy.field.filter(u => u.currentHp > 0);
            if(gs.enemy.hp <= 0) { showResult(true); return; }
            if(gs.player.hp <= 0) { showResult(false); return; }
            updateView();
        }

        function endTurn() {
            if(!gs.isPlayerTurn) return;
            gs.isPlayerTurn = false; cancelAttack(); document.getElementById('btn-end-turn').disabled = true;
            showMessage("ENEMY TURN"); setTimeout(cpuTurn, 1500);
        }

        async function cpuTurn() {
            if(gs.enemy.maxMp < 10) gs.enemy.maxMp++; gs.enemy.mp = gs.enemy.maxMp;
            drawCard(gs.enemy); updateView(); await sleep(1000);
            
            let acted = true;
            while(acted && gs.enemy.field.length < MAX_FIELD) {
                acted = false;
                const handSym = gs.enemy.hand.map(c => c.symbol);
                for(const r of gs.enemyRecipes) {
                    if(r.product.type === 'spell') continue;
                    const ingredients = [...r.ingredients];
                    const tempHand = [...handSym];
                    let possible = true;
                    for(const ing of ingredients) {
                        const idx = tempHand.indexOf(ing);
                        if(idx === -1) { possible = false; break; }
                        tempHand.splice(idx, 1);
                    }
                    if(possible) {
                        for(const ing of r.ingredients) {
                            const idx = gs.enemy.hand.findIndex(c => c.symbol === ing);
                            gs.enemy.hand.splice(idx, 1);
                        }
                        const unit = { ...r.product, id: Math.random(), maxHp: r.product.hp, currentHp: r.product.hp, canAttack:false, type:'unit'};
                        gs.enemy.field.push(unit);
                        showMessage(`CPUÂè¨Âñö: ${unit.name}`);
                        await sleep(1000); updateView(); acted = true; break;
                    }
                }
            }
            gs.enemy.field.forEach(u => u.canAttack = true);
            for(const u of gs.enemy.field) {
                if(!u.canAttack) continue;
                const guards = gs.player.field.filter(g => g.ability === 'ward' && g.ability !== 'stealth');
                let target = 'leader';
                if(guards.length > 0) target = guards[0];
                if(target === 'leader') {
                    gs.player.hp -= u.skills[0].power; showMessage(`CPUÊîªÊíÉ -> „É™„Éº„ÉÄ„Éº`);
                } else {
                    const dmg = u.skills[0].power;
                    const toxic = u.skills[0].type === 'toxic';
                    if(toxic && dmg > 0) target.currentHp = -99; else target.currentHp -= dmg;
                    u.currentHp -= target.atk; showMessage(`CPUÊîªÊíÉ -> ${target.name}`);
                }
                checkGameEnd(); updateView(); await sleep(1000);
            }
            startPlayerTurn();
        }

        function startPlayerTurn() {
            gs.turn++; if(gs.maxMp < 10) gs.maxMp++; gs.mp = gs.maxMp;
            gs.isPlayerTurn = true; document.getElementById('btn-end-turn').disabled = false;
            gs.player.field.forEach(u => u.canAttack = true);
            drawCard(gs.player); showMessage("YOUR TURN"); updateView();
        }
        const sleep = m => new Promise(r => setTimeout(r, m));

        /* --- „Éì„É•„Éº --- */
        function updateView() {
            document.getElementById('turn-display').innerText = `TURN ${gs.turn}`;
            document.getElementById('mp-display').innerText = `MP ${gs.mp}/${gs.maxMp}`;
            document.getElementById('player-hp').innerText = gs.player.hp;
            document.getElementById('enemy-hp').innerText = gs.enemy.hp;
            
            const cancelBtn = document.getElementById('cancel-attack-btn');
            if(gs.attackingUnit) cancelBtn.style.display = 'block';
            else cancelBtn.style.display = 'none';

            renderCards('player-hand-area', gs.player.hand, 'hand');
            renderCards('player-field', gs.player.field, 'field', true);
            renderCards('enemy-field', gs.enemy.field, 'field', false);
            
            const eh = document.getElementById('enemy-hand-area'); eh.innerHTML = '';
            gs.enemy.hand.forEach(() => { 
                const d = document.createElement('div'); 
                d.className = 'card'; d.style.background='linear-gradient(135deg, #2c3e50, #1a1a1d)'; 
                d.style.width='40px'; d.style.height='60px'; 
                d.style.border='2px solid #555';
                eh.appendChild(d); 
            });
            updateHint();
        }

        function showDetail(card) {
            const p = document.getElementById('card-detail-panel');
            p.classList.add('active');
            document.getElementById('detail-symbol').innerText = card.symbol;
            document.getElementById('detail-name').innerText = card.name;
            document.getElementById('detail-rarity').innerText = `${card.rarity} RANK`;
            const stats = document.getElementById('detail-stats');
            const skills = document.getElementById('detail-skills');
            skills.innerHTML = '';

            if(card.type === 'element') {
                stats.innerHTML = `<span style="font-size:14px; color:#ccc">MATERIAL CARD</span>`;
                skills.innerHTML = `<div class="skill-item"><div class="skill-item-desc">ÂêàÊàêÁ¥†Êùê„Å®„Åó„Å¶‰ΩøÁî®„Åó„Åæ„Åô„ÄÇ</div></div>`;
            } else {
                stats.innerHTML = `<span style="color:#e67e22">‚öîÔ∏è${card.atk}</span> <span style="color:#2ecc71; margin-left:20px;">‚ù§Ô∏è${card.currentHp}/${card.maxHp}</span>`;
                if(card.ability === 'ward') skills.innerHTML += `<div class="skill-item"><div class="skill-item-name">üõ°Ô∏è ÂÆàË≠∑ (WARD)</div><div class="skill-item-desc">Áõ∏Êâã„ÅØ„Åì„Çå‰ª•Â§ñ„ÇíÊîªÊíÉ„Åß„Åç„Å™„ÅÑ„ÄÇ</div></div>`;
                if(card.ability === 'toxic') skills.innerHTML += `<div class="skill-item"><div class="skill-item-name">‚ò†Ô∏è ÊØí (TOXIC)</div><div class="skill-item-desc">„ÉÄ„É°„Éº„Ç∏„Çí‰∏é„Åà„Åü„É¶„Éã„ÉÉ„Éà„ÇíÁ†¥Â£ä„Åô„Çã„ÄÇ</div></div>`;
                if(card.ability === 'storm') skills.innerHTML += `<div class="skill-item"><div class="skill-item-name">‚ö° ÁñæËµ∞ (STORM)</div><div class="skill-item-desc">Âè¨Âñö„Åó„Åü„Çø„Éº„É≥„Å´ÊîªÊíÉ„Åß„Åç„Çã„ÄÇ</div></div>`;
                if(card.ability === 'stealth') skills.innerHTML += `<div class="skill-item"><div class="skill-item-name">üëÅÔ∏è ÊΩú‰ºè (STEALTH)</div><div class="skill-item-desc">ÊîªÊíÉ„Åô„Çã„Åæ„ÅßÁõ∏Êâã„Å´ÈÅ∏„Å∞„Çå„Å™„ÅÑ„ÄÇ</div></div>`;
                card.skills.forEach(s => {
                    let type = s.type ? s.type : 'ÈÄöÂ∏∏';
                    skills.innerHTML += `<div class="skill-item"><div class="skill-item-name">${s.name} (Â®ÅÂäõ:${s.power})</div><div class="skill-item-desc">${s.desc} [${type}]</div></div>`;
                });
            }
        }
        function hideDetail() { document.getElementById('card-detail-panel').classList.remove('active'); }

        function renderCards(id, cards, type, isPlayer) {
            const el = document.getElementById(id); el.innerHTML = '';
            cards.forEach(c => {
                const div = document.createElement('div'); div.className = 'card';
                div.setAttribute('data-rarity', c.rarity);
                
                div.onclick = (e) => {
                    e.stopPropagation();
                    if(type === 'hand') onHandClick(c.id);
                    if(type === 'field') onFieldCardClick(c.id, isPlayer);
                };

                if(type === 'hand' && gs.selectedHandIds.includes(c.id)) div.classList.add('selected');
                if(type === 'field' && c.canAttack && isPlayer) div.classList.add('can-attack');
                if(type === 'field' && !isPlayer && gs.attackingUnit && c.ability !== 'stealth') {
                    const hasWard = gs.enemy.field.some(u => u.ability === 'ward' && u.ability !== 'stealth');
                    if(!hasWard || c.ability === 'ward') div.classList.add('valid-target');
                }
                
                let content = '';
                if(c.type === 'element') {
                    content = `<div class="card-art ${c.artClass}"><div class="art-placeholder">${c.symbol}</div></div><div class="card-info"><div class="card-symbol">${c.symbol}</div><div class="card-name">${c.name}</div></div>`;
                } else {
                    let badges = `<div class="ability-container">`;
                    if(c.ability === 'ward') badges += `<div class="badge badge-ward">üõ°Ô∏è</div>`;
                    if(c.ability === 'toxic') badges += `<div class="badge badge-toxic">‚ò†Ô∏è</div>`;
                    if(c.ability === 'storm') badges += `<div class="badge badge-storm">‚ö°</div>`;
                    if(c.ability === 'stealth') badges += `<div class="badge badge-stealth">üëÅÔ∏è</div>`;
                    badges += `</div>`;
                    content = `${badges}<div class="card-art ${c.artClass}"><div class="art-placeholder">${c.symbol}</div></div><div class="card-info"><div class="card-symbol" style="color:var(--accent-blue)">${c.symbol}</div><div class="card-name">${c.name}</div><div class="stats"><div class="stat-box stat-atk">‚öîÔ∏è${c.atk}</div><div class="stat-box stat-hp">‚ù§Ô∏è${c.currentHp}</div></div></div>`;
                }
                div.innerHTML = content;
                el.appendChild(div);
            });
        }

        function updateHint() {
            const list = document.getElementById('craftable-list'); list.innerHTML = '';
            if(!gs.isPlayerTurn) return;
            gs.playerRecipes.forEach(r => {
                const handSym = gs.player.hand.map(c => c.symbol);
                let possible = true;
                for(const ing of r.ingredients) {
                    const idx = handSym.indexOf(ing);
                    if(idx === -1) { possible = false; break; }
                    handSym.splice(idx, 1);
                }
                if(possible) {
                    const btn = document.createElement('div'); btn.className = 'craft-hint-btn';
                    let badges = '';
                    if(r.product.ability === 'ward') badges += 'üõ°Ô∏è';
                    if(r.product.ability === 'toxic') badges += '‚ò†Ô∏è';
                    if(r.product.ability === 'storm') badges += '‚ö°';
                    btn.innerHTML = `<div style="font-size:12px; font-weight:bold; color:var(--accent-gold);">‚ú® ${r.product.name}</div><div style="font-size:10px; display:flex; gap:5px; margin-top:2px;"><span style="color:#e67e22;">‚öîÔ∏è${r.product.atk}</span><span style="color:var(--success);">‚ù§Ô∏è${r.product.hp}</span><span>${badges}</span></div>`;
                    btn.onclick = () => autoSelect(r.ingredients);
                    list.appendChild(btn);
                }
            });
        }
        function autoSelect(ingredients) {
            gs.selectedHandIds = []; const tempHand = [...gs.player.hand];
            ingredients.forEach(ing => {
                const idx = tempHand.findIndex(c => c.symbol === ing);
                if(idx !== -1) { gs.selectedHandIds.push(tempHand[idx].id); tempHand.splice(idx, 1); }
            });
            updateView();
        }
        function showMessage(txt, time=1500) { const box = document.getElementById('msg-box'); box.innerText = txt; box.style.opacity = 1; setTimeout(() => box.style.opacity = 0, time); }

    </script>
</body>
</html>