<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chem-Verse: Complete</title>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #1a1a1d;
            --accent: #f1c40f;
            --primary: #3498db;
            --danger: #e74c3c;
            --success: #2ecc71;
            --rare-n: #95a5a6;
            --rare-r: #3498db;
            --rare-sr: #9b59b6;
            --rare-ssr: #f1c40f;
        }

        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background-color: var(--bg-color);
            color: white;
            margin: 0;
            user-select: none;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            height: 100vh;
            width: 100vw;
        }

        /* --- å…±é€š: ç”»é¢åˆ‡ã‚Šæ›¿ãˆ --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            z-index: 100; transition: opacity 0.3s;
        }
        .hidden { display: none !important; opacity: 0; pointer-events: none; }

        /* --- 1. ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ --- */
        #title-screen {
            background: radial-gradient(circle at center, #2c3e50 0%, #000000 100%);
            overflow: hidden;
        }
        
        /* èƒŒæ™¯ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ« */
        .particle {
            position: absolute; border-radius: 50%; background: rgba(255,255,255,0.5);
            animation: floatUp linear infinite; z-index: 0;
        }
        @keyframes floatUp { from { transform: translateY(100vh) scale(0); opacity: 0; } to { transform: translateY(-10vh) scale(1); opacity: 1; } }

        .game-logo {
            font-family: 'Orbitron', sans-serif; font-size: 40px; color: var(--accent);
            text-shadow: 0 0 20px var(--accent); margin-bottom: 10px; z-index: 10;
            text-align: center; line-height: 1.2;
        }
        .game-sub-logo { font-size: 16px; color: #aaa; margin-bottom: 50px; z-index: 10; letter-spacing: 4px; }

        .menu-container { display: flex; flex-direction: column; gap: 15px; width: 80%; max-width: 300px; z-index: 10; }
        .menu-btn {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3);
            color: white; padding: 15px; border-radius: 30px; font-size: 16px; font-weight: bold;
            cursor: pointer; transition: 0.2s; text-align: center;
            backdrop-filter: blur(5px);
        }
        .menu-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.2); }
        .menu-btn.primary { background: linear-gradient(90deg, var(--primary), #2980b9); border: none; box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4); }
        .menu-btn.disabled { opacity: 0.5; cursor: not-allowed; }

        /* --- 2. ãƒ‡ãƒƒã‚­é¸æŠç”»é¢ --- */
        #deck-select-screen { padding-top: 40px; justify-content: flex-start; }
        .deck-header { font-size: 20px; font-weight: bold; margin-bottom: 20px; color: var(--accent); }
        .deck-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
            width: 100%; max-width: 600px; padding: 0 15px 40px 15px;
            box-sizing: border-box; overflow-y: auto;
        }
        .deck-card {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            padding: 15px; border-radius: 12px; cursor: pointer;
            display: flex; flex-direction: column; justify-content: space-between;
            min-height: 100px; transition: 0.2s; position: relative; overflow: hidden;
        }
        .deck-card::before {
            content:''; position: absolute; top:0; left:0; width:4px; height:100%;
            background: var(--accent);
        }
        .deck-card:active { transform: scale(0.95); background: rgba(255,255,255,0.1); }
        .deck-title { font-size: 16px; font-weight: bold; margin-bottom: 5px; color: #fff; }
        .deck-desc { font-size: 10px; color: #aaa; line-height: 1.4; }
        .back-btn { position: absolute; bottom: 20px; background: #333; padding: 10px 30px; border-radius: 20px; font-size: 14px; }

        /* --- 3. ã‚²ãƒ¼ãƒ ãƒœãƒ¼ãƒ‰ --- */
        #game-board { display: none; flex-direction: column; height: 100vh; position: relative; background: #111; }
        
        #enemy-hand-area { height: 10%; background: rgba(0,0,0,0.3); display: flex; justify-content: center; align-items: center; gap: 2px; }
        #enemy-field { height: 23%; border-bottom: 2px solid rgba(255,255,255,0.1); display: flex; justify-content: center; align-items: center; }
        
        #info-area {
            height: 12%; background: rgba(20,20,30,0.8);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 10px; z-index: 10;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            border-top: 1px solid #333; border-bottom: 1px solid #333;
        }

        #player-field { height: 23%; border-top: 2px solid rgba(255,255,255,0.1); display: flex; justify-content: center; align-items: center; }
        #player-hand-area { 
            height: 32%; background: rgba(0,0,0,0.2);
            overflow-x: auto; display: flex; align-items: center; 
            padding-left: 10px; gap: 6px;
        }

        /* ã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
        .card {
            width: 70px; height: 100px;
            background: #222; color: #fff;
            border-radius: 8px; position: relative;
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
            border: 2px solid #555; flex-shrink: 0;
            transition: transform 0.1s; overflow: hidden;
        }
        .card[data-rarity="N"] { border-color: var(--rare-n); }
        .card[data-rarity="R"] { border-color: var(--rare-r); box-shadow: 0 0 5px var(--rare-r); }
        .card[data-rarity="SR"] { border-color: var(--rare-sr); box-shadow: 0 0 8px var(--rare-sr); }
        .card[data-rarity="SSR"] { border-color: var(--rare-ssr); box-shadow: 0 0 12px var(--rare-ssr); animation: holo 3s infinite linear; }
        @keyframes holo { 0% { filter: brightness(1); } 50% { filter: brightness(1.2); } 100% { filter: brightness(1); } }

        .card-art { width: 100%; height: 55%; display: flex; justify-content: center; align-items: center; font-size: 20px; font-weight: bold; position: relative; }
        .art-gas { background: linear-gradient(135deg, #bdc3c7, #2c3e50); color:#333; }
        .art-liquid { background: linear-gradient(135deg, #4facfe, #00f2fe); color:#004e92; }
        .art-solid { background: linear-gradient(135deg, #e6b980, #eacda3); color:#5d4037; }
        .art-metal { background: linear-gradient(135deg, #f7971e, #ffd200); color:#5d4037; }
        .art-toxic { background: linear-gradient(135deg, #667eea, #764ba2); color:#fff; }

        .card-info { height: 45%; background: rgba(30,30,30,0.95); padding: 2px; display: flex; flex-direction: column; justify-content: space-between; }
        .card-symbol { font-size: 14px; font-weight: bold; text-align: center; color:var(--accent); }
        .card-name { font-size: 9px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .stats { display: flex; justify-content: space-between; padding: 0 2px; font-weight: bold; font-size: 10px; margin-bottom: 2px; }
        .stat-box { padding: 1px 4px; border-radius: 3px; }
        .stat-atk { background: #e67e22; } .stat-hp { background: #27ae60; }

        .ability-container { position: absolute; top: 2px; right: 2px; display: flex; gap: 1px; z-index: 5; }
        .badge { width: 16px; height: 16px; border-radius: 50%; font-size: 10px; display: flex; align-items: center; justify-content: center; border: 1px solid white; box-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        .badge-ward { background: #3498db; } .badge-toxic { background: #8e44ad; } .badge-storm { background: #f1c40f; } .badge-stealth { background: #95a5a6; }

        .card.selected { border-color: var(--accent); transform: translateY(-15px); box-shadow: 0 0 15px var(--accent); z-index: 10; }
        .card.can-attack { border-color: var(--success); box-shadow: 0 0 10px var(--success); }
        
        /* UIãƒ‘ãƒ¼ãƒ„ */
        .leader { text-align: center; width: 70px; }
        .leader-name { font-size: 10px; font-weight: bold; color: var(--accent); margin-bottom: 2px; }
        .hp-circle { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; border-radius: 50%; width: 38px; height: 38px; line-height: 38px; font-weight: bold; font-size: 16px; margin: 0 auto; border: 2px solid white; box-shadow: 0 0 8px rgba(231, 76, 60, 0.8); }
        .turn-info { text-align: center; font-size: 12px; }
        .mp-bar { font-size: 14px; color: var(--success); font-weight: bold; }

        .action-overlay { position: absolute; bottom: 33%; right: 10px; display: flex; flex-direction: column; gap: 10px; z-index: 50; }
        .game-btn { padding: 10px 16px; border-radius: 20px; border: none; font-weight: bold; color: white; font-size: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.4); cursor: pointer; }
        .btn-draw { background: linear-gradient(to right, #27ae60, #2ecc71); } 
        .btn-syn { background: linear-gradient(to right, #f39c12, #f1c40f); color: #333; }
        #btn-end-turn { padding: 6px 12px; font-size: 11px; background: #e67e22; border-radius: 15px; border: none; color: white; font-weight: bold; }
        #btn-end-turn:disabled { background: #555; color: #aaa; }
        
        #cancel-attack-btn { display: none; position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%); background: var(--danger); color: white; padding: 10px 20px; border-radius: 20px; border: 2px solid white; font-weight: bold; z-index: 200; box-shadow: 0 0 15px var(--danger); }

        /* --- 4. ãƒªã‚¶ãƒ«ãƒˆç”»é¢ (å‹åˆ©/æ•—åŒ—) --- */
        #result-screen {
            background: rgba(0,0,0,0.9); z-index: 5000;
            backdrop-filter: blur(10px);
        }
        .result-content { text-align: center; animation: popUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popUp { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .result-title { font-size: 48px; font-weight: 800; margin-bottom: 20px; letter-spacing: 5px; font-family: 'Orbitron', sans-serif; }
        .result-win { color: var(--accent); text-shadow: 0 0 20px var(--accent); }
        .result-lose { color: var(--danger); text-shadow: 0 0 20px var(--danger); }
        
        .result-message { font-size: 16px; color: #ccc; margin-bottom: 30px; }
        
        /* å‹åˆ©æ™‚ã®ç´™å¹é›ª */
        .confetti { position: absolute; width: 10px; height: 10px; background-color: #f00; animation: confetti-fall linear forwards; }
        @keyframes confetti-fall { 0% { transform: translateY(-10vh) rotate(0deg); } 100% { transform: translateY(110vh) rotate(720deg); } }

        /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è©³ç´° */
        #card-detail-panel { position: absolute; top: 15%; left: 50%; transform: translateX(-50%); width: 85%; max-width: 320px; background: rgba(20, 20, 30, 0.95); border: 2px solid var(--accent); border-radius: 12px; padding: 20px; display: none; flex-direction: column; color: white; z-index: 3000; box-shadow: 0 0 40px rgba(0,0,0,0.8); }
        .detail-close { position: absolute; top: 5px; right: 10px; font-size: 24px; cursor: pointer; color: #aaa; }
        .detail-header { text-align: center; margin-bottom: 10px; border-bottom: 1px solid #555; padding-bottom: 10px;}
        .detail-symbol { font-size: 36px; font-weight: bold; color: var(--primary); }
        .detail-name { font-size: 18px; font-weight: bold; margin-bottom: 5px; }
        .detail-rarity { font-size: 12px; color: var(--accent); }
        .detail-stats-box { display: flex; justify-content: center; gap: 20px; margin: 10px 0; font-size: 18px; font-weight: bold; }
        .detail-skills { font-size: 13px; max-height: 200px; overflow-y: auto; text-align: left; }
        .skill-item { margin-bottom: 10px; border-left: 3px solid var(--accent); padding-left: 10px; background: rgba(255,255,255,0.05); padding: 8px; border-radius: 0 5px 5px 0;}
        .skill-item-name { font-weight: bold; color: var(--accent); font-size: 14px;}
        .skill-item-desc { color: #ddd; font-size: 11px; margin-top: 2px;}

        #craftable-list { position: absolute; bottom: 35%; left: 10px; display: flex; flex-direction: column; gap: 5px; z-index: 40; pointer-events: none; }
        .craft-hint-btn { background: rgba(0, 0, 0, 0.9); border: 1px solid var(--accent); color: white; padding: 8px 12px; border-radius: 8px; pointer-events: auto; display: flex; flex-direction: column; min-width: 140px; box-shadow: 0 0 10px rgba(241, 196, 15, 0.3); }
        
        #skill-modal { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 4000; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .skill-list { width: 100%; max-width: 350px; display: flex; flex-direction: column; gap: 10px; }
        .skill-btn { background: #fff; color: #333; padding: 15px; border-radius: 8px; border-left: 8px solid var(--primary); position: relative; font-weight: bold; }
        
        #msg-box { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); padding: 15px 30px; border-radius: 8px; border: 2px solid white; font-size: 20px; font-weight: bold; pointer-events: none; opacity: 0; transition: 0.3s; z-index: 5000; text-align: center; white-space: nowrap; }
        body.targeting .card { border-style: dashed; }
        .valid-target { animation: pulse 0.8s infinite; border-color: var(--danger) !important; box-shadow: 0 0 10px var(--danger); }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

    </style>
</head>
<body>

    <div id="title-screen" class="screen">
        <div id="particles"></div>
        
        <div class="game-logo">CHEM-VERSE</div>
        <div class="game-sub-logo">MUKI-COLLECT TCG</div>
        
        <div class="menu-container">
            <div class="menu-btn primary" onclick="showDeckSelect()">CPUãƒãƒˆãƒ«</div>
            <div class="menu-btn disabled">å¯¾äººæˆ¦ (æº–å‚™ä¸­)</div>
            <div class="menu-btn disabled">ã‚«ãƒ¼ãƒ‰å›³é‘‘ (æº–å‚™ä¸­)</div>
        </div>
    </div>

    <div id="deck-select-screen" class="screen hidden">
        <div class="deck-header">ä½¿ç”¨ã™ã‚‹ãƒ‡ãƒƒã‚­ã‚’é¸æŠ</div>
        <div class="deck-grid">
            <div class="deck-card" onclick="startGame('aggro')">
                <div class="deck-title">ğŸ”¥ è¶…é€Ÿæ”»</div>
                <div class="deck-desc">HCl, HF<br>é«˜ç«åŠ›ãƒ»ä½è€ä¹…ã§é€Ÿæ”»</div>
            </div>
            <div class="deck-card" onclick="startGame('counter')">
                <div class="deck-title">ğŸ›¡ï¸ ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼</div>
                <div class="deck-desc">AgCl, Fe2O3<br>æ²ˆæ®¿ã¨ä¸å‹•æ…‹ã§é‰„å£</div>
            </div>
            <div class="deck-card" onclick="startGame('toxic')">
                <div class="deck-title">â˜ ï¸ å®³æ‚ª(æ¯’)</div>
                <div class="deck-desc">CO, H2S<br>å¿…æ®ºã§å¤§å‹ã‚’å³æ­»</div>
            </div>
            <div class="deck-card" onclick="startGame('control')">
                <div class="deck-title">ğŸ§ª ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«</div>
                <div class="deck-desc">NaOH, Al2O3<br>å›å¾©ã¨ä¸¡æ€§ã§æ”¯é…</div>
            </div>
            <div class="deck-card" onclick="startGame('gemstone')">
                <div class="deck-title">ğŸ’ å®çŸ³</div>
                <div class="deck-desc">ãƒ€ã‚¤ãƒ¤, ãƒ«ãƒ“ãƒ¼<br>åœ§å€’çš„ãªç¡¬åº¦(HP)</div>
            </div>
            <div class="deck-card" onclick="startGame('heavy')">
                <div class="deck-title">ğŸ­ é‡é‡‘å±</div>
                <div class="deck-desc">é‡‘, W, Pt<br>å¾ŒåŠå·»ãè¿”ã—å‹</div>
            </div>
            <div class="deck-card" onclick="startGame('noble')">
                <div class="deck-title">ğŸˆ è²´ã‚¬ã‚¹</div>
                <div class="deck-desc">ãƒ˜ãƒªã‚¦ãƒ , ãƒã‚ªãƒ³<br>æ½œä¼ã§é¸ã°ã‚Œãªã„</div>
            </div>
            <div class="deck-card" onclick="startGame('hazard')">
                <div class="deck-title">âš—ï¸ å±é™ºç‰©</div>
                <div class="deck-desc">ç‹æ°´, æ¿ƒç¡«é…¸<br>å¼·åŠ›ãªé™¤å»ã‚¹ãƒšãƒ«</div>
            </div>
        </div>
        <div class="back-btn menu-btn" style="width:auto;" onclick="showTitle()">ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹</div>
    </div>

    <div id="game-board">
        <div id="enemy-hand-area"></div>
        <div id="enemy-field" class="area"></div>
        <div id="info-area">
            <div class="leader" id="leader-enemy" onclick="onLeaderClick('enemy')">
                <div class="avatar" style="font-size:24px;">ğŸ¤–</div>
                <div class="leader-name" id="enemy-name">CPU</div>
                <div id="enemy-hp" class="hp-circle">25</div>
            </div>
            <div class="turn-info">
                <div id="turn-display" style="color:#aaa;">ã‚¿ãƒ¼ãƒ³ 1</div>
                <div id="mp-display" class="mp-bar">MP 1/1</div>
            </div>
            <button id="btn-end-turn" onclick="endTurn()">ã‚¿ãƒ¼ãƒ³çµ‚äº†</button>
            <div class="leader" id="leader-player" onclick="onLeaderClick('player')">
                <div id="player-hp" class="hp-circle">25</div>
                <div class="leader-name">ã‚ãªãŸ</div>
                <div class="avatar" style="font-size:24px;">ğŸ§‘â€ğŸ”¬</div>
            </div>
        </div>
        
        <div id="craftable-list"></div>

        <div id="player-field" class="area"></div>
        <div id="player-hand-area"></div>

        <div id="cancel-attack-btn" onclick="cancelAttack()">âŒ æ”»æ’ƒã‚’ã‚„ã‚ã‚‹</div>
    </div>

    <div id="result-screen" class="screen hidden">
        <div class="result-content">
            <div class="result-title" id="result-title">VICTORY</div>
            <div class="result-message" id="result-message">ã‚ãªãŸã®å‹åˆ©ã§ã™ï¼</div>
            <div class="menu-btn primary" onclick="showTitle()">ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹</div>
        </div>
        <div id="confetti-container"></div>
    </div>

    <div id="card-detail-panel" onclick="hideDetail()">
        <div class="detail-close">Ã—</div>
        <div class="detail-header">
            <div class="detail-symbol" id="detail-symbol"></div>
            <div class="detail-name" id="detail-name"></div>
            <div class="detail-rarity" id="detail-rarity"></div>
        </div>
        <div class="detail-stats-box" id="detail-stats"></div>
        <div class="detail-skills" id="detail-skills"></div>
        <div style="text-align:center; margin-top:15px; font-size:10px; color:#888;">(ã‚¿ãƒƒãƒ—ã—ã¦é–‰ã˜ã‚‹)</div>
    </div>

    <div class="action-overlay" id="action-btns" style="display:none;">
        <button class="game-btn btn-draw" onclick="actionDraw()">ï¼‹ ãƒ‰ãƒ­ãƒ¼</button>
        <button class="game-btn btn-syn" onclick="actionSynthesize()">âš—ï¸ åˆæˆ</button>
    </div>

    <div id="skill-modal">
        <h3 style="color:white; margin-bottom:15px;">æŠ€ã‚’é¸æŠã—ã¦ãã ã•ã„</h3>
        <div id="skill-list" class="skill-list"></div>
        <button class="game-btn" style="background:#7f8c8d; margin-top:20px; width:100px;" onclick="closeSkillModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>

    <div id="msg-box"></div>

    <script>
        // --- è¨­å®šãƒ»ãƒ‡ãƒ¼ã‚¿ ---
        const MAX_HAND = 10; 
        const MAX_FIELD = 5;
        const INITIAL_HP = 25;

        // å…¨å…ƒç´ å®šç¾©
        const ELEM = {
            H: { symbol: 'H', name: 'æ°´ç´ ', rarity: 'N', artClass: 'art-gas' },
            He: { symbol: 'He', name: 'ãƒ˜ãƒªã‚¦ãƒ ', rarity: 'SR', artClass: 'art-gas' },
            Li: { symbol: 'Li', name: 'ãƒªãƒã‚¦ãƒ ', rarity: 'R', artClass: 'art-metal' },
            Be: { symbol: 'Be', name: 'ãƒ™ãƒªãƒªã‚¦ãƒ ', rarity: 'R', artClass: 'art-metal' },
            B: { symbol: 'B', name: 'ãƒ›ã‚¦ç´ ', rarity: 'R', artClass: 'art-solid' },
            C: { symbol: 'C', name: 'ç‚­ç´ ', rarity: 'N', artClass: 'art-solid' },
            N: { symbol: 'N', name: 'çª’ç´ ', rarity: 'N', artClass: 'art-gas' },
            O: { symbol: 'O', name: 'é…¸ç´ ', rarity: 'N', artClass: 'art-gas' },
            F: { symbol: 'F', name: 'ãƒ•ãƒƒç´ ', rarity: 'SR', artClass: 'art-toxic' },
            Ne: { symbol: 'Ne', name: 'ãƒã‚ªãƒ³', rarity: 'SR', artClass: 'art-gas' },
            Na: { symbol: 'Na', name: 'ãƒŠãƒˆãƒªã‚¦ãƒ ', rarity: 'N', artClass: 'art-metal' },
            Mg: { symbol: 'Mg', name: 'ãƒã‚°ãƒã‚·ã‚¦ãƒ ', rarity: 'R', artClass: 'art-metal' },
            Al: { symbol: 'Al', name: 'ã‚¢ãƒ«ãƒŸãƒ‹ã‚¦ãƒ ', rarity: 'R', artClass: 'art-metal' },
            Si: { symbol: 'Si', name: 'ã‚±ã‚¤ç´ ', rarity: 'R', artClass: 'art-solid' },
            P: { symbol: 'P', name: 'ãƒªãƒ³', rarity: 'R', artClass: 'art-solid' },
            S: { symbol: 'S', name: 'ç¡«é»„', rarity: 'R', artClass: 'art-solid' },
            Cl: { symbol: 'Cl', name: 'å¡©ç´ ', rarity: 'N', artClass: 'art-toxic' },
            Ar: { symbol: 'Ar', name: 'ã‚¢ãƒ«ã‚´ãƒ³', rarity: 'SR', artClass: 'art-gas' },
            K: { symbol: 'K', name: 'ã‚«ãƒªã‚¦ãƒ ', rarity: 'N', artClass: 'art-metal' },
            Ca: { symbol: 'Ca', name: 'ã‚«ãƒ«ã‚·ã‚¦ãƒ ', rarity: 'R', artClass: 'art-metal' },
            Ti: { symbol: 'Ti', name: 'ãƒã‚¿ãƒ³', rarity: 'SR', artClass: 'art-metal' },
            V: { symbol: 'V', name: 'ãƒãƒŠã‚¸ã‚¦ãƒ ', rarity: 'SR', artClass: 'art-metal' },
            Cr: { symbol: 'Cr', name: 'ã‚¯ãƒ­ãƒ ', rarity: 'SR', artClass: 'art-metal' },
            Mn: { symbol: 'Mn', name: 'ãƒãƒ³ã‚¬ãƒ³', rarity: 'R', artClass: 'art-metal' },
            Fe: { symbol: 'Fe', name: 'é‰„', rarity: 'N', artClass: 'art-metal' },
            Ni: { symbol: 'Ni', name: 'ãƒ‹ãƒƒã‚±ãƒ«', rarity: 'R', artClass: 'art-metal' },
            Cu: { symbol: 'Cu', name: 'éŠ…', rarity: 'N', artClass: 'art-metal' },
            Zn: { symbol: 'Zn', name: 'äºœé‰›', rarity: 'R', artClass: 'art-metal' },
            Ga: { symbol: 'Ga', name: 'ã‚¬ãƒªã‚¦ãƒ ', rarity: 'SR', artClass: 'art-metal' },
            Ge: { symbol: 'Ge', name: 'ã‚²ãƒ«ãƒãƒ‹ã‚¦ãƒ ', rarity: 'SR', artClass: 'art-metal' },
            Ag: { symbol: 'Ag', name: 'éŠ€', rarity: 'SR', artClass: 'art-metal' },
            Cd: { symbol: 'Cd', name: 'ã‚«ãƒ‰ãƒŸã‚¦ãƒ ', rarity: 'R', artClass: 'art-toxic' },
            Sn: { symbol: 'Sn', name: 'ã‚¹ã‚º', rarity: 'R', artClass: 'art-metal' },
            Ba: { symbol: 'Ba', name: 'ãƒãƒªã‚¦ãƒ ', rarity: 'R', artClass: 'art-metal' },
            W:  { symbol: 'W', name: 'ã‚¿ãƒ³ã‚°ã‚¹ãƒ†ãƒ³', rarity: 'SSR', artClass: 'art-metal' },
            Pt: { symbol: 'Pt', name: 'ãƒ—ãƒ©ãƒãƒŠ', rarity: 'SSR', artClass: 'art-metal' },
            Au: { symbol: 'Au', name: 'é‡‘', rarity: 'SSR', artClass: 'art-metal' },
            Hg: { symbol: 'Hg', name: 'æ°´éŠ€', rarity: 'SR', artClass: 'art-toxic' },
            Pb: { symbol: 'Pb', name: 'é‰›', rarity: 'R', artClass: 'art-metal' }
        };

        const RECIPES = [
            // é€Ÿæ”»
            { ingredients: ['H', 'Cl'], product: { symbol: 'HCl', name: 'å¡©åŒ–æ°´ç´ ', rarity:'R', atk: 5, hp: 1, artClass:'art-toxic', skills: [{name:'å¼·é…¸è…é£Ÿ', power:5, desc:'é«˜ç«åŠ›ã®é…¸æ”»æ’ƒ'}] }},
            { ingredients: ['H', 'F'], product: { symbol: 'HF', name: 'ãƒ•ãƒƒåŒ–æ°´ç´ ', rarity:'SR', atk: 4, hp: 2, ability:'toxic', artClass:'art-toxic', skills: [{name:'ã‚¬ãƒ©ã‚¹è…é£Ÿ', power:4, desc:'é€šå¸¸æ”»æ’ƒ'}, {name:'çŒ›æ¯’', power:0, type:'toxic', desc:'è§¦ã‚Œã‚‹ã¨å±é™º(å¿…æ®º)'}] }},
            { ingredients: ['Na', 'H'], product: { symbol: 'NaH', name: 'æ°´ç´ åŒ–Na', rarity:'R', atk: 3, hp: 1, ability:'storm', artClass:'art-solid', skills: [{name:'é‚„å…ƒä½œç”¨', power:3, desc:'ç–¾èµ°:å³æ”»æ’ƒå¯èƒ½'}] }},
            { ingredients: ['H', 'H', 'O'], product: { symbol: 'H2O', name: 'æ°´', rarity:'N', atk: 1, hp: 4, artClass:'art-liquid', skills: [{name:'æ°´æµ', power:1, desc:'æ”»æ’ƒ'}, {name:'åŠ æ°´åˆ†è§£', power:3, type:'heal', desc:'ãƒªãƒ¼ãƒ€ãƒ¼ã‚’3å›å¾©'}] }},
            // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
            { ingredients: ['Ag', 'Cl'], product: { symbol: 'AgCl', name: 'å¡©åŒ–éŠ€', rarity:'SR', atk: 1, hp: 6, ability:'ward', artClass:'art-solid', skills: [{name:'æ„Ÿå…‰', power:1, desc:'æ”»æ’ƒ'}, {name:'ç™½è‰²æ²ˆæ®¿', power:0, type:'guard', desc:'å®ˆè­·:å£ã«ãªã‚‹'}] }},
            { ingredients: ['Fe', 'O'], product: { symbol: 'FeO', name: 'é…¸åŒ–é‰„(II)', rarity:'N', atk: 3, hp: 5, artClass:'art-solid', skills: [{name:'é»’éŒ†', power:3, desc:'é€šå¸¸æ”»æ’ƒ'}] }},
            { ingredients: ['Fe', 'O', 'O'], product: { symbol: 'Fe2O3', name: 'èµ¤éŒ†(ä¸å‹•æ…‹)', rarity:'R', atk: 2, hp: 8, ability:'ward', artClass:'art-solid', skills: [{name:'ä¸å‹•æ…‹çš®è†œ', power:2, desc:'é«˜ã„é˜²å¾¡åŠ›ã§å®ˆã‚‹'}] }},
            { ingredients: ['Cu', 'O'], product: { symbol: 'CuO', name: 'é…¸åŒ–éŠ…(II)', rarity:'N', atk: 3, hp: 4, artClass:'art-solid', skills: [{name:'é»’è‰²ç²‰æœ«', power:3, desc:'é€šå¸¸æ”»æ’ƒ'}] }},
            { ingredients: ['Zn', 'Cu'], product: { symbol: 'Brass', name: 'é»„éŠ…', rarity:'R', atk: 4, hp: 5, artClass:'art-metal', skills: [{name:'åˆé‡‘ã‚¢ã‚¿ãƒƒã‚¯', power:4, desc:'å®‰å®šã—ãŸå¼·ã•'}] }},
            { ingredients: ['Hg', 'Zn'], product: { symbol: 'Amalgam', name: 'äºœé‰›ã‚¢ãƒãƒ«ã‚¬ãƒ ', rarity:'SR', atk: 3, hp: 6, ability:'ward', artClass:'art-metal', skills: [{name:'ã‚¢ãƒãƒ«ã‚¬ãƒ åŒ–', power:3, desc:'å®ˆè­·ã‚’æŒã¤åˆé‡‘'}] }},
            // å®³æ‚ª
            { ingredients: ['C', 'O'], product: { symbol: 'CO', name: 'ä¸€é…¸åŒ–ç‚­ç´ ', rarity:'R', atk: 1, hp: 2, ability:'toxic', artClass:'art-gas', skills: [{name:'ä¸å®Œå…¨ç‡ƒç„¼', power:1, desc:'æ”»æ’ƒ'}, {name:'ãƒ˜ãƒ¢ã‚°ãƒ­ãƒ“ãƒ³çµåˆ', power:0, type:'toxic', desc:'å¿…æ®º:å³æ­»ã•ã›ã‚‹'}] }},
            { ingredients: ['H', 'S'], product: { symbol: 'H2S', name: 'ç¡«åŒ–æ°´ç´ ', rarity:'R', atk: 2, hp: 3, ability:'toxic', artClass:'art-gas', skills: [{name:'è…åµè‡­', power:2, desc:'æ”»æ’ƒ'}, {name:'ç¡«åŒ–', power:0, type:'toxic', desc:'å¿…æ®ºæ”»æ’ƒ'}] }},
            { ingredients: ['Cl', 'Cl'], product: { symbol: 'Cl2', name: 'å¡©ç´ ã‚¬ã‚¹', rarity:'R', atk: 3, hp: 3, artClass:'art-gas', skills: [{name:'é…¸åŒ–ä½œç”¨', power:3, desc:'æ”»æ’ƒ'}, {name:'æ¯’ã‚¬ã‚¹æ•£å¸ƒ', power:2, type:'aoe', desc:'æ•µå…¨ä½“ã«2ãƒ€ãƒ¡ãƒ¼ã‚¸'}] }},
            { ingredients: ['S', 'O', 'O'], product: { symbol: 'SO2', name: 'äºŒé…¸åŒ–ç¡«é»„', rarity:'N', atk: 2, hp: 4, artClass:'art-gas', skills: [{name:'æ¼‚ç™½', power:2, desc:'æ”»æ’ƒ'}, {name:'é…¸æ€§é›¨', power:1, type:'aoe', desc:'æ•µå…¨ä½“ã«1ãƒ€ãƒ¡ãƒ¼ã‚¸'}] }},
            { ingredients: ['Cd', 'S'], product: { symbol: 'CdS', name: 'ç¡«åŒ–ã‚«ãƒ‰ãƒŸã‚¦ãƒ ', rarity:'SR', atk: 2, hp: 5, ability:'toxic', artClass:'art-toxic', skills: [{name:'ã‚¤ã‚¿ã‚¤ã‚¤ã‚¿ã‚¤', power:0, type:'toxic', desc:'çŒ›æ¯’:è§¦ã‚Œã‚‹ã¨å³æ­»'}] }},
            // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
            { ingredients: ['Na', 'O', 'H'], product: { symbol: 'NaOH', name: 'æ°´é…¸åŒ–Na', rarity:'R', atk: 3, hp: 3, artClass:'art-solid', skills: [{name:'æ½®è§£', power:3, desc:'æ”»æ’ƒ'}, {name:'ä¸­å’Œç†±', power:2, type:'aoe_heal', desc:'æ•µå…¨ä½“2ãƒ€ãƒ¡/è‡ªåˆ†2å›å¾©'}] }},
            { ingredients: ['Al', 'O', 'O'], product: { symbol: 'Al2O3', name: 'ã‚¢ãƒ«ãƒŸãƒŠ', rarity:'R', atk: 2, hp: 7, ability:'ward', artClass:'art-solid', skills: [{name:'ã‚¢ãƒ«ãƒã‚¤ãƒˆ', power:2, desc:'é…¸åŒ–è¢«è†œãƒãƒªã‚¢'}] }},
            { ingredients: ['Cl', 'Na'], product: { symbol: 'NaCl', name: 'å¡©åŒ–Na', rarity:'N', atk: 3, hp: 4, artClass:'art-solid', skills: [{name:'å¡©å‘³', power:3, desc:'é€šå¸¸æ”»æ’ƒ'}] }},
            { ingredients: ['Ca', 'O', 'H', 'H'], product: { symbol: 'Ca(OH)2', name: 'æ¶ˆçŸ³ç°', rarity:'N', atk: 1, hp: 6, ability:'ward', artClass:'art-solid', skills: [{name:'çŸ³ç°æ°´', power:1, desc:'æ”»æ’ƒ'}, {name:'ä¸­å’Œåå¿œ', power:4, type:'heal', desc:'HP4å›å¾©'}] }},
            // å®çŸ³
            { ingredients: ['C', 'C', 'C'], product: { symbol: 'Diamond', name: 'ãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ³ãƒ‰', rarity:'SSR', atk: 4, hp: 10, ability:'ward', artClass:'art-solid', skills: [{name:'ãƒ¢ãƒ¼ã‚¹ç¡¬åº¦10', power:4, desc:'æœ€å¼·ã®ç¡¬åº¦'}] }},
            { ingredients: ['Al', 'O', 'O', 'Cr'], product: { symbol: 'Ruby', name: 'ãƒ«ãƒ“ãƒ¼', rarity:'SR', atk: 5, hp: 8, artClass:'art-solid', skills: [{name:'æ·±ç´…ã®è¼ã', power:5, desc:'é«˜ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'}] }},
            { ingredients: ['Al', 'O', 'Ti'], product: { symbol: 'Sapphire', name: 'ã‚µãƒ•ã‚¡ã‚¤ã‚¢', rarity:'SR', atk: 4, hp: 9, artClass:'art-solid', skills: [{name:'é’ç‰', power:4, desc:'é«˜è€ä¹…'}] }},
            { ingredients: ['Si', 'O', 'O'], product: { symbol: 'SiO2', name: 'çŸ³è‹±(æ°´æ™¶)', rarity:'N', atk: 3, hp: 6, artClass:'art-solid', skills: [{name:'åœ§é›»åŠ¹æœ', power:3, desc:'æ”»æ’ƒ'}, {name:'çµæ™¶åŒ–', power:2, type:'aoe', desc:'å…¨ä½“2ãƒ€ãƒ¡ãƒ¼ã‚¸'}] }},
            // é‡é‡‘å±
            { ingredients: ['Au'], product: { symbol: 'Au', name: 'é‡‘', rarity:'SSR', atk: 6, hp: 6, artClass:'art-metal', skills: [{name:'ä¸å¤‰ã®è¼ã', power:6, desc:'ç‹æ°´ä»¥å¤–ç„¡æ•µã®æ”»æ’ƒ'}] }},
            { ingredients: ['Pt'], product: { symbol: 'Pt', name: 'ãƒ—ãƒ©ãƒãƒŠ', rarity:'SSR', atk: 5, hp: 7, artClass:'art-metal', skills: [{name:'è§¦åª’ä½œç”¨', power:5, desc:'åå¿œã‚’ä¿ƒé€²ã™ã‚‹ä¸€æ’ƒ'}] }},
            { ingredients: ['W'], product: { symbol: 'W', name: 'ã‚¿ãƒ³ã‚°ã‚¹ãƒ†ãƒ³', rarity:'SSR', atk: 7, hp: 8, ability:'ward', artClass:'art-metal', skills: [{name:'èç‚¹3422â„ƒ', power:7, desc:'ç†±ã«å¼·ã„ä¸€æ’ƒ'}] }},
            { ingredients: ['Ti'], product: { symbol: 'Ti', name: 'ãƒã‚¿ãƒ³', rarity:'SR', atk: 4, hp: 5, artClass:'art-metal', skills: [{name:'é«˜å¼·åº¦', power:4, desc:'è»½ãã¦å¼·ã„'}] }},
            // è²´ã‚¬ã‚¹
            { ingredients: ['He', 'He'], product: { symbol: 'He', name: 'ãƒ˜ãƒªã‚¦ãƒ ', rarity:'SR', atk: 2, hp: 2, ability:'stealth', artClass:'art-gas', skills: [{name:'ä¸æ´»æ€§', power:2, desc:'æ½œä¼æ”»æ’ƒ'}] }},
            { ingredients: ['Ne', 'Ne'], product: { symbol: 'Ne', name: 'ãƒã‚ªãƒ³', rarity:'SR', atk: 3, hp: 3, ability:'stealth', artClass:'art-gas', skills: [{name:'ãƒã‚ªãƒ³ã‚µã‚¤ãƒ³', power:3, desc:'æ½œä¼æ”»æ’ƒ'}] }},
            { ingredients: ['Ar', 'Ar'], product: { symbol: 'Ar', name: 'ã‚¢ãƒ«ã‚´ãƒ³', rarity:'SR', atk: 4, hp: 4, ability:'stealth', artClass:'art-gas', skills: [{name:'ãƒ•ã‚£ãƒ©ãƒ¡ãƒ³ãƒˆä¿è­·', power:4, desc:'æ½œä¼æ”»æ’ƒ'}] }},
            // å±é™ºç‰©
            { ingredients: ['H', 'Cl', 'N', 'O', 'O', 'O'], product: { symbol: 'AquaRegia', name: 'ç‹æ°´', rarity:'SSR', atk: 0, hp: 0, type:'spell', artClass:'art-liquid', skills: [{name:'é‡‘æº¶ã‹ã—', power:99, type:'toxic', desc:'å˜ä½“ç¢ºå®šé™¤å»'}] }},
            { ingredients: ['H', 'H', 'S', 'O', 'O', 'O', 'O'], product: { symbol: 'H2SO4', name: 'æ¿ƒç¡«é…¸', rarity:'SR', atk: 0, hp: 0, type:'spell', artClass:'art-liquid', skills: [{name:'è„±æ°´ä½œç”¨', power:5, type:'aoe', desc:'æ•µå…¨ä½“5ãƒ€ãƒ¡ãƒ¼ã‚¸'}] }},
            { ingredients: ['K', 'Mn', 'O', 'O', 'O', 'O'], product: { symbol: 'KMnO4', name: 'éãƒãƒ³ã‚¬ãƒ³é…¸K', rarity:'SR', atk: 0, hp: 0, type:'spell', artClass:'art-solid', skills: [{name:'å¼·åŠ›é…¸åŒ–', power:7, type:'damage', desc:'å˜ä½“7ãƒ€ãƒ¡ãƒ¼ã‚¸'}] }},
        ];

        const DECKS = {
            aggro: { name: 'è¶…é€Ÿæ”»', elements: ['H', 'H', 'Cl', 'F', 'Na', 'O'], recipes: ['HCl', 'HF', 'NaH', 'H2O'] },
            counter: { name: 'ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼', elements: ['Ag', 'Cl', 'Fe', 'O', 'Cu', 'Zn', 'Hg'], recipes: ['AgCl', 'FeO', 'Fe2O3', 'Brass', 'Amalgam', 'CuO'] },
            toxic: { name: 'å®³æ‚ª(æ¯’)', elements: ['C', 'O', 'S', 'H', 'Cl', 'Cd'], recipes: ['CO', 'H2S', 'Cl2', 'SO2', 'CdS'] },
            control: { name: 'ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«', elements: ['Al', 'O', 'H', 'Na', 'Cl', 'Ca'], recipes: ['Al2O3', 'NaOH', 'H2O', 'NaCl', 'Ca(OH)2'] },
            gemstone: { name: 'å®çŸ³', elements: ['C', 'Al', 'O', 'Si', 'Cr', 'Ti'], recipes: ['Diamond', 'Ruby', 'Sapphire', 'SiO2'] },
            heavy: { name: 'é‡é‡‘å±', elements: ['Au', 'Pt', 'W', 'Ti', 'Fe'], recipes: ['Au', 'Pt', 'W', 'Ti'] },
            noble: { name: 'è²´ã‚¬ã‚¹', elements: ['He', 'He', 'Ne', 'Ne', 'Ar', 'Ar'], recipes: ['He', 'Ne', 'Ar'] },
            hazard: { name: 'å±é™ºç‰©', elements: ['H', 'Cl', 'N', 'O', 'S', 'K', 'Mn'], recipes: ['AquaRegia', 'H2SO4', 'KMnO4'] }
        };

        let gs = {
            playerDeck: null, enemyDeck: null,
            playerPool: [], enemyPool: [],
            playerRecipes: [], enemyRecipes: [],
            turn: 1, isPlayerTurn: true, mp: 1, maxMp: 1,
            player: { hp: INITIAL_HP, hand: [], field: [] },
            enemy: { hp: INITIAL_HP, hand: [], field: [], mp: 1, maxMp: 1 },
            selectedHandIds: [], attackingUnit: null,
        };

        // --- åˆæœŸåŒ– ---
        window.onload = () => {
            initParticles();
            showTitle();
        };

        // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ç”Ÿæˆ
        function initParticles() {
            const container = document.getElementById('particles');
            if(!container) return;
            for(let i=0; i<30; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.left = Math.random()*100 + 'vw';
                p.style.width = p.style.height = (Math.random()*5 + 2) + 'px';
                p.style.animationDuration = (Math.random()*10 + 5) + 's';
                p.style.animationDelay = (Math.random()*5) + 's';
                container.appendChild(p);
            }
        }

        // --- ç”»é¢é·ç§» ---
        function showTitle() { hideAll(); document.getElementById('title-screen').classList.remove('hidden'); }
        function showDeckSelect() { hideAll(); document.getElementById('deck-select-screen').classList.remove('hidden'); }
        function showGame() { 
            hideAll(); 
            document.getElementById('game-board').style.display = 'flex'; 
            document.getElementById('action-btns').style.display = 'flex';
        }
        function showResult(isWin) {
            const sc = document.getElementById('result-screen');
            const tit = document.getElementById('result-title');
            const msg = document.getElementById('result-message');
            sc.classList.remove('hidden');
            if(isWin) {
                tit.innerText = "VICTORY";
                tit.className = "result-title result-win";
                msg.innerText = "ã‚ãªãŸã®å‹åˆ©ã§ã™ï¼";
                createConfetti();
            } else {
                tit.innerText = "DEFEAT";
                tit.className = "result-title result-lose";
                msg.innerText = "æ•—åŒ—ã—ã¾ã—ãŸ...";
            }
        }
        function hideAll() {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById('game-board').style.display = 'none';
            document.getElementById('action-btns').style.display = 'none';
            document.getElementById('confetti-container').innerHTML = '';
        }

        /* --- ã‚²ãƒ¼ãƒ é–‹å§‹ --- */
        function startGame(playerDeckKey) {
            resetGame(playerDeckKey);
            showGame();
            showMessage("ãƒãƒˆãƒ«é–‹å§‹ï¼", 2000);
            updateView();
        }

        function resetGame(playerDeckKey) {
             const pConf = DECKS[playerDeckKey];
            gs.playerPool = pConf.elements.map(sym => ELEM[sym]);
            gs.playerRecipes = RECIPES.filter(r => pConf.recipes.includes(r.product.symbol));

            const keys = Object.keys(DECKS);
            const cpuKey = keys[Math.floor(Math.random() * keys.length)];
            const eConf = DECKS[cpuKey];
            gs.enemyPool = eConf.elements.map(sym => ELEM[sym]);
            gs.enemyRecipes = RECIPES.filter(r => eConf.recipes.includes(r.product.symbol));
            
            document.getElementById('enemy-name').innerText = `CPU (${eConf.name})`;

            gs.turn = 1; gs.isPlayerTurn = true; gs.mp = 1; gs.maxMp = 1;
            gs.player = { hp: INITIAL_HP, hand: [], field: [] };
            gs.enemy = { hp: INITIAL_HP, hand: [], field: [], mp: 1, maxMp: 1 };
            gs.selectedHandIds = []; gs.attackingUnit = null;

            for(let i=0; i<5; i++) { drawCard(gs.player); drawCard(gs.enemy); }
            document.getElementById('btn-end-turn').disabled = false;
        }

        /* --- ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ --- */
        function drawCard(target) {
            const pool = (target === gs.enemy) ? gs.enemyPool : gs.playerPool;
            if (target.hand.length >= MAX_HAND) {
                if(target === gs.enemy) target.hand.shift();
                else return null; 
            }
            const base = pool[Math.floor(Math.random() * pool.length)];
            const card = { ...base, id: Math.random().toString(36).substr(2, 9), type: 'element' };
            target.hand.push(card);
            return card;
        }

        function actionDraw() {
            if(!gs.isPlayerTurn || gs.mp < 1) { showMessage("MPä¸è¶³"); return; }
            gs.mp--;
            drawCard(gs.player);
            updateView();
        }

        function actionSynthesize() {
            if(!gs.isPlayerTurn) return;
            if(gs.selectedHandIds.length === 0) return;

            // è²´ã‚¬ã‚¹ã®ã¿2æšã§åˆæˆ
            if(gs.selectedHandIds.length === 1) {
                // 1æšåˆæˆã¯å»ƒæ­¢(è²´ã‚¬ã‚¹èª¿æ•´ã®ãŸã‚) -> ãƒ¬ã‚·ãƒ”å‚ç…§ã¸
            }

            const selCards = gs.player.hand.filter(c => gs.selectedHandIds.includes(c.id));
            const symbols = selCards.map(c => c.symbol).sort();
            const recipe = gs.playerRecipes.find(r => JSON.stringify(r.ingredients.sort()) === JSON.stringify(symbols));

            if(recipe) processSynth(recipe);
            else { showMessage("åå¿œã—ã¾ã›ã‚“"); gs.selectedHandIds = []; updateView(); }
        }

        function processSynth(recipe) {
            if(recipe.product.type === 'spell') {
                const skill = recipe.product.skills[0];
                gs.player.hand = gs.player.hand.filter(c => !gs.selectedHandIds.includes(c.id));
                gs.selectedHandIds = [];
                if(gs.enemy.field.length > 0) {
                    const target = gs.enemy.field.reduce((a,b)=>a.currentHp>b.currentHp?a:b);
                    showMessage(`${skill.name} -> ${target.name}!`);
                    if(skill.type === 'toxic') target.currentHp = -99;
                    else target.currentHp -= skill.power;
                } else {
                    showMessage(`${skill.name} -> ãƒªãƒ¼ãƒ€ãƒ¼!`);
                    gs.enemy.hp -= skill.power;
                }
                checkGameEnd(); updateView(); return;
            }

            if(gs.player.field.length >= MAX_FIELD) { showMessage("ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æº€å“¡"); return; }
            gs.player.hand = gs.player.hand.filter(c => !gs.selectedHandIds.includes(c.id));
            gs.selectedHandIds = [];
            const unit = { ...recipe.product, id: Math.random().toString(36).substr(2, 9), maxHp: recipe.product.hp, currentHp: recipe.product.hp, canAttack: recipe.product.ability === 'storm', type: 'unit' };
            gs.player.field.push(unit);
            showMessage(`å¬å–š: ${unit.name}`);
            updateView();
        }

        /* --- ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ --- */
        function onHandClick(id) {
            if(!gs.isPlayerTurn) return;
            const card = gs.player.hand.find(c => c.id === id);
            if(card) showDetail(card);
            if(gs.selectedHandIds.includes(id)) gs.selectedHandIds = gs.selectedHandIds.filter(x => x !== id);
            else gs.selectedHandIds.push(id);
            updateView();
        }

        function onFieldCardClick(id, isPlayer) {
            if(!gs.isPlayerTurn) return;
            if(isPlayer) {
                const u = gs.player.field.find(x => x.id === id);
                if(u) showDetail(u);
                if(u && u.canAttack) {
                    gs.attackingUnit = u;
                    document.body.classList.add('targeting');
                    updateView(); 
                }
            } else if(gs.attackingUnit) {
                const target = gs.enemy.field.find(x => x.id === id);
                if(target) showDetail(target);
                if(target.ability === 'stealth') { showMessage("æ½œä¼ä¸­ï¼"); return; }
                prepareAttack(gs.attackingUnit, target, 'unit');
            } else {
                const target = gs.enemy.field.find(x => x.id === id);
                if(target) showDetail(target);
            }
        }

        function onLeaderClick(side) {
            if(!gs.isPlayerTurn || side !== 'enemy' || !gs.attackingUnit) return;
            prepareAttack(gs.attackingUnit, 'leader', 'leader');
        }

        function prepareAttack(attacker, target, type) {
            if(type === 'leader' || (type === 'unit' && target.ability !== 'ward')) {
                const guards = gs.enemy.field.filter(u => u.ability === 'ward' && u.ability !== 'stealth');
                if(guards.length > 0) { showMessage("å®ˆè­·ã«é˜»ã¾ã‚ŒãŸï¼"); return; }
            }
            if(attacker.skills.length > 1) openSkillModal(attacker, target);
            else executeSkill(attacker, target, attacker.skills[0]);
        }

        function openSkillModal(attacker, target) {
            const modal = document.getElementById('skill-modal');
            const list = document.getElementById('skill-list');
            list.innerHTML = '';
            attacker.skills.forEach(skill => {
                const btn = document.createElement('div');
                btn.className = 'skill-btn';
                let typeLabel = skill.type ? skill.type.toUpperCase() : 'é€šå¸¸';
                btn.innerHTML = `<span class="skill-name">${skill.name} (å¨åŠ›:${skill.power})</span><div style="font-size:10px; color:#555; margin-top:2px;">${skill.desc}</div>`;
                btn.onclick = () => { executeSkill(attacker, target, skill); closeSkillModal(); };
                list.appendChild(btn);
            });
            modal.style.display = 'flex';
        }
        function closeSkillModal() { document.getElementById('skill-modal').style.display = 'none'; cancelAttack(); }

        function executeSkill(attacker, target, skill) {
            let log = `${attacker.name}ã®æ”»æ’ƒ!`;
            if(skill.type === 'aoe') {
                gs.enemy.field.forEach(u => u.currentHp -= skill.power); gs.enemy.hp -= skill.power;
            } else if(skill.type === 'aoe_heal') {
                gs.enemy.field.forEach(u => u.currentHp -= skill.power); gs.player.hp += skill.power;
            } else if(skill.type === 'heal') {
                gs.player.hp += skill.power;
            } else {
                const dmg = skill.power;
                if(target === 'leader') gs.enemy.hp -= dmg;
                else {
                    const counter = target.atk;
                    if(skill.type === 'toxic' && dmg > 0) target.currentHp = -99;
                    else target.currentHp -= dmg;
                    if(target.currentHp <= 0 && target.ability === 'toxic' && counter > 0) attacker.currentHp = -99;
                    else attacker.currentHp -= counter;
                }
            }
            attacker.canAttack = false; showMessage(log); cancelAttack(); checkGameEnd(); updateView();
        }

        function cancelAttack() { 
            gs.attackingUnit = null; 
            document.body.classList.remove('targeting'); 
            updateView(); 
        }

        function checkGameEnd() {
            gs.player.field = gs.player.field.filter(u => u.currentHp > 0);
            gs.enemy.field = gs.enemy.field.filter(u => u.currentHp > 0);
            if(gs.enemy.hp <= 0) { showResult(true); return; }
            if(gs.player.hp <= 0) { showResult(false); return; }
            updateView();
        }

        function endTurn() {
            if(!gs.isPlayerTurn) return;
            gs.isPlayerTurn = false; cancelAttack(); document.getElementById('btn-end-turn').disabled = true;
            showMessage("æ•µã®ã‚¿ãƒ¼ãƒ³"); setTimeout(cpuTurn, 1500);
        }

        async function cpuTurn() {
            if(gs.enemy.maxMp < 10) gs.enemy.maxMp++; gs.enemy.mp = gs.enemy.maxMp;
            drawCard(gs.enemy); updateView(); await sleep(1000);
            
            let acted = true;
            while(acted && gs.enemy.field.length < MAX_FIELD) {
                acted = false;
                const handSym = gs.enemy.hand.map(c => c.symbol);
                for(const r of gs.enemyRecipes) {
                    if(r.product.type === 'spell') continue;
                    const ingredients = [...r.ingredients];
                    const tempHand = [...handSym];
                    let possible = true;
                    for(const ing of ingredients) {
                        const idx = tempHand.indexOf(ing);
                        if(idx === -1) { possible = false; break; }
                        tempHand.splice(idx, 1);
                    }
                    if(possible) {
                        for(const ing of r.ingredients) {
                            const idx = gs.enemy.hand.findIndex(c => c.symbol === ing);
                            gs.enemy.hand.splice(idx, 1);
                        }
                        const unit = { ...r.product, id: Math.random(), maxHp: r.product.hp, currentHp: r.product.hp, canAttack:false, type:'unit'};
                        gs.enemy.field.push(unit);
                        showMessage(`CPUå¬å–š: ${unit.name}`);
                        await sleep(1000); updateView(); acted = true; break;
                    }
                }
            }
            gs.enemy.field.forEach(u => u.canAttack = true);
            for(const u of gs.enemy.field) {
                if(!u.canAttack) continue;
                const guards = gs.player.field.filter(g => g.ability === 'ward' && g.ability !== 'stealth');
                let target = 'leader';
                if(guards.length > 0) target = guards[0];
                if(target === 'leader') {
                    gs.player.hp -= u.skills[0].power; showMessage(`CPUæ”»æ’ƒ -> ãƒªãƒ¼ãƒ€ãƒ¼`);
                } else {
                    const dmg = u.skills[0].power;
                    const toxic = u.skills[0].type === 'toxic';
                    if(toxic && dmg > 0) target.currentHp = -99; else target.currentHp -= dmg;
                    u.currentHp -= target.atk; showMessage(`CPUæ”»æ’ƒ -> ${target.name}`);
                }
                checkGameEnd(); updateView(); await sleep(1000);
            }
            startPlayerTurn();
        }

        function startPlayerTurn() {
            gs.turn++; if(gs.maxMp < 10) gs.maxMp++; gs.mp = gs.maxMp;
            gs.isPlayerTurn = true; document.getElementById('btn-end-turn').disabled = false;
            gs.player.field.forEach(u => u.canAttack = true);
            drawCard(gs.player); showMessage("ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³"); updateView();
        }
        const sleep = m => new Promise(r => setTimeout(r, m));

        function updateView() {
            document.getElementById('turn-display').innerText = `ã‚¿ãƒ¼ãƒ³ ${gs.turn}`;
            document.getElementById('mp-display').innerText = `MP ${gs.mp}/${gs.maxMp}`;
            document.getElementById('player-hp').innerText = gs.player.hp;
            document.getElementById('enemy-hp').innerText = gs.enemy.hp;
            
            const cancelBtn = document.getElementById('cancel-attack-btn');
            if(gs.attackingUnit) cancelBtn.style.display = 'block';
            else cancelBtn.style.display = 'none';

            renderCards('player-hand-area', gs.player.hand, 'hand');
            renderCards('player-field', gs.player.field, 'field', true);
            renderCards('enemy-field', gs.enemy.field, 'field', false);
            
            const eh = document.getElementById('enemy-hand-area'); eh.innerHTML = '';
            gs.enemy.hand.forEach(() => { const d = document.createElement('div'); d.className = 'card'; d.style.background='#34495e'; d.style.width='30px'; d.style.height='45px'; eh.appendChild(d); });
            updateHint();
        }

        function showDetail(card) {
            const p = document.getElementById('card-detail-panel');
            p.style.display = 'flex';
            document.getElementById('detail-symbol').innerText = card.symbol;
            document.getElementById('detail-name').innerText = card.name;
            document.getElementById('detail-rarity').innerText = `${card.rarity}`;
            const stats = document.getElementById('detail-stats');
            const skills = document.getElementById('detail-skills');
            skills.innerHTML = '';

            if(card.type === 'element') {
                stats.innerHTML = `<span style="font-size:14px; color:#ccc">ç´ æã‚«ãƒ¼ãƒ‰</span>`;
                skills.innerHTML = `<div class="skill-item"><div class="skill-item-desc">ãƒ‡ãƒƒã‚­ç´ æã€‚åˆæˆã«ä½¿ç”¨ã—ã¾ã™ã€‚</div></div>`;
            } else {
                stats.innerHTML = `<span style="color:#e67e22">âš”ï¸${card.atk}</span> <span style="color:#2ecc71; margin-left:20px;">â¤ï¸${card.currentHp}/${card.maxHp}</span>`;
                if(card.ability === 'ward') skills.innerHTML += `<div class="skill-item"><div class="skill-item-name">ğŸ›¡ï¸ å®ˆè­·</div><div class="skill-item-desc">ç›¸æ‰‹ã¯ã“ã‚Œä»¥å¤–ã‚’æ”»æ’ƒã§ããªã„ã€‚</div></div>`;
                if(card.ability === 'toxic') skills.innerHTML += `<div class="skill-item"><div class="skill-item-name">â˜ ï¸ æ¯’</div><div class="skill-item-desc">ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆãŸæ•µã‚’å³æ­»ã•ã›ã‚‹ã€‚</div></div>`;
                if(card.ability === 'storm') skills.innerHTML += `<div class="skill-item"><div class="skill-item-name">âš¡ ç–¾èµ°</div><div class="skill-item-desc">å‡ºã—ãŸã‚¿ãƒ¼ãƒ³ã«æ”»æ’ƒã§ãã‚‹ã€‚</div></div>`;
                if(card.ability === 'stealth') skills.innerHTML += `<div class="skill-item"><div class="skill-item-name">ğŸ‘ï¸ æ½œä¼</div><div class="skill-item-desc">æ”»æ’ƒã™ã‚‹ã¾ã§é¸ã°ã‚Œãªã„ã€‚</div></div>`;
                card.skills.forEach(s => {
                    let type = s.type ? s.type : 'é€šå¸¸';
                    skills.innerHTML += `<div class="skill-item"><div class="skill-item-name">${s.name} (å¨åŠ›:${s.power})</div><div class="skill-item-desc">${s.desc}</div></div>`;
                });
            }
        }
        function hideDetail() { document.getElementById('card-detail-panel').style.display = 'none'; }

        function renderCards(id, cards, type, isPlayer) {
            const el = document.getElementById(id); el.innerHTML = '';
            cards.forEach(c => {
                const div = document.createElement('div'); div.className = 'card';
                div.setAttribute('data-rarity', c.rarity);
                
                div.onclick = (e) => {
                    e.stopPropagation();
                    if(type === 'hand') onHandClick(c.id);
                    if(type === 'field') onFieldCardClick(c.id, isPlayer);
                };

                if(type === 'hand' && gs.selectedHandIds.includes(c.id)) div.classList.add('selected');
                if(type === 'field' && c.canAttack && isPlayer) div.classList.add('can-attack');
                if(type === 'field' && !isPlayer && gs.attackingUnit && c.ability !== 'stealth') {
                    const hasWard = gs.enemy.field.some(u => u.ability === 'ward' && u.ability !== 'stealth');
                    if(!hasWard || c.ability === 'ward') div.classList.add('valid-target');
                }
                
                let content = '';
                if(c.type === 'element') {
                    content = `<div class="card-art ${c.artClass}">${c.symbol}</div><div class="card-info"><div class="card-symbol">${c.symbol}</div><div class="card-name">${c.name}</div></div>`;
                } else {
                    let badges = `<div class="ability-container">`;
                    if(c.ability === 'ward') badges += `<div class="badge badge-ward">ğŸ›¡ï¸</div>`;
                    if(c.ability === 'toxic') badges += `<div class="badge badge-toxic">â˜ ï¸</div>`;
                    if(c.ability === 'storm') badges += `<div class="badge badge-storm">âš¡</div>`;
                    if(c.ability === 'stealth') badges += `<div class="badge badge-stealth">ğŸ‘ï¸</div>`;
                    badges += `</div>`;
                    content = `${badges}<div class="card-art ${c.artClass}">${c.symbol}</div><div class="card-info"><div class="card-symbol" style="color:var(--primary)">${c.symbol}</div><div class="card-name">${c.name}</div><div class="stats"><div class="stat-box stat-atk">âš”ï¸${c.atk}</div><div class="stat-box stat-hp">â¤ï¸${c.currentHp}</div></div></div>`;
                }
                div.innerHTML = content;
                el.appendChild(div);
            });
        }

        function updateHint() {
            const list = document.getElementById('craftable-list'); list.innerHTML = '';
            if(!gs.isPlayerTurn) return;
            gs.playerRecipes.forEach(r => {
                const handSym = gs.player.hand.map(c => c.symbol);
                let possible = true;
                for(const ing of r.ingredients) {
                    const idx = handSym.indexOf(ing);
                    if(idx === -1) { possible = false; break; }
                    handSym.splice(idx, 1);
                }
                if(possible) {
                    const btn = document.createElement('div'); btn.className = 'craft-hint-btn';
                    let badges = '';
                    if(r.product.ability === 'ward') badges += 'ğŸ›¡ï¸';
                    if(r.product.ability === 'toxic') badges += 'â˜ ï¸';
                    if(r.product.ability === 'storm') badges += 'âš¡';
                    btn.innerHTML = `<div style="font-size:12px; font-weight:bold; color:var(--accent);">âœ¨ ${r.product.name}</div><div style="font-size:10px; display:flex; gap:5px; margin-top:2px;"><span style="color:#e67e22;">âš”ï¸${r.product.atk}</span><span style="color:var(--success);">â¤ï¸${r.product.hp}</span><span>${badges}</span></div>`;
                    btn.onclick = () => autoSelect(r.ingredients);
                    list.appendChild(btn);
                }
            });
        }
        function autoSelect(ingredients) {
            gs.selectedHandIds = []; const tempHand = [...gs.player.hand];
            ingredients.forEach(ing => {
                const idx = tempHand.findIndex(c => c.symbol === ing);
                if(idx !== -1) { gs.selectedHandIds.push(tempHand[idx].id); tempHand.splice(idx, 1); }
            });
            updateView();
        }
        function showMessage(txt, time=1500) { const box = document.getElementById('msg-box'); box.innerText = txt; box.style.opacity = 1; setTimeout(() => box.style.opacity = 0, time); }

        function createConfetti() {
            const container = document.getElementById('confetti-container');
            if(!container) return;
            container.innerHTML = '';
            for(let i=0; i<50; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.style.left = Math.random()*100 + 'vw';
                c.style.backgroundColor = `hsl(${Math.random()*360}, 100%, 50%)`;
                c.style.animationDuration = (Math.random()*3 + 2) + 's';
                container.appendChild(c);
            }
        }

    </script>
</body>
</html>
