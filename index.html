<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chem-Verse: Ultimate</title>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #1a1a1d; --accent: #f1c40f; --primary: #3498db; --danger: #e74c3c; --success: #2ecc71;
            --card-bg: #222; --card-frame: #bdc3c7;
            --rare-n: #95a5a6; --rare-r: #3498db; --rare-sr: #9b59b6; --rare-ssr: #f1c40f;
        }
        body { font-family:'M PLUS Rounded 1c', sans-serif; background:var(--bg-color); color:white; margin:0; user-select:none; overflow:hidden; height:100vh; width:100vw; -webkit-tap-highlight-color:transparent; }
        
        /* --- ç”»é¢åˆ¶å¾¡ --- */
        .screen { position:absolute; top:0; left:0; width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; background:linear-gradient(135deg,#0f0c29,#302b63,#24243e); z-index:100; transition:0.3s; }
        .hidden { display:none!important; opacity:0; pointer-events:none; }
        .scrollable { overflow-y:auto; -webkit-overflow-scrolling:touch; justify-content:flex-start; padding:20px; }

        /* --- CSSã‚¢ãƒ¼ãƒˆ (ã‚¤ãƒ©ã‚¹ãƒˆ) --- */
        .art-frame { width:100%; height:100%; position:relative; overflow:hidden; display:flex; justify-content:center; align-items:center; background:#111; }
        .art-gas { background:linear-gradient(to tr,#89f7fe,#66a6ff); } .art-gas::after { content:'â˜ï¸'; font-size:24px; filter:drop-shadow(0 0 5px white); animation:float 3s infinite; }
        .art-liq { background:linear-gradient(to b,#4facfe,#00f2fe); } .art-liq::after { content:'ğŸ’§'; font-size:24px; animation:bounce 2s infinite; }
        .art-sol { background:linear-gradient(to b,#e6b980,#eacda3); } .art-sol::after { content:'ğŸª¨'; font-size:24px; }
        .art-met { background:linear-gradient(135deg,#bdc3c7,#2c3e50); } .art-met::after { content:'âœ¨'; font-size:24px; text-shadow:0 0 5px white; }
        .art-tox { background:linear-gradient(to b,#f093fb,#f5576c); } .art-tox::after { content:'â˜ ï¸'; font-size:24px; filter:drop-shadow(0 0 5px purple); }
        .art-fir { background:linear-gradient(to t,#e74c3c,#f1c40f); } .art-fir::after { content:'ğŸ”¥'; font-size:24px; animation:bounce 0.5s infinite; }
        .art-gol { background:radial-gradient(circle,#ffd700,#b8860b); } .art-gol::after { content:'ğŸ’'; font-size:24px; filter:drop-shadow(0 0 5px gold); }
        /* å€‹åˆ¥ã‚¢ãƒ¼ãƒˆ */
        .art-H { background:linear-gradient(to t,#a1c4fd,#c2e9fb); } .art-H::after{ content:'(â€¢Ï‰â€¢)'; font-size:10px; background:white; color:#333; padding:2px; border-radius:10px; }
        .art-Au { background:radial-gradient(circle,#ffd700,#b8860b); } .art-Au::after{ content:'ğŸ’°'; font-size:24px; }
        @keyframes float { 50%{transform:translateY(-5px);} } @keyframes bounce { 50%{transform:scale(1.1);} }

        /* --- ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ --- */
        .card {
            width:75px; height:110px; background:var(--card-bg); border-radius:6px;
            border:2px solid var(--card-frame); box-shadow:0 4px 8px rgba(0,0,0,0.5);
            display:flex; flex-direction:column; padding:2px; position:relative; flex-shrink:0; margin:2px;
            transition:transform 0.1s;
        }
        /* ãƒ¬ã‚¢ãƒªãƒ†ã‚£æ¼”å‡º */
        .card[data-r="N"] { border-color:var(--rare-n); } 
        .card[data-r="R"] { border-color:var(--rare-r); box-shadow:0 0 5px var(--rare-r); }
        .card[data-r="SR"] { border-color:var(--rare-sr); box-shadow:0 0 8px var(--rare-sr); background:linear-gradient(135deg,#2c3e50,#4a235a); }
        .card[data-r="SSR"] { border-color:var(--rare-ssr); box-shadow:0 0 10px var(--rare-ssr); background:linear-gradient(135deg,#f1c40f,#e67e22); animation:holo 3s infinite linear; }
        @keyframes holo { 0%{filter:brightness(1);} 50%{filter:brightness(1.2);} 100%{filter:brightness(1);} }

        .c-head { display:flex; justify-content:space-between; font-size:8px; font-weight:bold; color:#eee; margin-bottom:1px; padding:0 2px; }
        .c-art-box { width:100%; height:55px; border:1px solid #555; border-radius:2px; overflow:hidden; margin-bottom:1px; position:relative; }
        .c-text { flex-grow:1; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); font-size:7px; padding:2px; color:#ddd; overflow:hidden; line-height:1.2; display:flex; align-items:center; justify-content:center; text-align:center;}
        .c-stats { position:absolute; bottom:2px; width:94%; display:flex; justify-content:space-between; font-weight:900; font-size:9px; left:3%; }
        .st-a { background:#e67e22; padding:0 3px; border-radius:3px; border:1px solid #fff; }
        .st-h { background:#27ae60; padding:0 3px; border-radius:3px; border:1px solid #fff; }
        
        .badges { position:absolute; top:20px; right:2px; display:flex; flex-direction:column; gap:1px; z-index:5; }
        .bdg { width:12px; height:12px; border-radius:50%; font-size:8px; display:flex; align-items:center; justify-content:center; border:1px solid white; }
        .bdg-w { background:var(--primary); } .bdg-t { background:#8e44ad; } .bdg-s { background:var(--accent); } .bdg-st { background:var(--rare-n); }

        .card.selected { transform:translateY(-15px) scale(1.1); border-color:var(--accent); z-index:100; box-shadow:0 0 15px var(--accent); }
        .card.can-attack { border-color:var(--success); box-shadow:0 0 10px var(--success); }
        .card.attacking { border-color:var(--danger); transform:scale(1.2); z-index:200; box-shadow:0 0 20px var(--danger); }
        .valid-target { animation:pulse 0.8s infinite; border-color:var(--danger)!important; }
        @keyframes pulse { 50%{opacity:0.6;} }

        /* --- ç”»é¢è¦ç´  --- */
        #title-screen { background:radial-gradient(circle at center,#2c3e50,#000); }
        .logo { font-family:'Orbitron'; font-size:40px; color:var(--accent); text-shadow:0 0 15px var(--accent); margin-bottom:10px; text-align:center; }
        .menu-btn { background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.3); color:white; padding:15px 40px; border-radius:30px; font-weight:bold; margin:10px; cursor:pointer; width:200px; text-align:center; }
        .menu-btn.primary { background:linear-gradient(90deg,var(--primary),#2980b9); border:none; }
        
        .d-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; padding-bottom:60px; width:100%; max-width:600px; }
        .d-card { background:rgba(255,255,255,0.1); padding:15px; border-radius:10px; cursor:pointer; min-height:80px; border:1px solid #555; }
        .back-btn { position:fixed; bottom:20px; background:#333; padding:10px 30px; border-radius:20px; cursor:pointer; z-index:200; }

        #board { display:none; flex-direction:column; height:100vh; background:#111; position:relative; }
        #info { height:12%; background:#222; display:flex; justify-content:space-between; align-items:center; padding:0 10px; border-y:1px solid #333; }
        .area { display:flex; justify-content:center; align-items:center; }
        #e-hand { height:8%; background:rgba(0,0,0,0.3); } #e-field { height:24%; border-bottom:2px solid #333; }
        #p-field { height:24%; border-top:2px solid #333; } #p-hand { height:32%; background:rgba(0,0,0,0.2); overflow-x:auto; justify-content:flex-start; padding:0 10px; gap:5px;}
        
        .ldr { text-align:center; } .hp { width:35px; height:35px; border-radius:50%; background:#c0392b; border:2px solid white; line-height:35px; font-weight:bold; margin:0 auto; font-size:14px; }
        .acts { position:absolute; bottom:34%; right:10px; display:flex; flex-direction:column; gap:10px; z-index:50; }
        .g-btn { padding:12px 16px; border-radius:20px; border:none; font-weight:bold; color:white; font-size:12px; box-shadow:0 4px 5px rgba(0,0,0,0.5); cursor:pointer; }
        #cancel-btn { display:none; position:absolute; top:60%; left:50%; transform:translate(-50%,-50%); background:var(--danger); color:white; padding:10px 20px; border-radius:20px; font-weight:bold; z-index:200; cursor:pointer; }

        /* å›³é‘‘ */
        #lib-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(80px, 1fr)); gap:10px; width:100%; max-width:800px; padding-bottom:60px; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«é¡ */
        #msg-box { position:absolute; top:40%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.9); padding:15px 30px; border-radius:10px; border:2px solid white; font-size:20px; font-weight:bold; pointer-events:none; opacity:0; transition:0.3s; z-index:5000; white-space:nowrap; }
        
        #det-pan { position:absolute; top:10%; left:50%; transform:translateX(-50%); width:85%; max-width:300px; background:rgba(20,20,30,0.98); border:2px solid var(--accent); border-radius:12px; padding:20px; display:none; flex-direction:column; z-index:3000; box-shadow:0 0 40px black; }
        .big-art { width:100%; height:150px; border:2px solid #555; border-radius:8px; margin:10px 0; }
        
        #skill-modal { display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:4000; flex-direction:column; justify-content:center; align-items:center; padding:20px; box-sizing:border-box; }
        .sk-btn { background:white; color:#333; padding:15px; width:100%; max-width:300px; margin-bottom:10px; border-radius:8px; font-weight:bold; cursor:pointer; border-left:5px solid var(--primary); }
        
        #res-scr { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:6000; display:flex; flex-direction:column; align-items:center; justify-content:center; display:none; }
        .res-tit { font-size:40px; font-weight:bold; font-family:'Orbitron'; margin-bottom:20px; }
        
        #craft-list { position:absolute; bottom:36%; left:10px; display:flex; flex-direction:column; gap:5px; z-index:40; pointer-events:none; }
        .craft-btn { background:rgba(0,0,0,0.9); border:1px solid var(--accent); padding:5px 10px; border-radius:5px; pointer-events:auto; font-size:12px; color:white; cursor:pointer; }
    </style>
</head>
<body>

<div id="title-screen" class="screen">
    <div class="logo">CHEM-VERSE</div>
    <div class="menu-btn primary" onclick="showDeck()">CPUå¯¾æˆ¦</div>
    <div class="menu-btn" onclick="showLib()">ã‚«ãƒ¼ãƒ‰å›³é‘‘</div>
    <div class="menu-btn disabled" style="opacity:0.5">å¯¾äººæˆ¦ (æº–å‚™ä¸­)</div>
</div>

<div id="deck-screen" class="screen hidden scrollable">
    <h2 style="text-align:center; color:var(--accent)">ãƒ‡ãƒƒã‚­é¸æŠ</h2>
    <div class="d-grid" id="d-grid"></div>
    <div class="back-btn" onclick="showTitle()">æˆ»ã‚‹</div>
</div>

<div id="lib-screen" class="screen hidden scrollable">
    <h2 style="text-align:center; color:var(--primary)">ã‚«ãƒ¼ãƒ‰å›³é‘‘</h2>
    <div id="lib-grid"></div>
    <div class="back-btn" onclick="showTitle()">æˆ»ã‚‹</div>
</div>

<div id="board">
    <div id="e-hand" class="area"></div>
    <div id="e-field" class="area"></div>
    <div id="info">
        <div class="ldr" onclick="atkLdr('enemy')"><div style="font-size:20px">ğŸ¤–</div><div class="hp" id="e-hp">25</div></div>
        <div style="text-align:center">
            <div id="turn" style="font-size:10px;color:#aaa">TURN 1</div>
            <div id="mp" style="font-size:14px;font-weight:bold;color:var(--success)">MP 1/1</div>
        </div>
        <button id="end-btn" style="padding:5px 15px;border-radius:15px;border:none;background:#e67e22;color:white;font-weight:bold" onclick="endTurn()">çµ‚äº†</button>
        <div class="ldr" onclick="atkLdr('player')"><div id="p-hp" class="hp">25</div><div style="font-size:20px">ğŸ§‘â€ğŸ”¬</div></div>
    </div>
    <div id="craft-list"></div>
    <div id="p-field" class="area"></div>
    <div id="p-hand"></div>
    
    <div id="cancel-btn" onclick="cancelAtk()">âŒ æ”»æ’ƒã‚­ãƒ£ãƒ³ã‚»ãƒ«</div>
</div>

<div class="acts" id="acts" style="display:none">
    <button class="g-btn" style="background:linear-gradient(to r,#27ae60,#2ecc71)" onclick="actDraw()">ï¼‹ ãƒ‰ãƒ­ãƒ¼</button>
    <button class="g-btn" style="background:linear-gradient(to r,#e67e22,#f1c40f)" onclick="actSyn()">âš—ï¸ åˆæˆ</button>
</div>

<div id="det-pan" onclick="this.style.display='none'">
    <div style="text-align:right;font-size:20px">Ã—</div>
    <div style="text-align:center">
        <span id="dt-sym" style="font-size:30px;font-weight:bold;color:var(--primary)"></span>
        <span id="dt-name" style="font-size:18px;font-weight:bold;margin-left:10px"></span>
    </div>
    <div class="art-frame big-art"><div id="dt-art" class="css-art"></div></div>
    <div id="dt-st" style="display:flex;justify-content:center;gap:20px;font-size:18px;font-weight:bold"></div>
    <div id="dt-desc" style="font-size:12px;color:#ccc;margin-top:10px;max-height:100px;overflow-y:auto"></div>
    <div style="text-align:center;margin-top:10px;font-size:10px;color:#666">(ã‚¿ãƒƒãƒ—ã—ã¦é–‰ã˜ã‚‹)</div>
</div>

<div id="skill-modal">
    <h3>æŠ€ã‚’é¸æŠ</h3>
    <div id="sk-list"></div>
    <button class="menu-btn" style="background:#777;width:auto;padding:10px 20px" onclick="document.getElementById('skill-modal').style.display='none';cancelAtk()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
</div>

<div id="res-scr">
    <div class="res-tit" id="res-tit">VICTORY</div>
    <div class="menu-btn" onclick="showTitle()">ã‚¿ã‚¤ãƒˆãƒ«ã¸</div>
</div>

<div id="msg-box"></div>
<script>
// --- ãƒ‡ãƒ¼ã‚¿ ---
const EL = {
    H:{s:'H',n:'æ°´ç´ ',r:'N',c:'art-fir'}, He:{s:'He',n:'ãƒ˜ãƒªã‚¦ãƒ ',r:'SR',c:'art-gas'}, Li:{s:'Li',n:'ãƒªãƒã‚¦ãƒ ',r:'R',c:'art-met'},
    C:{s:'C',n:'ç‚­ç´ ',r:'N',c:'art-sol'}, N:{s:'N',n:'çª’ç´ ',r:'N',c:'art-gas'}, O:{s:'O',n:'é…¸ç´ ',r:'N',c:'art-gas'},
    F:{s:'F',n:'ãƒ•ãƒƒç´ ',r:'SR',c:'art-tox'}, Ne:{s:'Ne',n:'ãƒã‚ªãƒ³',r:'SR',c:'art-gas'}, Na:{s:'Na',n:'ãƒŠãƒˆãƒªã‚¦ãƒ ',r:'N',c:'art-met'},
    Mg:{s:'Mg',n:'ãƒã‚°ãƒã‚·ã‚¦ãƒ ',r:'R',c:'art-met'}, Al:{s:'Al',n:'ã‚¢ãƒ«ãƒŸãƒ‹ã‚¦ãƒ ',r:'R',c:'art-met'}, Si:{s:'Si',n:'ã‚±ã‚¤ç´ ',r:'R',c:'art-sol'},
    P:{s:'P',n:'ãƒªãƒ³',r:'R',c:'art-sol'}, S:{s:'S',n:'ç¡«é»„',r:'R',c:'art-sol'}, Cl:{s:'Cl',n:'å¡©ç´ ',r:'N',c:'art-tox'},
    Ar:{s:'Ar',n:'ã‚¢ãƒ«ã‚´ãƒ³',r:'SR',c:'art-gas'}, K:{s:'K',n:'ã‚«ãƒªã‚¦ãƒ ',r:'N',c:'art-met'}, Ca:{s:'Ca',n:'ã‚«ãƒ«ã‚·ã‚¦ãƒ ',r:'R',c:'art-met'},
    Fe:{s:'Fe',n:'é‰„',r:'N',c:'art-met'}, Cu:{s:'Cu',n:'éŠ…',r:'N',c:'art-met'}, Zn:{s:'Zn',n:'äºœé‰›',r:'R',c:'art-met'},
    Ag:{s:'Ag',n:'éŠ€',r:'SR',c:'art-met'}, Cd:{s:'Cd',n:'ã‚«ãƒ‰ãƒŸã‚¦ãƒ ',r:'R',c:'art-tox'}, Au:{s:'Au',n:'é‡‘',r:'SSR',c:'art-gol'},
    Hg:{s:'Hg',n:'æ°´éŠ€',r:'SR',c:'art-liq'}, Pt:{s:'Pt',n:'ãƒ—ãƒ©ãƒãƒŠ',r:'SSR',c:'art-met'}, W:{s:'W',n:'ã‚¿ãƒ³ã‚°ã‚¹ãƒ†ãƒ³',r:'SSR',c:'art-met'},
    Ti:{s:'Ti',n:'ãƒã‚¿ãƒ³',r:'SR',c:'art-met'}, Cr:{s:'Cr',n:'ã‚¯ãƒ­ãƒ ',r:'SR',c:'art-met'}, Mn:{s:'Mn',n:'ãƒãƒ³ã‚¬ãƒ³',r:'R',c:'art-met'},
    Sn:{s:'Sn',n:'ã‚¹ã‚º',r:'R',c:'art-met'}, Ba:{s:'Ba',n:'ãƒãƒªã‚¦ãƒ ',r:'R',c:'art-met'}, Pb:{s:'Pb',n:'é‰›',r:'R',c:'art-met'}
};

const REC = [
    {i:['H','Cl'],p:{s:'HCl',n:'å¡©åŒ–æ°´ç´ ',r:'R',a:5,h:1,c:'art-tox',sk:[{n:'å¼·é…¸',p:5,d:'é«˜ç«åŠ›'}]}},
    {i:['H','F'],p:{s:'HF',n:'ãƒ•ãƒƒåŒ–æ°´ç´ ',r:'SR',a:4,h:2,ab:'tox',c:'art-tox',sk:[{n:'çŒ›æ¯’',p:0,t:'tox',d:'å¿…æ®º'}]}},
    {i:['Na','H'],p:{s:'NaH',n:'æ°´ç´ åŒ–Na',r:'R',a:3,h:1,ab:'stm',c:'art-sol',sk:[{n:'é‚„å…ƒ',p:3,d:'ç–¾èµ°'}]}},
    {i:['H','H','O'],p:{s:'H2O',n:'æ°´',r:'N',a:1,h:4,c:'art-liq',sk:[{n:'åŠ æ°´åˆ†è§£',p:3,t:'heal',d:'å›å¾©'}]}},
    {i:['Ag','Cl'],p:{s:'AgCl',n:'å¡©åŒ–éŠ€',r:'SR',a:1,h:6,ab:'wrd',c:'art-sol',sk:[{n:'æ²ˆæ®¿',p:0,t:'grd',d:'å®ˆè­·'}]}},
    {i:['Fe','O'],p:{s:'FeO',n:'é…¸åŒ–é‰„',r:'N',a:3,h:5,c:'art-sol',sk:[{n:'é»’éŒ†',p:3,d:'é€šå¸¸'}]}},
    {i:['Fe','O','O'],p:{s:'Fe2O3',n:'èµ¤éŒ†',r:'R',a:2,h:8,ab:'wrd',c:'art-sol',sk:[{n:'ä¸å‹•æ…‹',p:2,d:'é«˜è€ä¹…'}]}},
    {i:['C','O'],p:{s:'CO',n:'ä¸€é…¸åŒ–ç‚­ç´ ',r:'R',a:1,h:2,ab:'tox',c:'art-gas',sk:[{n:'çµåˆ',p:0,t:'tox',d:'å¿…æ®º'}]}},
    {i:['H','S'],p:{s:'H2S',n:'ç¡«åŒ–æ°´ç´ ',r:'R',a:2,h:3,ab:'tox',c:'art-gas',sk:[{n:'ç¡«åŒ–',p:0,t:'tox',d:'å¿…æ®º'}]}},
    {i:['Cl','Cl'],p:{s:'Cl2',n:'å¡©ç´ ã‚¬ã‚¹',r:'R',a:3,h:3,c:'art-gas',sk:[{n:'æ•£å¸ƒ',p:2,t:'aoe',d:'å…¨ä½“2ãƒ€ãƒ¡'}]}},
    {i:['S','O','O'],p:{s:'SO2',n:'äºŒé…¸åŒ–ç¡«é»„',r:'N',a:2,h:4,c:'art-gas',sk:[{n:'é…¸æ€§é›¨',p:1,t:'aoe',d:'å…¨ä½“1ãƒ€ãƒ¡'}]}},
    {i:['Na','O','H'],p:{s:'NaOH',n:'æ°´é…¸åŒ–Na',r:'R',a:3,h:3,c:'art-sol',sk:[{n:'ä¸­å’Œç†±',p:2,t:'ah',d:'å…¨ä½“2ãƒ€ãƒ¡/å›å¾©'}]}},
    {i:['Al','O','O'],p:{s:'Al2O3',n:'ã‚¢ãƒ«ãƒŸãƒŠ',r:'R',a:2,h:7,ab:'wrd',c:'art-sol',sk:[{n:'è¢«è†œ',p:2,d:'å®ˆè­·'}]}},
    {i:['C','C','C'],p:{s:'Diamond',n:'ãƒ€ã‚¤ãƒ¤',r:'SSR',a:4,h:10,ab:'wrd',c:'art-gol',sk:[{n:'ç¡¬åº¦10',p:4,d:'é‰„å£'}]}},
    {i:['Au'],p:{s:'Au',n:'é‡‘',r:'SSR',a:6,h:6,c:'art-gol',sk:[{n:'è¼ã',p:6,d:'é«˜ç«åŠ›'}]}},
    {i:['He','He'],p:{s:'He',n:'ãƒ˜ãƒªã‚¦ãƒ ',r:'SR',a:2,h:2,ab:'stl',c:'art-gas',sk:[{n:'ä¸æ´»æ€§',p:2,d:'æ½œä¼'}]}},
    {i:['H','Cl','N','O','O','O'],p:{s:'AquaRegia',n:'ç‹æ°´',r:'SSR',a:0,h:0,tp:'spl',c:'art-liq',sk:[{n:'æº¶è§£',p:99,t:'tox',d:'é™¤å»'}]}},
    {i:['Cu','O'],p:{s:'CuO',n:'é…¸åŒ–éŠ…',r:'N',a:3,h:4,c:'art-sol',sk:[{n:'é»’ç²‰',p:3,d:'æ”»æ’ƒ'}]}},
    {i:['Zn','Cu'],p:{s:'Brass',n:'é»„éŠ…',r:'R',a:4,h:5,c:'art-met',sk:[{n:'åˆé‡‘',p:4,d:'æ”»æ’ƒ'}]}},
    {i:['Hg','Zn'],p:{s:'Amalgam',n:'ã‚¢ãƒãƒ«ã‚¬ãƒ ',r:'SR',a:3,h:6,ab:'wrd',c:'art-liq',sk:[{n:'åˆé‡‘åŒ–',p:3,d:'å®ˆè­·'}]}},
    {i:['Cd','S'],p:{s:'CdS',n:'ç¡«åŒ–Cd',r:'SR',a:2,h:5,ab:'tox',c:'art-tox',sk:[{n:'ã‚¤ã‚¿ã‚¤ã‚¤ã‚¿ã‚¤',p:0,t:'tox',d:'çŒ›æ¯’'}]}},
    {i:['Cl','Na'],p:{s:'NaCl',n:'å¡©åŒ–Na',r:'N',a:3,h:4,c:'art-sol',sk:[{n:'å¡©å‘³',p:3,d:'é€šå¸¸'}]}},
    {i:['Ca','O','H','H'],p:{s:'Ca(OH)2',n:'æ¶ˆçŸ³ç°',r:'N',a:1,h:6,ab:'wrd',c:'art-sol',sk:[{n:'ä¸­å’Œ',p:4,t:'heal',d:'å›å¾©'}]}},
    {i:['Al','O','O','Cr'],p:{s:'Ruby',n:'ãƒ«ãƒ“ãƒ¼',r:'SR',a:5,h:8,c:'art-sol',sk:[{n:'æ·±ç´…',p:5,d:'æ”»æ’ƒ'}]}},
    {i:['Al','O','Ti'],p:{s:'Sapphire',n:'ã‚µãƒ•ã‚¡ã‚¤ã‚¢',r:'SR',a:4,h:9,c:'art-sol',sk:[{n:'é’ç‰',p:4,d:'æ”»æ’ƒ'}]}},
    {i:['Si','O','O'],p:{s:'SiO2',n:'çŸ³è‹±',r:'N',a:3,h:6,c:'art-sol',sk:[{n:'çµæ™¶',p:2,t:'aoe',d:'å…¨ä½“2ãƒ€ãƒ¡'}]}},
    {i:['Pt'],p:{s:'Pt',n:'ãƒ—ãƒ©ãƒãƒŠ',r:'SSR',a:5,h:7,c:'art-met',sk:[{n:'è§¦åª’',p:5,d:'æ”»æ’ƒ'}]}},
    {i:['W'],p:{s:'W',n:'ã‚¿ãƒ³ã‚°ã‚¹ãƒ†ãƒ³',r:'SSR',a:7,h:8,ab:'wrd',c:'art-met',sk:[{n:'èç‚¹',p:7,d:'æ”»æ’ƒ'}]}},
    {i:['Ti'],p:{s:'Ti',n:'ãƒã‚¿ãƒ³',r:'SR',a:4,h:5,c:'art-met',sk:[{n:'å¼·åº¦',p:4,d:'æ”»æ’ƒ'}]}},
    {i:['Ne','Ne'],p:{s:'Ne',n:'ãƒã‚ªãƒ³',r:'SR',a:3,h:3,ab:'stl',c:'art-gas',sk:[{n:'ç™ºå…‰',p:3,d:'æ½œä¼'}]}},
    {i:['Ar','Ar'],p:{s:'Ar',n:'ã‚¢ãƒ«ã‚´ãƒ³',r:'SR',a:4,h:4,ab:'stl',c:'art-gas',sk:[{n:'ä¿è­·',p:4,d:'æ½œä¼'}]}},
    {i:['H','H','S','O','O','O','O'],p:{s:'H2SO4',n:'æ¿ƒç¡«é…¸',r:'SR',a:0,h:0,tp:'spl',c:'art-liq',sk:[{n:'è„±æ°´',p:5,t:'aoe',d:'å…¨ä½“5ãƒ€ãƒ¡'}]}},
    {i:['K','Mn','O','O','O','O'],p:{s:'KMnO4',n:'éãƒãƒ³ã‚¬ãƒ³é…¸K',r:'SR',a:0,h:0,tp:'spl',c:'art-sol',sk:[{n:'é…¸åŒ–',p:7,t:'dmg',d:'7ãƒ€ãƒ¡'}]}}
];

const DECKS = {
    aggro:{n:'è¶…é€Ÿæ”»',d:'é«˜ç«åŠ›ãƒ»ä½è€ä¹…',e:['H','H','Cl','F','Na','O'],r:['HCl','HF','NaH','H2O']},
    counter:{n:'ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼',d:'å®ˆã£ã¦åæ’ƒ',e:['Ag','Cl','Fe','O','Cu','Zn','Hg'],r:['AgCl','FeO','Fe2O3','Brass','Amalgam','CuO']},
    toxic:{n:'å®³æ‚ª',d:'å¿…æ®ºã§å³æ­»',e:['C','O','S','H','Cl','Cd'],r:['CO','H2S','Cl2','SO2','CdS']},
    control:{n:'ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«',d:'å›å¾©ã¨æ”¯é…',e:['Al','O','H','Na','Cl','Ca'],r:['Al2O3','NaOH','H2O','NaCl','Ca(OH)2']},
    gemstone:{n:'å®çŸ³',d:'æœ€å¼·ã®ç¡¬åº¦',e:['C','C','C','Al','O','Si','Cr','Ti'],r:['Diamond','Ruby','Sapphire','SiO2']},
    heavy:{n:'é‡é‡‘å±',d:'å¾ŒåŠæœ€å¼·',e:['Au','Pt','W','Ti'],r:['Au','Pt','W','Ti']},
    noble:{n:'è²´ã‚¬ã‚¹',d:'æ½œä¼æ”»æ’ƒ',e:['He','He','Ne','Ne','Ar','Ar'],r:['He','Ne','Ar']},
    hazard:{n:'å±é™ºç‰©',d:'é™¤å»ã‚¹ãƒšãƒ«',e:['H','Cl','N','O','S','K','Mn'],r:['AquaRegia','H2SO4','KMnO4']}
};

let gs={hp:25,ehp:25,h:[],f:[],eh:[],ef:[],tn:1,mp:1,mmp:1,my:true,sel:[],atk:null};

// --- åˆæœŸåŒ– ---
window.onload = () => {
    const g=document.getElementById('d-grid');
    for(let k in DECKS){
        const d=document.createElement('div'); d.className='deck-card';
        d.innerHTML=`<div style="font-weight:bold;color:var(--accent)">${DECKS[k].n}</div><div style="font-size:10px;color:#ccc">${DECKS[k].d}</div>`;
        d.onclick=()=>startGame(k); g.appendChild(d);
    }
    // å›³é‘‘ç”Ÿæˆ
    const lg=document.getElementById('lib-grid');
    for(let k in ELEM) addLibCard(ELEM[k], 'el');
    REC.forEach(r=>addLibCard(r.p, 'unit'));
};
function addLibCard(d, type){
    const c=createCardUI(d, type==='el');
    c.onclick=()=>showDet(d, type==='el');
    document.getElementById('lib-grid').appendChild(c);
}

function showTitle(){hide();document.getElementById('title-screen').classList.remove('hidden');}
function showDeck(){hide();document.getElementById('deck-select-screen').classList.remove('hidden');}
function showLib(){hide();document.getElementById('lib-screen').classList.remove('hidden');}
function hide(){document.querySelectorAll('.screen').forEach(e=>e.classList.add('hidden'));document.getElementById('board').style.display='none';document.getElementById('acts').style.display='none';document.getElementById('res-scr').style.display='none';}

// --- ã‚²ãƒ¼ãƒ å‡¦ç† ---
function startGame(k){
    gs={hp:25,ehp:25,h:[],f:[],eh:[],ef:[],tn:1,mp:1,mmp:1,my:true,sel:[],atk:null};
    gs.pp=DECKS[k].e.map(x=>ELEM[x]); gs.pr=REC.filter(r=>DECKS[k].r.includes(r.p.s));
    let ek=Object.keys(DECKS)[Math.floor(Math.random()*8)];
    gs.ep=DECKS[ek].e.map(x=>ELEM[x]); gs.er=REC.filter(r=>DECKS[ek].r.includes(r.p.s));
    document.getElementById('enemy-name').innerText=`CPU (${DECKS[ek].n})`;
    hide(); document.getElementById('board').style.display='flex'; document.getElementById('acts').style.display='flex';
    for(let i=0;i<5;i++){draw(true);draw(false);}
    upd(); msg("ãƒãƒˆãƒ«é–‹å§‹ï¼");
}

function draw(isP){
    const p=isP?gs.pp:gs.ep, h=isP?gs.h:gs.eh;
    if(h.length>=10){ if(!isP)h.shift(); else return; }
    h.push({...p[Math.floor(Math.random()*p.length)], id:Math.random(), type:'el'});
}

function actDraw(){ if(!gs.my||gs.mp<1){msg("MPä¸è¶³");return;} gs.mp--; draw(true); upd(); }

function actSyn(){
    if(!gs.my||gs.sel.length<1)return;
    const sl=gs.h.filter(c=>gs.sel.includes(c.id)), sym=sl.map(c=>c.s).sort();
    // 1æšéŒ¬æˆ(é‡‘ãªã©)
    if(gs.sel.length===1){
        const r=gs.pr.find(x=>x.i.length===1 && x.i[0]===sym[0]);
        if(r){ doSyn(r); return; }
    }
    const r=gs.pr.find(x=>JSON.stringify(x.i.sort())===JSON.stringify(sym));
    if(r) doSyn(r); else {msg("åå¿œãªã—");gs.sel=[];upd();}
}

function doSyn(r){
    if(r.p.tp==='spl'){
        gs.h=gs.h.filter(c=>!gs.sel.includes(c.id)); gs.sel=[];
        const s=r.p.sk[0];
        if(gs.ef.length>0){ let t=gs.ef.reduce((a,b)=>a.cur>b.cur?a:b); if(s.t==='tox')t.cur=-99;else t.cur-=s.p; msg(`${s.n}->${t.n}`); }
        else{ gs.ehp-=s.p; msg(`${s.n}->Leader`); }
        chk(); upd(); return;
    }
    if(gs.f.length>=5){msg("æº€å“¡");return;}
    gs.h=gs.h.filter(c=>!gs.sel.includes(c.id)); gs.sel=[];
    gs.f.push({...r.p, id:Math.random(), max:r.p.h, cur:r.p.h, can:r.p.ab==='stm', type:'unit'});
    msg(`å¬å–š:${r.p.n}`); upd();
}

function onHand(id){ if(!gs.my)return; const c=gs.h.find(x=>x.id===id); showDet(c,true); if(gs.sel.includes(id))gs.sel=gs.sel.filter(x=>x!==id);else gs.sel.push(id); upd(); }

function onField(id,isP){
    if(!gs.my)return;
    if(isP){
        const u=gs.f.find(x=>x.id===id); showDet(u,false);
        if(u&&u.can){ gs.atk=u; document.body.classList.add('targeting'); upd(); }
    } else if(gs.atk){
        const t=gs.ef.find(x=>x.id===id);
        if(t.ab==='stl'){msg("æ½œä¼ä¸­");return;}
        prepAtk(gs.atk,t,'unit');
    } else {
        showDet(gs.ef.find(x=>x.id===id),false);
    }
}
function atkLdr(s){ if(s==='enemy'&&gs.atk) prepAtk(gs.atk,'ldr','ldr'); }

function prepAtk(a,t,type){
    if(type==='ldr'||(type==='unit'&&t.ab!=='wrd')){
        if(gs.ef.some(u=>u.ab==='wrd'&&u.ab!=='stl')){msg("å®ˆè­·ã‚ã‚Š");cancelAtk();return;}
    }
    if(a.sk.length>1) openSk(a,t); else exeSk(a,t,a.sk[0]);
}

function openSk(a,t){
    const m=document.getElementById('skill-modal'), l=document.getElementById('sk-list'); l.innerHTML='';
    a.sk.forEach(s=>{
        const b=document.createElement('div'); b.className='sk-btn'; b.innerHTML=`${s.n} (${s.p})`;
        b.onclick=()=>{exeSk(a,t,s);m.style.display='none';}; l.appendChild(b);
    }); m.style.display='flex';
}

function exeSk(a,t,s){
    if(s.t==='aoe'){ gs.ef.forEach(u=>u.cur-=s.p); gs.ehp-=s.p; }
    else if(s.t==='ah'){ gs.ef.forEach(u=>u.cur-=s.p); gs.hp+=s.p; }
    else if(s.t==='heal'){ gs.hp+=s.p; }
    else {
        let d=s.p; if(t==='ldr') gs.ehp-=d;
        else {
            let cnt=t.a; if(s.t==='tox'&&d>0)t.cur=-99; else t.cur-=d;
            if(t.cur<=0&&t.ab==='tox'&&cnt>0)a.cur=-99; else a.cur-=cnt;
        }
    }
    a.can=false; msg(s.n); cancelAtk(); chk(); upd();
}

function chk(){
    gs.f=gs.f.filter(u=>u.cur>0); gs.ef=gs.ef.filter(u=>u.cur>0);
    if(gs.ehp<=0)res(true); else if(gs.hp<=0)res(false);
}
function res(w){
    document.getElementById('res-scr').style.display='flex';
    document.getElementById('res-tit').innerText=w?"VICTORY":"DEFEAT";
    document.getElementById('res-tit').style.color=w?"var(--accent)":"var(--danger)";
}
function cancelAtk(){ gs.atk=null; document.body.classList.remove('targeting'); upd(); }
function endTurn(){ gs.my=false; cancelAtk(); upd(); msg("æ•µã‚¿ãƒ¼ãƒ³"); setTimeout(cpu,1000); }

async function cpu(){
    if(gs.mmp<10)gs.mmp++; gs.mp=gs.mmp; draw(false); upd(); await sleep(500);
    // Syn
    let act=true; while(act&&gs.ef.length<5){ act=false; const h=gs.eh.map(c=>c.s);
        for(let r of gs.er){
            if(r.p.tp==='spl')continue;
            let i=[...r.i], th=[...h], ok=true;
            for(let x of i){ let idx=th.indexOf(x); if(idx<0){ok=false;break;} th.splice(idx,1); }
            if(ok){
                for(let x of r.i){ let idx=gs.eh.findIndex(c=>c.s===x); gs.eh.splice(idx,1); }
                gs.ef.push({...r.p,id:Math.random(),max:r.p.h,cur:r.p.h,can:false,type:'unit'});
                msg("CPUå¬å–š"); upd(); await sleep(800); act=true; break;
            }
        }
    }
    // Atk
    gs.ef.forEach(u=>u.can=true);
    for(let u of gs.ef){
        if(!u.can)continue;
        let t='ldr', grd=gs.f.find(g=>g.ab==='wrd'&&g.ab!=='stl'); if(grd)t=grd;
        if(t==='ldr') gs.hp-=u.sk[0].p;
        else { let d=u.sk[0].p; if(u.sk[0].t==='tox'&&d>0)t.cur=-99;else t.cur-=d; u.cur-=t.a; }
        chk(); upd(); await sleep(800);
    }
    gs.tn++; gs.my=true; gs.f.forEach(u=>u.can=true); draw(true); msg("è‡ªã‚¿ãƒ¼ãƒ³"); upd();
}
const sleep=m=>new Promise(r=>setTimeout(r,m));

// --- æç”» ---
function upd(){
    document.getElementById('turn-disp').innerText=`T${gs.tn}`; document.getElementById('mp-disp').innerText=`MP${gs.mp}/${gs.mmp}`;
    document.getElementById('p-hp').innerText=gs.hp; document.getElementById('e-hp').innerText=gs.ehp;
    document.getElementById('cancel-btn').style.display=gs.atk?'block':'none';
    
    rend(document.getElementById('p-hand'), gs.h, 'h', true);
    rend(document.getElementById('p-field'), gs.f, 'f', true);
    rend(document.getElementById('e-field'), gs.ef, 'f', false);
    const eh=document.getElementById('e-hand'); eh.innerHTML='';
    gs.eh.forEach(()=>{
        const d=document.createElement('div'); d.className='card'; d.style.background='#555'; d.style.width='30px'; d.style.height='45px'; eh.appendChild(d);
    });
    // Hint
    const hl=document.getElementById('craft-list'); hl.innerHTML='';
    if(gs.my) gs.pr.forEach(r=>{
        let h=gs.h.map(c=>c.s), ok=true;
        for(let x of r.i){ let idx=h.indexOf(x); if(idx<0){ok=false;break;} h.splice(idx,1); }
        if(ok){
            const b=document.createElement('div'); b.className='craft-btn'; b.innerText=`âœ¨ ${r.p.n}`;
            b.onclick=()=>{ gs.sel=[]; let th=[...gs.h]; r.i.forEach(x=>{ let idx=th.findIndex(c=>c.s===x); gs.sel.push(th[idx].id); th.splice(idx,1); }); upd(); };
            hl.appendChild(b);
        }
    });
}

function rend(el, l, type, isP){
    el.innerHTML='';
    l.forEach(c=>{
        el.appendChild(createCardUI(c, c.type==='el', type==='h'&&gs.sel.includes(c.id), type==='f'&&c.can&&isP, type==='f'&&!isP&&gs.atk));
    });
}

function createCardUI(c, isEl, isSel, isCan, isTgt){
    const d=document.createElement('div'); d.className='card'; d.setAttribute('data-r', c.r);
    let art=c.c||'art-sol', sym=c.s, nam=c.n;
    let bz='', st='';
    if(!isEl){
        if(c.ab==='wrd') bz+='<div class="bdg bdg-w">ğŸ›¡ï¸</div>'; if(c.ab==='tox') bz+='<div class="bdg bdg-t">â˜ ï¸</div>';
        if(c.ab==='stm') bz+='<div class="bdg bdg-s">âš¡</div>'; if(c.ab==='stl') bz+='<div class="bdg bdg-h">ğŸ‘ï¸</div>';
        st=`<div class="stats"><div class="st-a">âš”ï¸${c.a}</div><div class="st-h">â¤ï¸${c.cur}</div></div>`;
    }
    d.innerHTML=`
        <div class="c-head"><span>${nam}</span><span style="color:var(--primary)">${sym}</span></div>
        <div class="c-art-box"><div class="css-art ${art}"></div></div>
        <div class="c-text">${!isEl && c.sk ? c.sk[0].n : (isEl?'ç´ æ':'')}</div>
        ${!isEl ? `<div class="badges" style="top:25px;right:2px">${bz}</div>` : ''}
        ${st}
    `;
    if(isSel) d.classList.add('selected');
    if(isCan) d.classList.add('can-attack');
    if(isTgt) d.classList.add('valid-target');
    d.onclick=(e)=>{e.stopPropagation(); if(gs.hand.includes(c)) onHand(c.id); else if(gs.field.includes(c)) onField(c.id,true); else if(gs.ef.includes(c)) onField(c.id,false); };
    return d;
}

function showDet(c, isEl){
    const p=document.getElementById('det-pan'); p.style.display='flex';
    document.getElementById('dt-sym').innerText=c.s; document.getElementById('dt-name').innerText=c.n;
    document.getElementById('dt-art').className=`css-art ${c.c||'art-sol'}`;
    const st=document.getElementById('dt-st'), ds=document.getElementById('dt-desc');
    if(isEl){ st.innerText=""; ds.innerText=`ãƒ¬ã‚¢ãƒªãƒ†ã‚£: ${c.r}\nåˆæˆç´ æ`; }
    else{
        st.innerHTML=`âš”ï¸${c.a} <span style="margin-left:15px;color:var(--success)">â¤ï¸${c.cur}/${c.max}</span>`;
        ds.innerHTML=c.sk.map(s=>`<div><b>ã€${s.n}ã€‘</b> ${s.d}</div>`).join('');
    }
}
function msg(t){const b=document.getElementById('msg-box');b.innerText=t;b.style.opacity=1;setTimeout(()=>b.style.opacity=0,1500);}

</script>
</body>
</html>