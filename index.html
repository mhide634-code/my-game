<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chem-Verse: Ultimate</title>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0b1020; --accent: #f1c40f; --primary: #3498db; --danger: #e74c3c; --success: #2ecc71;
            --rare-n: #95a5a6; --rare-r: #3498db; --rare-sr: #9b59b6; --rare-ssr: #f1c40f; --card-white: #fbfeff;
        }
        body { font-family: 'M PLUS Rounded 1c', sans-serif; background: linear-gradient(135deg,#071027,#0b1020); color: white; margin: 0; user-select: none; overflow: hidden; height: 100vh; width: 100vw; -webkit-tap-highlight-color: transparent; }
        
        .screen { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; background: linear-gradient(135deg,#0f0c29,#302b63,#24243e); transition: opacity 0.3s; }
        .hidden { display: none !important; opacity: 0; pointer-events: none; }
        .scrollable { overflow-y: auto; justify-content: flex-start; padding: 20px; }

        /* --- „Çø„Ç§„Éà„É´ --- */
        #title-screen { background: radial-gradient(circle at center,#162235 0%, #07070a 60%); }
        .game-logo { font-family: 'Orbitron', sans-serif; font-size: 44px; color: var(--accent); text-shadow: 0 8px 30px rgba(241,196,15,0.2); margin-bottom: 20px; text-align: center; }
        .menu-container { display: flex; flex-direction: column; gap: 15px; width: 80%; max-width: 300px; }
        .menu-btn { padding: 15px; border-radius: 30px; border: none; font-weight: bold; cursor: pointer; text-align: center; font-size: 16px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); transition: 0.2s; }
        .menu-btn:active { transform: scale(0.95); }
        .btn-p { background: linear-gradient(90deg, #2a7bd6, #3498db); border: none; box-shadow: 0 4px 15px rgba(52,152,219,0.4); }
        .btn-pvp { background: linear-gradient(90deg, #e74c3c, #c0392b); border: none; box-shadow: 0 4px 15px rgba(231,76,60,0.4); }

        /* --- „Éá„ÉÉ„Ç≠ÈÅ∏Êäû --- */
        .deck-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 100%; max-width: 600px; padding-bottom: 80px; }
        .deck-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 15px; border-radius: 12px; cursor: pointer; min-height: 100px; display: flex; flex-direction: column; justify-content: space-between; transition: 0.2s; }
        .deck-card:active { transform: scale(0.98); background: rgba(255,255,255,0.1); }
        .deck-title { font-weight: bold; color: var(--accent); font-size: 16px; }
        .deck-desc { font-size: 11px; color: #aaa; margin-top: 5px; }
        .back-btn { position: fixed; bottom: 20px; background: #333; padding: 10px 30px; border-radius: 20px; z-index: 200; cursor: pointer; }

        /* --- „Ç≤„Éº„É†„Éú„Éº„Éâ --- */
        #game-board { display: none; flex-direction: column; height: 100vh; background: #111; }
        #info-area { height: 12%; background: rgba(30,30,45,0.95); display: flex; justify-content: space-between; align-items: center; padding: 0 10px; z-index: 10; border-top: 1px solid #444; border-bottom: 1px solid #444; }
        .area { display: flex; justify-content: center; align-items: center; }
        #enemy-hand-area { height: 10%; background: rgba(0,0,0,0.3); gap: -10px; } 
        #enemy-field { height: 24%; border-bottom: 2px solid #333; }
        #player-field { height: 24%; border-top: 2px solid #333; } 
        #player-hand-area { height: 30%; background: rgba(0,0,0,0.2); overflow-x: auto; justify-content: flex-start; padding: 0 10px; gap: 5px; align-items: center; display: flex; }

        /* --- „Ç´„Éº„Éâ„Éá„Ç∂„Ç§„É≥ --- */
        .card { width: 85px; height: 125px; background: linear-gradient(180deg, var(--card-white), #f0f6ff); border-radius: 8px; border: 2px solid #777; box-shadow: 0 6px 12px rgba(0,0,0,0.4); display: flex; flex-direction: column; padding: 3px; position: relative; flex-shrink: 0; margin: 2px; transition: transform 0.15s; overflow: hidden; box-sizing: border-box; color: #222; }
        .card[data-rarity="N"] { border-color: var(--rare-n); }
        .card[data-rarity="R"] { border-color: var(--rare-r); box-shadow: 0 0 5px var(--rare-r); }
        .card[data-rarity="SR"] { border-color: var(--rare-sr); box-shadow: 0 0 8px var(--rare-sr); }
        .card[data-rarity="SSR"] { border-color: var(--rare-ssr); box-shadow: 0 0 12px var(--rare-ssr); animation: shine 3s infinite linear; }
        @keyframes shine { 0% { filter: brightness(1); } 50% { filter: brightness(1.2); } 100% { filter: brightness(1); } }

        .c-head { display: flex; justify-content: space-between; align-items: center; padding: 2px 4px; font-size: 9px; font-weight: bold; color: #444; margin-bottom: 2px; }
        .c-art-box { width: 100%; height: 60px; background: #eee; position: relative; border: 1px solid #ccc; border-radius: 4px; overflow: hidden; display: flex; justify-content: center; align-items: center; font-size: 32px; }
        .c-text-box { flex-grow: 1; padding: 2px; font-size: 8px; color: #333; background: rgba(0,0,0,0.03); overflow: hidden; display: flex; align-items: center; justify-content: center; text-align: center; line-height: 1.2; margin-top: 2px; border-radius: 2px; }
        .c-stats { display: flex; justify-content: space-between; font-weight: 900; font-size: 11px; padding: 2px 4px; margin-top: auto; }
        .st-a { color: #d35400; background: #ffe0b2; padding: 0 4px; border-radius: 4px; }
        .st-h { color: #27ae60; background: #c8e6c9; padding: 0 4px; border-radius: 4px; }

        .card.selected { transform: translateY(-20px) scale(1.1); border-color: var(--accent); box-shadow: 0 0 20px var(--accent); z-index: 100; }
        .card.can-attack { border-color: var(--success); box-shadow: 0 0 15px var(--success); }
        .card.attacking { transform: scale(1.2); border-color: var(--danger); box-shadow: 0 0 25px var(--danger); z-index: 200; }
        .valid-target { animation: pulse 0.8s infinite; border-color: var(--danger)!important; box-shadow: inset 0 0 10px var(--danger); }
        @keyframes pulse { 50% { opacity: 0.6; } }

        /* UI„Éë„Éº„ÉÑ */
        .leader { text-align: center; width: 70px; }
        .hp-circle { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; border-radius: 50%; width: 40px; height: 40px; line-height: 40px; font-weight: bold; font-size: 18px; margin: 0 auto; border: 2px solid white; box-shadow: 0 0 10px rgba(231, 76, 60, 0.6); }
        .action-overlay { position: absolute; bottom: 33%; right: 10px; display: flex; flex-direction: column; gap: 10px; z-index: 50; }
        .game-btn { padding: 12px 18px; border-radius: 25px; border: none; font-weight: bold; color: white; font-size: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.4); cursor: pointer; transition: 0.2s; }
        .game-btn:active { transform: scale(0.95); }
        .btn-dr { background: linear-gradient(to right, #27ae60, #2ecc71); } 
        .btn-sy { background: linear-gradient(to right, #f39c12, #f1c40f); color: #222; }
        #btn-end-turn { padding: 6px 15px; background: #e67e22; border-radius: 15px; border: none; color: white; font-weight: bold; cursor: pointer; }
        #cancel-btn { display: none; position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%); background: var(--danger); color: white; padding: 12px 30px; border-radius: 25px; font-weight: bold; z-index: 200; box-shadow: 0 0 20px var(--danger); cursor: pointer; }

        /* „É¢„Éº„ÉÄ„É´ */
        #msg-box { position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); padding: 15px 40px; border-radius: 10px; font-weight: bold; font-size: 24px; pointer-events: none; opacity: 0; transition: 0.3s; z-index: 5000; white-space: nowrap; border: 2px solid white; }
        #turn-change-screen { background: rgba(0,0,0,0.95); z-index: 7000; }
        
        #card-detail-panel { position: absolute; top: 10%; left: 50%; transform: translateX(-50%); width: 85%; max-width: 320px; background: rgba(20,20,30,0.98); border: 2px solid var(--accent); border-radius: 12px; padding: 20px; display: none; flex-direction: column; z-index: 3000; box-shadow: 0 0 50px black; }
        .detail-close { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #aaa; }
        
        #skill-modal { display: none; background: rgba(0,0,0,0.85); z-index: 4000; }
        .sk-btn { background: white; color: #333; padding: 15px; width: 80%; max-width: 300px; margin-bottom: 10px; border-radius: 8px; font-weight: bold; cursor: pointer; border-left: 6px solid var(--primary); }
        
        #res-scr { background: rgba(0,0,0,0.95); z-index: 6000; }
        .res-tit { font-size: 48px; font-weight: bold; font-family: 'Orbitron'; margin-bottom: 20px; }
        .res-win { color: var(--accent); text-shadow: 0 0 20px var(--accent); } 
        .res-lose { color: var(--danger); text-shadow: 0 0 20px var(--danger); }
        .confetti { position: absolute; width: 10px; height: 10px; background: #f00; animation: fall linear forwards; }
        @keyframes fall { to { transform: translateY(110vh) rotate(720deg); } }

        #craft-list { position: absolute; bottom: 38%; left: 10px; display: flex; flex-direction: column; gap: 6px; z-index: 40; pointer-events: none; }
        .craft-btn { background: rgba(0,0,0,0.9); border: 1px solid var(--accent); padding: 8px 12px; border-radius: 6px; pointer-events: auto; font-size: 12px; color: white; cursor: pointer; box-shadow: 0 0 8px var(--accent); }
    </style>
</head>
<body>

    <div id="title-screen" class="screen">
        <div id="particles"></div>
        <div class="logo">CHEM-VERSE</div>
        <div class="menu-container">
            <button class="menu-btn btn-p" onclick="showDeckSelect('cpu')">CPUÂØæÊà¶</button>
            <button class="menu-btn btn-pvp" onclick="showDeckSelect('hotseat')">ÂØæ‰∫∫Êà¶ (2P)</button>
            <button class="menu-btn" onclick="showLib()">„Ç´„Éº„ÉâÂõ≥Èëë</button>
        </div>
    </div>

    <div id="deck-select-screen" class="screen hidden scrollable">
        <h2 style="text-align:center; color:var(--accent); margin-bottom:20px;">„Éá„ÉÉ„Ç≠ÈÅ∏Êäû</h2>
        <div class="deck-grid" id="deck-grid-container"></div>
        <div class="back-btn" onclick="showTitle()">Êàª„Çã</div>
    </div>

    <div id="lib-screen" class="screen hidden scrollable">
        <h2 style="text-align:center; color:var(--primary); margin-bottom:20px;">„Ç´„Éº„ÉâÂõ≥Èëë</h2>
        <div class="deck-grid" id="lib-grid" style="display:flex; flex-wrap:wrap; justify-content:center;"></div>
        <div class="back-btn" onclick="showTitle()">Êàª„Çã</div>
    </div>

    <div id="game-board">
        <div id="enemy-hand-area" class="area"></div>
        <div id="enemy-field" class="area"></div>
        <div id="info-area">
            <div class="leader" onclick="atkLdr('enemy')">
                <div style="font-size:24px;">ü§ñ</div>
                <div id="enemy-hp" class="hp-circle">25</div>
            </div>
            <div style="text-align:center">
                <div id="turn-display" style="color:#aaa; font-size: 12px;">TURN 1</div>
                <div id="mp-display" style="font-size:16px; font-weight:bold; color:var(--success)">MP 1/1</div>
            </div>
            <button id="btn-end-turn" onclick="endTurn()">TURN END</button>
            <div class="leader" onclick="atkLdr('player')">
                <div id="player-hp" class="hp-circle">25</div>
                <div style="font-size:24px;">üßë‚Äçüî¨</div>
            </div>
        </div>
        <div id="craft-list"></div>
        <div id="player-field" class="area"></div>
        <div id="player-hand-area"></div>
        <div id="cancel-btn" onclick="cancelAtk()">‚ùå „Ç≠„É£„É≥„Çª„É´</div>
    </div>

    <div class="action-overlay" id="action-btns" style="display:none;">
        <button class="game-btn btn-dr" onclick="actDraw()">Ôºã „Éâ„É≠„Éº</button>
        <button class="game-btn btn-sy" onclick="actSyn()">‚öóÔ∏è ÂêàÊàê</button>
    </div>

    <div id="turn-change-screen" class="screen hidden" style="z-index:7000; background:rgba(0,0,0,0.98);">
        <div style="font-size:24px; color:#aaa; margin-bottom:20px;">NEXT TURN</div>
        <div id="next-player-name" style="font-size:40px; font-weight:bold; color:var(--accent); margin-bottom:40px;">PLAYER 2</div>
        <div style="font-size:14px; color:#ccc; margin-bottom:20px;">Á´ØÊú´„ÇíÁõ∏Êâã„Å´Ê∏°„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
        <button class="menu-btn btn-p" onclick="startNextTurn()">„Éê„Éà„É´ÂÜçÈñã</button>
    </div>

    <div id="card-detail-panel" onclick="hideDetail()">
        <div class="detail-close">√ó</div>
        <div style="text-align:center">
            <span id="detail-symbol" style="font-size:36px; font-weight:bold; color:var(--primary);"></span>
            <span id="detail-name" style="font-size:20px; font-weight:bold; margin-left:10px;"></span>
        </div>
        <div style="text-align:center; font-size:12px; color:var(--accent); margin-bottom:10px;" id="detail-rarity"></div>
        <div id="detail-art" style="width:100%; height:120px; background:#000; border-radius:8px; display:flex; justify-content:center; align-items:center; font-size:40px; margin-bottom:15px;"></div>
        <div id="detail-stats" style="display:flex; justify-content:center; gap:30px; font-size:20px; font-weight:bold; margin-bottom:15px;"></div>
        <div id="detail-skills" style="font-size:13px; color:#ddd; line-height:1.5;"></div>
        <div style="text-align:center; margin-top:20px; font-size:10px; color:#888;">(„Çø„ÉÉ„Éó„Åó„Å¶Èñâ„Åò„Çã)</div>
    </div>

    <div id="skill-modal" class="screen hidden">
        <h3 style="color:white; margin-bottom:20px;">ÊäÄ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h3>
        <div id="skill-list" style="width:100%; display:flex; flex-direction:column; align-items:center;"></div>
        <button class="menu-btn" style="background:#7f8c8d; margin-top:20px;" onclick="closeSk()">„Ç≠„É£„É≥„Çª„É´</button>
    </div>

    <div id="res-scr" class="screen hidden">
        <div class="res-tit" id="res-tit">VICTORY</div>
        <div style="margin-bottom:30px; font-size:20px; font-weight:bold;" id="res-msg">ÂãùÂà©ÔºÅ</div>
        <button class="menu-btn primary" onclick="showTitle()">„Çø„Ç§„Éà„É´„Å∏Êàª„Çã</button>
        <div id="confetti-container"></div>
    </div>

    <div id="msg-box"></div>

    <script>
        const MAX_H=10, MAX_F=5, INI_HP=25;
        
        // „Éá„Éº„ÇøÂÆöÁæ©
        const ELEM = {
            H:{s:'H',n:'Ê∞¥Á¥†',r:'N',c:'art-fir'}, He:{s:'He',n:'„Éò„É™„Ç¶„É†',r:'SR',c:'art-gas'}, Li:{s:'Li',n:'„É™„ÉÅ„Ç¶„É†',r:'R',c:'art-met'},
            B:{s:'B',n:'„Éõ„Ç¶Á¥†',r:'R',c:'art-sol'}, C:{s:'C',n:'ÁÇ≠Á¥†',r:'N',c:'art-sol'}, N:{s:'N',n:'Á™íÁ¥†',r:'N',c:'art-gas'},
            O:{s:'O',n:'ÈÖ∏Á¥†',r:'N',c:'art-gas'}, F:{s:'F',n:'„Éï„ÉÉÁ¥†',r:'SR',c:'art-tox'}, Ne:{s:'Ne',n:'„Éç„Ç™„É≥',r:'SR',c:'art-gas'},
            Na:{s:'Na',n:'„Éä„Éà„É™„Ç¶„É†',r:'N',c:'art-met'}, Mg:{s:'Mg',n:'„Éû„Ç∞„Éç„Ç∑„Ç¶„É†',r:'R',c:'art-met'}, Al:{s:'Al',n:'„Ç¢„É´„Éü„Éã„Ç¶„É†',r:'R',c:'art-met'},
            Si:{s:'Si',n:'„Ç±„Ç§Á¥†',r:'R',c:'art-sol'}, P:{s:'P',n:'„É™„É≥',r:'R',c:'art-sol'}, S:{s:'S',n:'Á°´ÈªÑ',r:'R',c:'art-tox'},
            Cl:{s:'Cl',n:'Â°©Á¥†',r:'N',c:'art-tox'}, Ar:{s:'Ar',n:'„Ç¢„É´„Ç¥„É≥',r:'SR',c:'art-gas'}, K:{s:'K',n:'„Ç´„É™„Ç¶„É†',r:'N',c:'art-met'},
            Ca:{s:'Ca',n:'„Ç´„É´„Ç∑„Ç¶„É†',r:'R',c:'art-met'}, Ti:{s:'Ti',n:'„ÉÅ„Çø„É≥',r:'SR',c:'art-met'}, V:{s:'V',n:'„Éê„Éä„Ç∏„Ç¶„É†',r:'SR',c:'art-met'},
            Cr:{s:'Cr',n:'„ÇØ„É≠„É†',r:'SR',c:'art-met'}, Mn:{s:'Mn',n:'„Éû„É≥„Ç¨„É≥',r:'R',c:'art-met'}, Fe:{s:'Fe',n:'ÈâÑ',r:'N',c:'art-met'},
            Ni:{s:'Ni',n:'„Éã„ÉÉ„Ç±„É´',r:'R',c:'art-met'}, Cu:{s:'Cu',n:'ÈäÖ',r:'N',c:'art-met'}, Zn:{s:'Zn',n:'‰∫úÈâõ',r:'R',c:'art-met'},
            Ga:{s:'Ga',n:'„Ç¨„É™„Ç¶„É†',r:'SR',c:'art-met'}, Ge:{s:'Ge',n:'„Ç≤„É´„Éû„Éã„Ç¶„É†',r:'SR',c:'art-met'}, Ag:{s:'Ag',n:'ÈäÄ',r:'SR',c:'art-met'},
            Cd:{s:'Cd',n:'„Ç´„Éâ„Éü„Ç¶„É†',r:'R',c:'art-tox'}, Sn:{s:'Sn',n:'„Çπ„Ç∫',r:'R',c:'art-met'}, Ba:{s:'Ba',n:'„Éê„É™„Ç¶„É†',r:'R',c:'art-met'},
            W:{s:'W',n:'„Çø„É≥„Ç∞„Çπ„ÉÜ„É≥',r:'SSR',c:'art-met'}, Pt:{s:'Pt',n:'„Éó„É©„ÉÅ„Éä',r:'SSR',c:'art-met'}, Au:{s:'Au',n:'Èáë',r:'SSR',c:'art-gol'},
            Hg:{s:'Hg',n:'Ê∞¥ÈäÄ',r:'SR',c:'art-liq'}, Pb:{s:'Pb',n:'Èâõ',r:'R',c:'art-met'}
        };

        const REC = [
            {i:['H','Cl'],p:{s:'HCl',n:'Â°©ÂåñÊ∞¥Á¥†',r:'R',a:5,h:1,c:'art-tox',sk:[{n:'Âº∑ÈÖ∏',p:5,d:'È´òÁÅ´Âäõ'}]}},
            {i:['H','F'],p:{s:'HF',n:'„Éï„ÉÉÂåñÊ∞¥Á¥†',r:'SR',a:4,h:2,ab:'tox',c:'art-tox',sk:[{n:'„Ç¨„É©„ÇπËÖêÈ£ü',p:4,d:'ÊîªÊíÉ'},{n:'ÁåõÊØí',p:0,t:'tox',d:'ÂøÖÊÆ∫'}]}},
            {i:['Na','H'],p:{s:'NaH',n:'Ê∞¥Á¥†ÂåñNa',r:'R',a:3,h:1,ab:'stm',c:'art-sol',sk:[{n:'ÈÇÑÂÖÉ',p:3,d:'ÁñæËµ∞'}]}},
            {i:['H','H','O'],p:{s:'H2O',n:'Ê∞¥',r:'N',a:1,h:4,c:'art-liq',sk:[{n:'Ê∞¥ÊµÅ',p:1,d:'ÊîªÊíÉ'},{n:'Âä†Ê∞¥ÂàÜËß£',p:3,t:'heal',d:'ÂõûÂæ©'}]}},
            {i:['Ag','Cl'],p:{s:'AgCl',n:'Â°©ÂåñÈäÄ',r:'SR',a:1,h:6,ab:'wrd',c:'art-sol',sk:[{n:'Ê≤àÊÆø',p:0,t:'grd',d:'ÂÆàË≠∑'}]}},
            {i:['Fe','O'],p:{s:'FeO',n:'ÈÖ∏ÂåñÈâÑ',r:'N',a:3,h:5,c:'art-sol',sk:[{n:'ÈªíÈåÜ',p:3,d:'ÈÄöÂ∏∏'}]}},
            {i:['Fe','O','O'],p:{s:'Fe2O3',n:'Ëµ§ÈåÜ',r:'R',a:2,h:8,ab:'wrd',c:'art-sol',sk:[{n:'‰∏çÂãïÊÖã',p:2,d:'È´òËÄê‰πÖ'}]}},
            {i:['Cu','O'],p:{s:'CuO',n:'ÈÖ∏ÂåñÈäÖ',r:'N',a:3,h:4,c:'art-sol',sk:[{n:'ÈªíÁ≤â',p:3,d:'ÊîªÊíÉ'}]}},
            {i:['Zn','Cu'],p:{s:'Brass',n:'ÈªÑÈäÖ',r:'R',a:4,h:5,c:'art-met',sk:[{n:'ÂêàÈáë',p:4,d:'ÊîªÊíÉ'}]}},
            {i:['Hg','Zn'],p:{s:'Amalgam',n:'„Ç¢„Éû„É´„Ç¨„É†',r:'SR',a:3,h:6,ab:'wrd',c:'art-met',sk:[{n:'ÂêàÈáëÂåñ',p:3,d:'ÂÆàË≠∑'}]}},
            {i:['C','O'],p:{s:'CO',n:'‰∏ÄÈÖ∏ÂåñÁÇ≠Á¥†',r:'R',a:1,h:2,ab:'tox',c:'art-gas',sk:[{n:'‰∏çÂÆåÂÖ®ÁáÉÁÑº',p:1,d:'ÊîªÊíÉ'},{n:'ÁµêÂêà',p:0,t:'tox',d:'ÂøÖÊÆ∫'}]}},
            {i:['H','S'],p:{s:'H2S',n:'Á°´ÂåñÊ∞¥Á¥†',r:'R',a:2,h:3,ab:'tox',c:'art-gas',sk:[{n:'ËÖêÂçµËá≠',p:2,d:'ÊîªÊíÉ'},{n:'Á°´Âåñ',p:0,t:'tox',d:'ÂøÖÊÆ∫'}]}},
            {i:['Cl','Cl'],p:{s:'Cl2',n:'Â°©Á¥†„Ç¨„Çπ',r:'R',a:3,h:3,c:'art-gas',sk:[{n:'Êï£Â∏É',p:2,t:'aoe',d:'ÂÖ®‰Ωì2„ÉÄ„É°'}]}},
            {i:['S','O','O'],p:{s:'SO2',n:'‰∫åÈÖ∏ÂåñÁ°´ÈªÑ',r:'N',a:2,h:4,c:'art-gas',sk:[{n:'ÈÖ∏ÊÄßÈõ®',p:1,t:'aoe',d:'ÂÖ®‰Ωì1„ÉÄ„É°'}]}},
            {i:['Cd','S'],p:{s:'CdS',n:'Á°´ÂåñCd',r:'SR',a:2,h:5,ab:'tox',c:'art-tox',sk:[{n:'„Ç§„Çø„Ç§„Ç§„Çø„Ç§',p:0,t:'tox',d:'ÁåõÊØí'}]}},
            {i:['Na','O','H'],p:{s:'NaOH',n:'Ê∞¥ÈÖ∏ÂåñNa',r:'R',a:3,h:3,c:'art-sol',sk:[{n:'‰∏≠ÂíåÁÜ±',p:2,t:'ah',d:'ÂÖ®‰Ωì2/Âõû'}]}},
            {i:['Al','O','O'],p:{s:'Al2O3',n:'„Ç¢„É´„Éü„Éä',r:'R',a:2,h:7,ab:'wrd',c:'art-sol',sk:[{n:'Ë¢´ËÜú',p:2,d:'ÂÆàË≠∑'}]}},
            {i:['Cl','Na'],p:{s:'NaCl',n:'Â°©ÂåñNa',r:'N',a:3,h:4,c:'art-sol',sk:[{n:'Â°©Âë≥',p:3,d:'ÈÄöÂ∏∏'}]}},
            {i:['Ca','O','H','H'],p:{s:'Ca(OH)2',n:'Ê∂àÁü≥ÁÅ∞',r:'N',a:1,h:6,ab:'wrd',c:'art-sol',sk:[{n:'‰∏≠Âíå',p:4,t:'heal',d:'ÂõûÂæ©'}]}},
            {i:['C','C','C'],p:{s:'Diamond',n:'„ÉÄ„Ç§„É§',r:'SSR',a:4,h:10,ab:'wrd',c:'art-gol',sk:[{n:'Á°¨Â∫¶10',p:4,d:'ÈâÑÂ£Å'}]}},
            {i:['Al','O','O','Cr'],p:{s:'Ruby',n:'„É´„Éì„Éº',r:'SR',a:5,h:8,c:'art-sol',sk:[{n:'Ê∑±Á¥Ö',p:5,d:'ÊîªÊíÉ'}]}},
            {i:['Al','O','Ti'],p:{s:'Sapphire',n:'„Çµ„Éï„Ç°„Ç§„Ç¢',r:'SR',a:4,h:9,c:'art-sol',sk:[{n:'ÈùíÁéâ',p:4,d:'ËÄê‰πÖ'}]}},
            {i:['Si','O','O'],p:{s:'SiO2',n:'Áü≥Ëã±',r:'N',a:3,h:6,c:'art-sol',sk:[{n:'ÁµêÊô∂',p:2,t:'aoe',d:'ÂÖ®‰Ωì2'}]}},
            {i:['Au'],p:{s:'Au',n:'Èáë',r:'SSR',a:6,h:6,c:'art-gol',sk:[{n:'Ëºù„Åç',p:6,d:'ÁÅ´Âäõ'}]}},
            {i:['Pt'],p:{s:'Pt',n:'„Éó„É©„ÉÅ„Éä',r:'SSR',a:5,h:7,c:'art-met',sk:[{n:'Ëß¶Â™í',p:5,d:'ÊîªÊíÉ'}]}},
            {i:['W'],p:{s:'W',n:'„Çø„É≥„Ç∞„Çπ„ÉÜ„É≥',r:'SSR',a:7,h:8,ab:'wrd',c:'art-met',sk:[{n:'ËûçÁÇπ',p:7,d:'ÊîªÊíÉ'}]}},
            {i:['Ti'],p:{s:'Ti',n:'„ÉÅ„Çø„É≥',r:'SR',a:4,h:5,c:'art-met',sk:[{n:'Âº∑Â∫¶',p:4,d:'ÊîªÊíÉ'}]}},
            {i:['He','He'],p:{s:'He',n:'„Éò„É™„Ç¶„É†',r:'SR',a:2,h:2,ab:'stl',c:'art-gas',sk:[{n:'‰∏çÊ¥ªÊÄß',p:2,d:'ÊΩú‰ºè'}]}},
            {i:['Ne','Ne'],p:{s:'Ne',n:'„Éç„Ç™„É≥',r:'SR',a:3,h:3,ab:'stl',c:'art-gas',sk:[{n:'Áô∫ÂÖâ',p:3,d:'ÊΩú‰ºè'}]}},
            {i:['Ar','Ar'],p:{s:'Ar',n:'„Ç¢„É´„Ç¥„É≥',r:'SR',a:4,h:4,ab:'stl',c:'art-gas',sk:[{n:'‰øùË≠∑',p:4,d:'ÊΩú‰ºè'}]}},
            {i:['H','Cl','N','O','O','O'],p:{s:'AquaRegia',n:'ÁéãÊ∞¥',r:'SSR',a:0,h:0,tp:'spl',c:'art-liq',sk:[{n:'Ê∫∂Ëß£',p:99,t:'tox',d:'Èô§Âéª'}]}},
            {i:['H','H','S','O','O','O','O'],p:{s:'H2SO4',n:'ÊøÉÁ°´ÈÖ∏',r:'SR',a:0,h:0,tp:'spl',c:'art-liq',sk:[{n:'ËÑ±Ê∞¥',p:5,t:'aoe',d:'ÂÖ®5„ÉÄ„É°'}]}},
            {i:['K','Mn','O','O','O','O'],p:{s:'KMnO4',n:'ÈÅé„Éû„É≥„Ç¨„É≥ÈÖ∏K',r:'SR',a:0,h:0,tp:'spl',c:'art-sol',sk:[{n:'ÈÖ∏Âåñ',p:7,t:'dmg',d:'7„ÉÄ„É°'}]}}
        ];

        const DECKS = {
            aggro:{n:'Ë∂ÖÈÄüÊîª',d:'È´òÁÅ´Âäõ„Éª‰ΩéËÄê‰πÖ',e:['H','H','Cl','F','Na','O'],r:['HCl','HF','NaH','H2O']},
            counter:{n:'„Ç´„Ç¶„É≥„Çø„Éº',d:'ÂÆà„Å£„Å¶ÂèçÊíÉ',e:['Ag','Cl','Fe','O','Cu','Zn','Hg'],r:['AgCl','FeO','Fe2O3','Brass','Amalgam','CuO']},
            toxic:{n:'ÂÆ≥ÊÇ™',d:'ÂøÖÊÆ∫„ÅßÂç≥Ê≠ª',e:['C','O','S','H','Cl','Cd'],r:['CO','H2S','Cl2','SO2','CdS']},
            control:{n:'„Ç≥„É≥„Éà„É≠„Éº„É´',d:'ÂõûÂæ©„Å®ÊîØÈÖç',e:['Al','O','H','Na','Cl','Ca'],r:['Al2O3','NaOH','H2O','NaCl','Ca(OH)2']},
            gemstone:{n:'ÂÆùÁü≥',d:'ÊúÄÂº∑„ÅÆÁ°¨Â∫¶',e:['C','C','C','Al','O','Si','Cr','Ti'],r:['Diamond','Ruby','Sapphire','SiO2']},
            heavy:{n:'ÈáçÈáëÂ±û',d:'ÂæåÂçäÊúÄÂº∑',e:['Au','Pt','W','Ti'],r:['Au','Pt','W','Ti']},
            noble:{n:'Ë≤¥„Ç¨„Çπ',d:'ÊΩú‰ºèÊîªÊíÉ',e:['He','He','Ne','Ne','Ar','Ar'],r:['He','Ne','Ar']},
            hazard:{n:'Âç±Èô∫Áâ©',d:'Èô§Âéª„Çπ„Éö„É´',e:['H','Cl','N','O','S','K','Mn'],r:['AquaRegia','H2SO4','KMnO4']}
        };

        let gs = { mode:'cpu', p1:{}, p2:{}, turn:1, isP1Turn:true, active:null, other:null, sel:[], atk:null };
        let p1Key = null;

        // --- ÂàùÊúüÂåñ ---
        window.onload = () => {
            initParticles();
            
            const g = document.getElementById('deck-grid-container');
            for(let k in DECKS){
                const d = document.createElement('div'); d.className='deck-card';
                d.innerHTML=`<div class="deck-title">${DECKS[k].n}</div><div class="deck-desc">${DECKS[k].d}</div>`;
                d.onclick=()=>deckSelected(k); 
                g.appendChild(d);
            }
            
            const lg=document.getElementById('lib-grid');
            for(let k in ELEM) addLib(ELEM[k],true,lg);
            REC.forEach(r=>addLib(r.p,false,lg));
            
            showTitle();
        };

        function initParticles() {
            const c = document.getElementById('particles');
            for(let i=0; i<30; i++) {
                const p = document.createElement('div'); p.className='particle';
                p.style.left = Math.random()*100 + 'vw';
                p.style.width = p.style.height = (Math.random()*5 + 2) + 'px';
                p.style.animationDuration = (Math.random()*10 + 5) + 's';
                p.style.animationDelay = (Math.random()*5) + 's';
                c.appendChild(p);
            }
        }

        // --- ÁîªÈù¢ÈÅ∑Áßª ---
        function showTitle() { hideAll(); document.getElementById('title-screen').classList.remove('hidden'); }
        function showDeckSelect(mode) { gs.mode = mode; hideAll(); document.getElementById('deck-select-screen').classList.remove('hidden'); }
        function showLib() { hideAll(); document.getElementById('lib-screen').classList.remove('hidden'); }
        function hideAll() { 
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden')); 
            document.getElementById('game-board').style.display='none'; 
            document.getElementById('action-btns').style.display='none';
            document.getElementById('res-scr').style.display='none';
        }

        function deckSelected(k){
            if(gs.mode === 'cpu'){
                startGame(k, null);
            } else {
                if(!p1Key){
                    p1Key = k;
                    document.querySelector('#deck-select-screen h2').innerText = "2P „Éá„ÉÉ„Ç≠ÈÅ∏Êäû";
                    alert("Player 1 ÈÅ∏ÊäûÂÆå‰∫Ü„ÄÇÊ¨°„ÅØ Player 2 „Åß„Åô„ÄÇ");
                } else {
                    startGame(p1Key, k);
                    p1Key = null;
                }
            }
        }

        function startGame(k1, k2) {
            const createP = (key, name) => ({
                name: name, hp: INI_HP, mp: 1, maxMp: 1,
                pool: DECKS[key].e.map(s=>ELEM[s]),
                rec: REC.filter(r=>DECKS[key].r.includes(r.p.s)),
                h: [], f: []
            });

            gs.p1 = createP(k1, "PLAYER 1");
            if(gs.mode === 'cpu') {
                const keys = Object.keys(DECKS);
                const ek = keys[Math.floor(Math.random()*keys.length)];
                gs.p2 = createP(ek, `CPU (${DECKS[ek].n})`);
            } else {
                gs.p2 = createP(k2, "PLAYER 2");
            }
            
            gs.turn = 1; gs.isP1Turn = true;
            gs.active = gs.p1; gs.other = gs.p2;
            gs.sel=[]; gs.atk=null;

            for(let i=0; i<5; i++) { draw(gs.p1); draw(gs.p2); }

            hideAll();
            document.getElementById('game-board').style.display='flex';
            document.getElementById('action-btns').style.display='flex';
            upd();
            msg("„Éê„Éà„É´ÈñãÂßãÔºÅ");
        }

        // --- „Ç≤„Éº„É†„É≠„Ç∏„ÉÉ„ÇØ ---
        function draw(p) {
            if(p.h.length >= MAX_H) return;
            const c = { ...p.pool[Math.floor(Math.random()*p.pool.length)], id:Math.random().toString(36), type:'el' };
            p.h.push(c);
        }
        function actDraw() { if(gs.active.mp < 1) { msg("MP‰∏çË∂≥"); return; } gs.active.mp--; draw(gs.active); upd(); }
        
        function actSyn() {
            if(gs.sel.length === 0) return;
            const sl = gs.active.h.filter(c => gs.sel.includes(c.id));
            const sym = sl.map(c => c.s).sort();
            
            // Âçò‰ΩìÁîüÊàê
            if(gs.sel.length === 1) {
                const r = gs.active.rec.find(x => x.i.length === 1 && x.i[0] === sym[0]);
                if(r) { doSyn(r); return; }
            }
            
            const r = gs.active.rec.find(x => JSON.stringify(x.i.sort()) === JSON.stringify(sym));
            if(r) doSyn(r); else { msg("ÂèçÂøú„Å™„Åó"); gs.sel=[]; upd(); }
        }

        function doSyn(r) {
            gs.active.h = gs.active.h.filter(c => !gs.sel.includes(c.id)); gs.sel = [];
            
            if(r.p.tp === 'spl') {
                const s = r.p.sk[0];
                if(gs.other.f.length > 0) {
                    const t = gs.other.f.reduce((a,b)=>a.cur > b.cur ? a : b);
                    if(s.t === 'tox') t.cur = -99; else t.cur -= s.p;
                    msg(`${s.n} -> ${t.n}`);
                } else {
                    gs.other.hp -= s.p;
                    msg(`${s.n} -> Leader`);
                }
                chk(); upd(); return;
            }

            if(gs.active.f.length >= MAX_FIELD) { msg("Ê∫ÄÂì°"); return; }
            const u = { ...r.p, id:Math.random().toString(36), max:r.p.h, cur:r.p.h, can:r.p.ab==='stm', type:'unit' };
            gs.active.f.push(u);
            msg(`Âè¨Âñö: ${u.n}`);
            upd();
        }

        // --- Êìç‰Ωú ---
        function onHand(id) {
            const c = gs.active.h.find(x => x.id === id);
            showDet(c, true);
            if(gs.sel.includes(id)) gs.sel = gs.sel.filter(x => x !== id); else gs.sel.push(id);
            upd();
        }
        
        function onField(id, isMy) {
            if(isMy) {
                const u = gs.active.f.find(x => x.id === id); showDet(u, false);
                if(u && u.can) { gs.atk = u; document.body.classList.add('valid-target'); upd(); }
            } else if(gs.atk) {
                const t = gs.other.f.find(x => x.id === id);
                if(t.ab === 'stl') { msg("ÊΩú‰ºè‰∏≠"); return; }
                prepAtk(gs.atk, t, 'unit');
            } else {
                showDet(gs.other.f.find(x => x.id === id), false);
            }
        }
        
        function atkLdr(s) {
            if((s === 'e' && gs.isP1Turn) || (s === 'p' && !gs.isP1Turn)) {
                if(gs.atk) prepAtk(gs.atk, 'ldr', 'ldr');
            }
        }

        function prepAtk(a, t, type) {
            if(type === 'ldr' || (type === 'unit' && t.ab !== 'wrd')) {
                if(gs.other.f.some(u => u.ab === 'wrd' && u.ab !== 'stl')) { msg("ÂÆàË≠∑„ÅÇ„Çä"); cancelAtk(); return; }
            }
            if(a.sk.length > 1) openSk(a, t); else exeSk(a, t, a.sk[0]);
        }
        
        function openSk(a, t) {
            const m = document.getElementById('skill-modal'), l = document.getElementById('skill-list'); l.innerHTML = '';
            a.sk.forEach(s => {
                const b = document.createElement('div'); b.className = 'sk-btn';
                b.innerHTML = `${s.n} (${s.p})`;
                b.onclick = () => { exeSk(a, t, s); m.style.display = 'none'; };
                l.appendChild(b);
            });
            m.style.display = 'flex';
        }
        function closeSk() { document.getElementById('skill-modal').style.display = 'none'; cancelAtk(); }

        function exeSk(a, t, s) {
            if(s.t === 'aoe') { gs.other.f.forEach(u => u.cur -= s.p); gs.other.hp -= s.p; }
            else if(s.t === 'ah') { gs.other.f.forEach(u => u.cur -= s.p); gs.active.hp += s.p; }
            else if(s.t === 'heal') { gs.active.hp += s.p; }
            else {
                let d = s.p;
                if(t === 'ldr') gs.other.hp -= d;
                else {
                    let cnt = t.a;
                    if(s.t === 'tox' && d > 0) t.cur = -99; else t.cur -= d;
                    if(t.cur <= 0 && t.ab === 'tox' && cnt > 0) a.cur = -99; else a.cur -= cnt;
                }
            }
            a.can = false; msg(s.n); cancelAtk(); chk(); upd();
        }

        function cancelAtk() { gs.atk = null; document.body.classList.remove('valid-target'); upd(); }
        
        function chk() {
            gs.active.f = gs.active.f.filter(u => u.cur > 0);
            gs.other.f = gs.other.f.filter(u => u.cur > 0);
            if(gs.other.hp <= 0) res(true); else if(gs.active.hp <= 0) res(false);
        }
        
        function res(w) {
            const s = document.getElementById('res-scr'), t = document.getElementById('res-tit'), m = document.getElementById('res-msg');
            s.style.display = 'flex';
            if(gs.mode === 'cpu') {
                if(w) { t.innerText = "VICTORY"; t.style.color = "#f1c40f"; m.innerText = "ÂãùÂà©ÔºÅ"; createConfetti(); }
                else { t.innerText = "DEFEAT"; t.style.color = "#e74c3c"; m.innerText = "ÊïóÂåó..."; }
            } else {
                t.innerText = "WINNER"; t.style.color = "#f1c40f";
                m.innerText = (w ? gs.active.name : gs.other.name) + " „ÅÆÂãùÂà©ÔºÅ"; createConfetti();
            }
        }
        
        function endTurn() {
            cancelAtk();
            if(gs.mode === 'cpu') { msg("Êïµ„Çø„Éº„É≥"); setTimeout(cpu, 1000); }
            else {
                document.getElementById('turn-change-screen').classList.remove('hidden');
                document.getElementById('next-player-name').innerText = gs.isP1Turn ? "PLAYER 2" : "PLAYER 1";
            }
        }
        
        function startNextTurn() {
            document.getElementById('turn-change-screen').classList.add('hidden');
            gs.isP1Turn = !gs.isP1Turn;
            gs.active = gs.isP1Turn ? gs.p1 : gs.p2; gs.other = gs.isP1Turn ? gs.p2 : gs.p1;
            gs.turn++; if(gs.active.maxMp < 10) gs.active.maxMp++; gs.active.mp = gs.active.maxMp;
            gs.active.f.forEach(u => u.can = true);
            draw(gs.active); msg(`${gs.active.name}„ÅÆ„Çø„Éº„É≥`); upd();
        }

        async function cpu() {
            const e = gs.p2; if(e.maxMp < 10) e.maxMp++; e.mp = e.maxMp;
            draw(e); upd(); await sleep(500);
            
            let act = true;
            while(act && e.f.length < MAX_FIELD) {
                act = false; const h = e.h.map(c => c.s);
                for(let r of e.rec) {
                    if(r.p.tp === 'spl') continue;
                    let i = [...r.i], th = [...h], ok = true;
                    for(let x of i) { let idx = th.indexOf(x); if(idx < 0) { ok = false; break; } th.splice(idx, 1); }
                    if(ok) {
                        for(let x of r.i) { let idx = e.h.findIndex(c => c.s === x); e.h.splice(idx, 1); }
                        e.f.push({ ...r.p, id:Math.random(), max:r.p.h, cur:r.p.h, can:false, type:'unit' });
                        msg("CPUÂè¨Âñö"); upd(); await sleep(800); act = true; break;
                    }
                }
            }
            e.f.forEach(u => u.can = true);
            for(let u of e.f) {
                if(!u.can) continue;
                let t = 'ldr', grd = gs.p1.f.find(g => g.ab === 'wrd' && g.ab !== 'stl'); if(grd) t = grd;
                if(t === 'ldr') { gs.p1.hp -= u.sk[0].p; msg("CPUÊîªÊíÉ"); }
                else {
                    let d = u.sk[0].p; 
                    if(u.sk[0].t === 'tox' && d > 0) t.cur = -99; else t.cur -= d;
                    u.cur -= t.a; msg(`CPUÊîªÊíÉ`);
                }
                chk(); upd(); await sleep(800);
            }
            gs.turn++; if(gs.p1.maxMp < 10) gs.p1.maxMp++; gs.p1.mp = gs.p1.maxMp;
            gs.p1.f.forEach(u => u.can = true); draw(gs.p1); msg("„ÅÇ„Å™„Åü„ÅÆ„Çø„Éº„É≥"); upd();
        }
        const sleep = m => new Promise(r => setTimeout(r, m));

        function upd() {
            const p = gs.active, e = gs.other;
            document.getElementById('turn-display').innerText = `Turn ${gs.turn}`;
            document.getElementById('mp-display').innerText = `MP ${p.mp}/${p.maxMp}`;
            document.getElementById('player-hp').innerText = p.hp;
            document.getElementById('enemy-hp').innerText = e.hp;
            //document.querySelector('#leader-player .leader-name').innerText = p.name;
            //document.getElementById('enemy-name').innerText = e.name;
            //document.getElementById('cancel-attack-btn').style.display = gs.atk ? 'block' : 'none';
            
            rend('player-hand-area', p.h, 'hand', true);
            rend('player-field', p.f, 'field', true);
            rend('enemy-field', e.f, 'field', false);
            const eh = document.getElementById('enemy-hand-area'); eh.innerHTML = '';
            e.h.forEach(() => { const d = document.createElement('div'); d.className = 'card'; d.style.background = '#34495e'; d.style.width = '30px'; d.style.height = '45px'; eh.appendChild(d); });
            
            const hl = document.getElementById('craftable-list'); hl.innerHTML = '';
            if(gs.mode === 'cpu' && !gs.isP1Turn) return; // CPU„Çø„Éº„É≥„ÅØ„Éí„É≥„Éà„Å™„Åó
            
            gs.active.rec.forEach(r => {
                let h = gs.active.h.map(c => c.s), ok = true;
                for(const i of r.ingredients) { const idx = h.indexOf(i); if(idx === -1) { ok = false; break; } h.splice(idx, 1); }
                if(ok) {
                    const b = document.createElement('div'); b.className = 'craft-hint-btn';
                    b.innerHTML = `<div style="font-weight:bold;color:var(--accent)">‚ú® ${r.product.n}</div><div style="font-size:10px">‚öîÔ∏è${r.product.a} ‚ù§Ô∏è${r.product.h}</div>`;
                    b.onclick = () => { gs.sel = []; let th = [...gs.active.h]; r.ingredients.forEach(i => { const idx = th.findIndex(c => c.s === i); if(idx !== -1) { gs.sel.push(th[idx].id); th.splice(idx, 1); } }); upd(); };
                    hl.appendChild(b);
                }
            });
        }

        function rend(eid, l, type, isP) {
            const el = document.getElementById(eid); el.innerHTML = '';
            l.forEach(c => { el.appendChild(createC(c, c.type === 'el', type === 'hand' && gs.sel.includes(c.id), type === 'field' && c.can && isP, type === 'field' && !isP && gs.atk)); });
        }

        function createC(c, isEl, isSel, isCan, isTgt) {
            const d = document.createElement('div'); d.className = 'card'; d.setAttribute('data-rarity', c.r);
            let art = c.c || 'art-p-solid', bz = '', st = '';
            if(!isEl) {
                if(c.ab === 'wrd') bz += '<div class="c-badge cb-ward">üõ°Ô∏è</div>';
                if(c.ab === 'tox') bz += '<div class="c-badge cb-toxic">‚ò†Ô∏è</div>';
                if(c.ab === 'stm') bz += '<div class="c-badge cb-storm">‚ö°</div>';
                if(c.ab === 'stl') bz += '<div class="c-badge cb-stealth">üëÅÔ∏è</div>';
                st = `<div class="c-stats-box"><div class="stat-atk-box">‚öîÔ∏è${c.a}</div><div class="stat-hp-box">‚ù§Ô∏è${c.cur}</div></div>`;
            }
            d.innerHTML = `
                <div class="c-head"><span class="card-name">${c.n}</span><span class="card-symbol-small">${c.s}</span></div>
                <div class="c-art-box art-frame"><div class="css-art ${art}"></div></div>
                <div class="c-text-box">${!isEl && c.sk ? `<span class="skill-name-small">${c.sk[0].n}</span>` : (isEl ? 'Á¥†Êùê' : '')}</div>
                ${!isEl ? `<div class="badges" style="flex-direction:column">${bz}</div>` : ''}
                ${st}
            `;
            if(isSel) d.classList.add('selected');
            if(isCan) d.classList.add('can-attack');
            if(isTgt) d.classList.add('valid-target');
            if(!d.onclick) d.onclick = (e) => { e.stopPropagation();
                if(gs.active.h.includes(c)) onHand(c.id);
                else if(gs.active.f.includes(c)) onField(c.id, true);
                else if(gs.other.f.includes(c)) onField(c.id, false);
            };
            return d;
        }

        function addLib(d, isE, rt) {
            const c = createC({ ...d, id: 0 }, isE, false, false, false);
            c.onclick = () => showDet(d, isE);
            rt.appendChild(c);
        }

        function showDet(c, isEl) {
            const p = document.getElementById('det-pan'); p.style.display = 'flex';
            document.getElementById('dt-sym').innerText = c.s; document.getElementById('dt-name').innerText = c.n;
            document.querySelector('#det-pan .css-art').className = `css-art ${c.c || 'art-p-solid'}`;
            const st = document.getElementById('dt-st'), ds = document.getElementById('dt-desc');
            if(isEl) { st.innerHTML = `<span style="font-size:14px;color:#ccc">Á¥†Êùê</span>`; ds.innerHTML = `<div>ÂêàÊàê„Å´‰ΩøÁî®„Åó„Åæ„Åô„ÄÇ</div>`; }
            else {
                st.innerHTML = `<span style="color:#e67e22">‚öîÔ∏è${c.a}</span> <span style="color:#2ecc71">‚ù§Ô∏è${c.cur}/${c.max}</span>`;
                ds.innerHTML = c.sk.map(s => `<div><b>${s.n}</b> (${s.p}): ${s.d}</div>`).join('');
            }
        }
        function msg(t) { const b = document.getElementById('msg-box'); b.innerText = t; b.style.opacity = 1; setTimeout(() => b.style.opacity = 0, 1500); }
        function createConfetti() { const c = document.getElementById('confetti-container'); if(!c) return; c.innerHTML = ''; for(let i = 0; i < 50; i++) { const p = document.createElement('div'); p.className = 'confetti'; p.style.left = Math.random() * 100 + 'vw'; p.style.backgroundColor = `hsl(${Math.random() * 360},100%,50%)`; p.style.animationDuration = (Math.random() * 3 + 2) + 's'; c.appendChild(p); } }
    </script>
</body>
</html>