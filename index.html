<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chem-Verse Mobile Enhanced</title>
    <style>
        :root {
            --bg-color: #1a1a1d;
            --card-bg: #ecf0f1;
            --accent: #f1c40f;
            --primary: #3498db;
            --danger: #e74c3c;
            --success: #2ecc71;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
            background-color: var(--bg-color);
            color: white;
            margin: 0;
            user-select: none;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ --- */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            z-index: 2000;
            display: flex; flex-direction: column; align-items: center;
            overflow-y: auto; padding: 20px 10px; box-sizing: border-box;
        }
        h1 { margin: 20px 0; font-size: 24px; text-shadow: 0 0 10px var(--accent); color: var(--accent); }
        .deck-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
            width: 100%; max-width: 600px; padding-bottom: 40px;
        }
        .deck-card {
            background: rgba(255,255,255,0.1); border: 2px solid #fff;
            padding: 10px; border-radius: 8px; cursor: pointer;
            display: flex; flex-direction: column; justify-content: space-between;
            min-height: 100px;
        }
        .deck-card:active { background: rgba(255,255,255,0.3); border-color: var(--accent); transform: scale(0.98); }
        .deck-title { font-size: 16px; font-weight: bold; margin-bottom: 5px; color: var(--accent); }
        .deck-desc { font-size: 10px; color: #ddd; line-height: 1.3; }

        /* --- ã‚²ãƒ¼ãƒ ãƒœãƒ¼ãƒ‰ --- */
        #game-board { display: none; flex-direction: column; height: 100vh; position: relative; }
        
        #enemy-hand-area { height: 8%; background: #2c3e50; display: flex; justify-content: center; align-items: center; gap: 2px; }
        #enemy-field { height: 22%; background: #34495e; border-bottom: 2px solid #7f8c8d; display: flex; justify-content: center; align-items: center; }
        
        #info-area {
            height: 10%; background: #222;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 10px; z-index: 10; box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }

        #player-field { height: 22%; background: #34495e; border-top: 2px solid #7f8c8d; display: flex; justify-content: center; align-items: center; }
        
        /* â˜… æ‰‹æœ­ã‚¨ãƒªã‚¢æ”¹è‰¯: é«˜ã•ã‚’å¢—ã‚„ã—ã€ã‚«ãƒ¼ãƒ‰ã‚’å¤§ããè¡¨ç¤º */
        #player-hand-area { 
            height: 38%; background: #222f3e; 
            overflow-x: auto; display: flex; align-items: center; 
            padding-left: 15px; gap: 8px; /* é–“éš”ã‚’åºƒã’ã‚‹ */
        }

        /* --- ã‚«ãƒ¼ãƒ‰å…±é€šã‚¹ã‚¿ã‚¤ãƒ« --- */
        .card {
            background: var(--card-bg); color: #333;
            border-radius: 6px; position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
            border: 2px solid #bdc3c7; flex-shrink: 0;
            transition: transform 0.1s;
        }
        
        /* â˜… ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä¸Šã®ã‚«ãƒ¼ãƒ‰ (å°‘ã—å°ã•ã‚) */
        .area .card { width: 60px; height: 85px; }

        /* â˜… æ‰‹æœ­ã®ã‚«ãƒ¼ãƒ‰ (å¤§ããè¦‹ã‚„ã™ãï¼) */
        #player-hand-area .card { 
            width: 85px; height: 120px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.6);
        }
        /* æ‰‹æœ­ã®æ–‡å­—ã‚µã‚¤ã‚ºèª¿æ•´ */
        #player-hand-area .card .card-symbol { font-size: 22px; margin-top: 15px; }
        #player-hand-area .card .card-name { font-size: 11px; }
        #player-hand-area .card .stats { font-size: 12px; bottom: 5px; }

        .card:active { transform: scale(0.95); }
        .card.selected { border-color: var(--accent); transform: translateY(-15px); box-shadow: 0 0 15px var(--accent); }
        .card.can-attack { border-color: var(--primary); box-shadow: 0 0 8px var(--primary); }
        .card.attacking { border-color: var(--danger); box-shadow: 0 0 15px var(--danger); z-index: 100; transform: scale(1.1); }

        .card-symbol { font-size: 16px; font-weight: bold; text-align: center; margin-top: 8px; overflow: hidden; white-space: nowrap;}
        .card-name { font-size: 8px; text-align: center; font-weight: bold; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; padding: 0 2px;}
        
        .stats {
            position: absolute; bottom: 2px; width: 100%;
            display: flex; justify-content: space-between; padding: 0 3px; box-sizing: border-box;
            font-weight: bold; font-size: 10px;
        }
        .stat-atk { background: #e67e22; color: white; padding: 1px 3px; border-radius: 3px; }
        .stat-hp { background: var(--success); color: white; padding: 1px 3px; border-radius: 3px; }

        .ability-container { position: absolute; top: -6px; right: -6px; display: flex; flex-direction: column; gap: 1px; }
        .badge {
            width: 18px; height: 18px; border-radius: 50%; color: white; font-size: 10px;
            display: flex; align-items: center; justify-content: center; border: 1px solid white; font-weight: bold;
            box-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }
        .badge-ward { background-color: var(--primary); }
        .badge-toxic { background-color: #8e44ad; }
        .badge-storm { background-color: #f39c12; }
        .badge-stealth { background-color: #7f8c8d; }

        /* --- UIãƒ‘ãƒ¼ãƒ„ --- */
        .leader { text-align: center; position: relative; padding: 2px; width: 60px; }
        .leader-name { font-size: 10px; font-weight: bold; color: var(--accent); margin-bottom: 2px;}
        .hp-circle { 
            background: #c0392b; color: white; border-radius: 50%; 
            width: 34px; height: 34px; line-height: 34px; 
            font-weight: bold; font-size: 14px; margin: 0 auto; 
            border: 2px solid white; box-shadow: 0 0 5px #e74c3c;
        }
        .turn-info { text-align: center; font-size: 12px; }
        .mp-bar { font-size: 14px; color: var(--success); font-weight: bold; }

        /* --- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ --- */
        .action-overlay { 
            position: absolute; bottom: 140px; right: 10px; 
            display: flex; flex-direction: column; gap: 8px; z-index: 50; 
        }
        .game-btn { 
            padding: 12px 16px; border-radius: 25px; border: none; 
            font-weight: bold; color: white; font-size: 12px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.4); 
            text-transform: uppercase; letter-spacing: 1px;
        }
        .btn-draw { background: linear-gradient(to right, #27ae60, #2ecc71); } 
        .btn-syn { background: linear-gradient(to right, #e67e22, #f39c12); }
        #btn-end-turn { 
            padding: 8px 12px; font-size: 11px; background: #f39c12; 
            border-radius: 20px; border: none; color: white; font-weight: bold;
        }
        #btn-end-turn:disabled { background: #555; color: #888; }

        /* â˜… ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ (æ”»æ’ƒãƒ¢ãƒ¼ãƒ‰ä¸­ã®ã¿è¡¨ç¤º) */
        #cancel-attack-btn {
            display: none;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(231, 76, 60, 0.9); color: white;
            padding: 15px 30px; border-radius: 30px; border: 2px solid white;
            font-weight: bold; font-size: 16px; cursor: pointer;
            z-index: 200; box-shadow: 0 0 20px rgba(0,0,0,0.7);
            animation: popIn 0.3s;
        }
        @keyframes popIn { from { transform: translate(-50%, -50%) scale(0); } to { transform: translate(-50%, -50%) scale(1); } }

        /* --- è©³ç´°ãƒ‘ãƒãƒ« --- */
        #card-detail-panel {
            position: absolute; top: 15%; left: 50%; transform: translateX(-50%);
            width: 85%; max-width: 300px; background: rgba(0, 0, 0, 0.95);
            border: 2px solid var(--primary); border-radius: 10px; padding: 15px;
            display: none; flex-direction: column; color: white; z-index: 3000;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
        }
        .detail-close { position: absolute; top: 5px; right: 10px; font-size: 24px; cursor: pointer; color: #aaa; }
        .detail-header { text-align: center; margin-bottom: 10px; border-bottom: 1px solid #555; padding-bottom: 5px;}
        .detail-symbol { font-size: 32px; font-weight: bold; color: var(--primary); }
        .detail-name { font-size: 16px; font-weight: bold; margin-bottom: 5px; }
        .detail-skills { font-size: 12px; max-height: 200px; overflow-y: auto; }
        .skill-item { margin-bottom: 8px; border-left: 3px solid var(--accent); padding-left: 8px; }
        .skill-item-name { font-weight: bold; color: var(--accent); }
        .skill-item-desc { color: #ccc; font-size: 11px; }

        /* --- ãƒ’ãƒ³ãƒˆ --- */
        #craftable-list {
            position: absolute; bottom: 42%; left: 10px;
            display: flex; flex-direction: column; gap: 5px; z-index: 40; pointer-events: none;
        }
        .craft-hint-btn {
            background: rgba(0, 0, 0, 0.9); border: 1px solid var(--accent); color: white;
            padding: 6px 10px; border-radius: 6px; pointer-events: auto;
            display: flex; flex-direction: column; min-width: 120px;
            box-shadow: 0 0 5px rgba(241, 196, 15, 0.5);
        }
        
        /* --- ãƒ¢ãƒ¼ãƒ€ãƒ« --- */
        #skill-modal {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 4000;
            flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box;
        }
        .skill-list { width: 100%; max-width: 350px; display: flex; flex-direction: column; gap: 10px; }
        .skill-btn {
            background: #fff; color: #333; padding: 12px; border-radius: 8px;
            border-left: 8px solid var(--primary); position: relative;
        }
        .skill-btn:active { background: #eee; }

        #msg-box {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9); padding: 15px 30px; border-radius: 8px; border: 1px solid white;
            font-size: 20px; font-weight: bold; pointer-events: none; opacity: 0; transition: 0.3s; z-index: 5000; text-align: center; white-space: nowrap;
        }

        body.targeting .card { border-style: dashed; }
        .valid-target { animation: pulse 0.8s infinite; border-color: var(--danger) !important; box-shadow: 0 0 10px var(--danger); }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

    </style>
</head>
<body>

    <div id="start-screen">
        <h1>Chem-Verse Mobile</h1>
        <p>ãƒ‡ãƒƒã‚­ã‚’é¸ã‚“ã§ãã ã•ã„</p>
        <div class="deck-grid">
            <div class="deck-card" onclick="startGame('aggro')">
                <div class="deck-title">ğŸ”¥ è¶…é€Ÿæ”»</div>
                <div class="deck-desc">HCl, HF<br>é«˜ç«åŠ›ãƒ»ä½è€ä¹…</div>
            </div>
            <div class="deck-card" onclick="startGame('counter')">
                <div class="deck-title">ğŸ›¡ï¸ ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼</div>
                <div class="deck-desc">AgCl, Fe2O3<br>æ²ˆæ®¿ã¨ä¸å‹•æ…‹</div>
            </div>
            <div class="deck-card" onclick="startGame('toxic')">
                <div class="deck-title">â˜ ï¸ å®³æ‚ª(æ¯’)</div>
                <div class="deck-desc">CO, H2S<br>å¿…æ®ºã§å³æ­»</div>
            </div>
            <div class="deck-card" onclick="startGame('control')">
                <div class="deck-title">ğŸ§ª ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«</div>
                <div class="deck-desc">NaOH, Al2O3<br>å›å¾©ã¨ä¸¡æ€§</div>
            </div>
            <div class="deck-card" onclick="startGame('gemstone')">
                <div class="deck-title">ğŸ’ å®çŸ³</div>
                <div class="deck-desc">ãƒ€ã‚¤ãƒ¤, ãƒ«ãƒ“ãƒ¼<br>åœ§å€’çš„HP</div>
            </div>
            <div class="deck-card" onclick="startGame('heavy')">
                <div class="deck-title">ğŸ­ é‡é‡‘å±</div>
                <div class="deck-desc">é‡‘, W, Pt<br>å¾ŒåŠæœ€å¼·</div>
            </div>
            <div class="deck-card" onclick="startGame('noble')">
                <div class="deck-title">ğŸˆ è²´ã‚¬ã‚¹</div>
                <div class="deck-desc">He2, Ne2<br>æ½œä¼(è¦2æš)</div>
            </div>
            <div class="deck-card" onclick="startGame('hazard')">
                <div class="deck-title">âš—ï¸ å±é™ºç‰©</div>
                <div class="deck-desc">ç‹æ°´, æ¿ƒç¡«é…¸<br>é™¤å»ã‚¹ãƒšãƒ«</div>
            </div>
        </div>
    </div>

    <div id="game-board">
        <div id="enemy-hand-area"></div>
        <div id="enemy-field" class="area"></div>
        <div id="info-area">
            <div class="leader" id="leader-enemy" onclick="onLeaderClick('enemy')">
                <div class="avatar">ğŸ¤–</div>
                <div class="leader-name" id="enemy-name">CPU</div>
                <div id="enemy-hp" class="hp-circle">25</div>
            </div>
            <div class="turn-info">
                <div id="turn-display">TURN 1</div>
                <div id="mp-display" class="mp-bar">MP 1/1</div>
            </div>
            <button id="btn-end-turn" onclick="endTurn()">çµ‚äº†</button>
            <div class="leader" id="leader-player" onclick="onLeaderClick('player')">
                <div id="player-hp" class="hp-circle">25</div>
                <div class="leader-name">YOU</div>
                <div class="avatar">ğŸ§‘â€ğŸ”¬</div>
            </div>
        </div>
        
        <div id="craftable-list"></div>

        <div id="player-field" class="area"></div>
        <div id="player-hand-area"></div>

        <div id="cancel-attack-btn" onclick="cancelAttack()">âŒ æ”»æ’ƒã‚’ã‚„ã‚ã‚‹</div>

        <div id="card-detail-panel" onclick="hideDetail()">
            <div class="detail-close">Ã—</div>
            <div class="detail-header">
                <div class="detail-symbol" id="detail-symbol"></div>
                <div class="detail-name" id="detail-name"></div>
            </div>
            <div style="text-align:center; margin-bottom:10px; font-weight:bold; font-size:16px;" id="detail-stats"></div>
            <div class="detail-skills" id="detail-skills"></div>
            <div style="text-align:center; margin-top:10px; font-size:10px; color:#777;">(ã‚¿ãƒƒãƒ—ã—ã¦é–‰ã˜ã‚‹)</div>
        </div>
    </div>

    <div class="action-overlay" id="action-btns" style="display:none;">
        <button class="game-btn btn-draw" onclick="actionDraw()">ï¼‹ ãƒ‰ãƒ­ãƒ¼</button>
        <button class="game-btn btn-syn" onclick="actionSynthesize()">âš—ï¸ åˆæˆ</button>
    </div>

    <div id="skill-modal">
        <h3 style="color:white; margin-bottom:15px;">æŠ€ã‚’é¸æŠ</h3>
        <div id="skill-list" class="skill-list"></div>
        <button class="game-btn" style="background:#7f8c8d; margin-top:20px;" onclick="closeSkillModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>

    <div id="msg-box"></div>

    <script>
        const MAX_HAND = 10; 
        const MAX_FIELD = 5;

        // å…¨å…ƒç´ å®šç¾©
        const ELEM = {
            H: { symbol: 'H', name: 'æ°´ç´ ', rarity: 'N' },
            He: { symbol: 'He', name: 'ãƒ˜ãƒªã‚¦ãƒ ', rarity: 'SR' },
            Li: { symbol: 'Li', name: 'ãƒªãƒã‚¦ãƒ ', rarity: 'R' },
            Be: { symbol: 'Be', name: 'ãƒ™ãƒªãƒªã‚¦ãƒ ', rarity: 'R' },
            B: { symbol: 'B', name: 'ãƒ›ã‚¦ç´ ', rarity: 'R' },
            C: { symbol: 'C', name: 'ç‚­ç´ ', rarity: 'N' },
            N: { symbol: 'N', name: 'çª’ç´ ', rarity: 'N' },
            O: { symbol: 'O', name: 'é…¸ç´ ', rarity: 'N' },
            F: { symbol: 'F', name: 'ãƒ•ãƒƒç´ ', rarity: 'SR' },
            Ne: { symbol: 'Ne', name: 'ãƒã‚ªãƒ³', rarity: 'SR' },
            Na: { symbol: 'Na', name: 'ãƒŠãƒˆãƒªã‚¦ãƒ ', rarity: 'N' },
            Mg: { symbol: 'Mg', name: 'ãƒã‚°ãƒã‚·ã‚¦ãƒ ', rarity: 'R' },
            Al: { symbol: 'Al', name: 'ã‚¢ãƒ«ãƒŸãƒ‹ã‚¦ãƒ ', rarity: 'R' },
            Si: { symbol: 'Si', name: 'ã‚±ã‚¤ç´ ', rarity: 'R' },
            P: { symbol: 'P', name: 'ãƒªãƒ³', rarity: 'R' },
            S: { symbol: 'S', name: 'ç¡«é»„', rarity: 'R' },
            Cl: { symbol: 'Cl', name: 'å¡©ç´ ', rarity: 'N' },
            Ar: { symbol: 'Ar', name: 'ã‚¢ãƒ«ã‚´ãƒ³', rarity: 'SR' },
            K: { symbol: 'K', name: 'ã‚«ãƒªã‚¦ãƒ ', rarity: 'N' },
            Ca: { symbol: 'Ca', name: 'ã‚«ãƒ«ã‚·ã‚¦ãƒ ', rarity: 'R' },
            Ti: { symbol: 'Ti', name: 'ãƒã‚¿ãƒ³', rarity: 'SR' },
            V: { symbol: 'V', name: 'ãƒãƒŠã‚¸ã‚¦ãƒ ', rarity: 'SR' },
            Cr: { symbol: 'Cr', name: 'ã‚¯ãƒ­ãƒ ', rarity: 'SR' },
            Mn: { symbol: 'Mn', name: 'ãƒãƒ³ã‚¬ãƒ³', rarity: 'R' },
            Fe: { symbol: 'Fe', name: 'é‰„', rarity: 'N' },
            Ni: { symbol: 'Ni', name: 'ãƒ‹ãƒƒã‚±ãƒ«', rarity: 'R' },
            Cu: { symbol: 'Cu', name: 'éŠ…', rarity: 'N' },
            Zn: { symbol: 'Zn', name: 'äºœé‰›', rarity: 'R' },
            Ga: { symbol: 'Ga', name: 'ã‚¬ãƒªã‚¦ãƒ ', rarity: 'SR' },
            Ge: { symbol: 'Ge', name: 'ã‚²ãƒ«ãƒãƒ‹ã‚¦ãƒ ', rarity: 'SR' },
            Ag: { symbol: 'Ag', name: 'éŠ€', rarity: 'SR' },
            Cd: { symbol: 'Cd', name: 'ã‚«ãƒ‰ãƒŸã‚¦ãƒ ', rarity: 'R' },
            Sn: { symbol: 'Sn', name: 'ã‚¹ã‚º', rarity: 'R' },
            Ba: { symbol: 'Ba', name: 'ãƒãƒªã‚¦ãƒ ', rarity: 'R' },
            W:  { symbol: 'W', name: 'ã‚¿ãƒ³ã‚°ã‚¹ãƒ†ãƒ³', rarity: 'SSR' },
            Pt: { symbol: 'Pt', name: 'ãƒ—ãƒ©ãƒãƒŠ', rarity: 'SSR' },
            Au: { symbol: 'Au', name: 'é‡‘', rarity: 'SSR' },
            Hg: { symbol: 'Hg', name: 'æ°´éŠ€', rarity: 'SR' },
            Pb: { symbol: 'Pb', name: 'é‰›', rarity: 'R' }
        };

        const RECIPES = [
            // é€Ÿæ”»
            { ingredients: ['H', 'Cl'], product: { symbol: 'HCl', name: 'å¡©åŒ–æ°´ç´ ', atk: 5, hp: 1, skills: [{name:'å¼·é…¸è…é£Ÿ', power:5, desc:'é«˜ç«åŠ›ã®é…¸æ”»æ’ƒ'}] }},
            { ingredients: ['H', 'F'], product: { symbol: 'HF', name: 'ãƒ•ãƒƒåŒ–æ°´ç´ ', atk: 4, hp: 2, ability:'toxic', skills: [{name:'ã‚¬ãƒ©ã‚¹è…é£Ÿ', power:4, desc:'é€šå¸¸æ”»æ’ƒ'}, {name:'çŒ›æ¯’', power:0, type:'toxic', desc:'è§¦ã‚Œã‚‹ã¨å±é™º(å¿…æ®º)'}] }},
            { ingredients: ['Na', 'H'], product: { symbol: 'NaH', name: 'æ°´ç´ åŒ–Na', atk: 3, hp: 1, ability:'storm', skills: [{name:'é‚„å…ƒä½œç”¨', power:3, desc:'ç–¾èµ°:å³æ”»æ’ƒå¯èƒ½'}] }},
            { ingredients: ['H', 'H', 'O'], product: { symbol: 'H2O', name: 'æ°´', atk: 1, hp: 4, skills: [{name:'æ°´æµ', power:1, desc:'æ”»æ’ƒ'}, {name:'åŠ æ°´åˆ†è§£', power:3, type:'heal', desc:'ãƒªãƒ¼ãƒ€ãƒ¼ã‚’3å›å¾©'}] }},
            // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
            { ingredients: ['Ag', 'Cl'], product: { symbol: 'AgCl', name: 'å¡©åŒ–éŠ€', atk: 1, hp: 6, ability:'ward', skills: [{name:'æ„Ÿå…‰', power:1, desc:'æ”»æ’ƒ'}, {name:'ç™½è‰²æ²ˆæ®¿', power:0, type:'guard', desc:'å®ˆè­·:å£ã«ãªã‚‹'}] }},
            { ingredients: ['Fe', 'O'], product: { symbol: 'FeO', name: 'é…¸åŒ–é‰„(II)', atk: 3, hp: 5, skills: [{name:'é»’éŒ†', power:3, desc:'é€šå¸¸æ”»æ’ƒ'}] }},
            { ingredients: ['Fe', 'O', 'O'], product: { symbol: 'Fe2O3', name: 'èµ¤éŒ†(ä¸å‹•æ…‹)', atk: 2, hp: 8, ability:'ward', skills: [{name:'ä¸å‹•æ…‹çš®è†œ', power:2, desc:'é«˜ã„é˜²å¾¡åŠ›ã§å®ˆã‚‹'}] }},
            { ingredients: ['Cu', 'O'], product: { symbol: 'CuO', name: 'é…¸åŒ–éŠ…(II)', atk: 3, hp: 4, skills: [{name:'é»’è‰²ç²‰æœ«', power:3, desc:'é€šå¸¸æ”»æ’ƒ'}] }},
            { ingredients: ['Zn', 'Cu'], product: { symbol: 'Brass', name: 'é»„éŠ…', atk: 4, hp: 5, skills: [{name:'åˆé‡‘ã‚¢ã‚¿ãƒƒã‚¯', power:4, desc:'å®‰å®šã—ãŸå¼·ã•'}] }},
            { ingredients: ['Hg', 'Zn'], product: { symbol: 'Amalgam', name: 'äºœé‰›ã‚¢ãƒãƒ«ã‚¬ãƒ ', atk: 3, hp: 6, ability:'ward', skills: [{name:'ã‚¢ãƒãƒ«ã‚¬ãƒ åŒ–', power:3, desc:'å®ˆè­·ã‚’æŒã¤åˆé‡‘'}] }},
            // å®³æ‚ª
            { ingredients: ['C', 'O'], product: { symbol: 'CO', name: 'ä¸€é…¸åŒ–ç‚­ç´ ', atk: 1, hp: 2, ability:'toxic', skills: [{name:'ä¸å®Œå…¨ç‡ƒç„¼', power:1, desc:'æ”»æ’ƒ'}, {name:'ãƒ˜ãƒ¢ã‚°ãƒ­ãƒ“ãƒ³çµåˆ', power:0, type:'toxic', desc:'å¿…æ®º:å³æ­»ã•ã›ã‚‹'}] }},
            { ingredients: ['H', 'S'], product: { symbol: 'H2S', name: 'ç¡«åŒ–æ°´ç´ ', atk: 2, hp: 3, ability:'toxic', skills: [{name:'è…åµè‡­', power:2, desc:'æ”»æ’ƒ'}, {name:'ç¡«åŒ–', power:0, type:'toxic', desc:'å¿…æ®ºæ”»æ’ƒ'}] }},
            { ingredients: ['Cl', 'Cl'], product: { symbol: 'Cl2', name: 'å¡©ç´ ã‚¬ã‚¹', atk: 3, hp: 3, skills: [{name:'é…¸åŒ–ä½œç”¨', power:3, desc:'æ”»æ’ƒ'}, {name:'æ¯’ã‚¬ã‚¹æ•£å¸ƒ', power:2, type:'aoe', desc:'æ•µå…¨ä½“ã«2ãƒ€ãƒ¡ãƒ¼ã‚¸'}] }},
            { ingredients: ['S', 'O', 'O'], product: { symbol: 'SO2', name: 'äºŒé…¸åŒ–ç¡«é»„', atk: 2, hp: 4, skills: [{name:'æ¼‚ç™½', power:2, desc:'æ”»æ’ƒ'}, {name:'é…¸æ€§é›¨', power:1, type:'aoe', desc:'æ•µå…¨ä½“ã«1ãƒ€ãƒ¡ãƒ¼ã‚¸'}] }},
            { ingredients: ['Cd', 'S'], product: { symbol: 'CdS', name: 'ç¡«åŒ–ã‚«ãƒ‰ãƒŸã‚¦ãƒ ', atk: 2, hp: 5, ability:'toxic', skills: [{name:'ã‚¤ã‚¿ã‚¤ã‚¤ã‚¿ã‚¤', power:0, type:'toxic', desc:'çŒ›æ¯’:è§¦ã‚Œã‚‹ã¨å³æ­»'}] }},
            // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
            { ingredients: ['Na', 'O', 'H'], product: { symbol: 'NaOH', name: 'æ°´é…¸åŒ–Na', atk: 3, hp: 3, skills: [{name:'æ½®è§£', power:3, desc:'æ”»æ’ƒ'}, {name:'ä¸­å’Œç†±', power:2, type:'aoe_heal', desc:'æ•µå…¨ä½“2ãƒ€ãƒ¡/è‡ªåˆ†2å›å¾©'}] }},
            { ingredients: ['Al', 'O', 'O'], product: { symbol: 'Al2O3', name: 'ã‚¢ãƒ«ãƒŸãƒŠ', atk: 2, hp: 7, ability:'ward', skills: [{name:'ã‚¢ãƒ«ãƒã‚¤ãƒˆ', power:2, desc:'é…¸åŒ–è¢«è†œãƒãƒªã‚¢'}] }},
            { ingredients: ['Cl', 'Na'], product: { symbol: 'NaCl', name: 'å¡©åŒ–Na', atk: 3, hp: 4, skills: [{name:'å¡©å‘³', power:3, desc:'é€šå¸¸æ”»æ’ƒ'}] }},
            { ingredients: ['Ca', 'O', 'H', 'H'], product: { symbol: 'Ca(OH)2', name: 'æ¶ˆçŸ³ç°', atk: 1, hp: 6, ability:'ward', skills: [{name:'çŸ³ç°æ°´', power:1, desc:'æ”»æ’ƒ'}, {name:'ä¸­å’Œåå¿œ', power:4, type:'heal', desc:'HP4å›å¾©'}] }},
            // å®çŸ³
            { ingredients: ['C', 'C', 'C'], product: { symbol: 'Diamond', name: 'ãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ³ãƒ‰', atk: 4, hp: 10, ability:'ward', skills: [{name:'ãƒ¢ãƒ¼ã‚¹ç¡¬åº¦10', power:4, desc:'æœ€å¼·ã®ç¡¬åº¦'}] }},
            { ingredients: ['Al', 'O', 'O', 'Cr'], product: { symbol: 'Ruby', name: 'ãƒ«ãƒ“ãƒ¼', atk: 5, hp: 8, skills: [{name:'æ·±ç´…ã®è¼ã', power:5, desc:'é«˜ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'}] }},
            { ingredients: ['Al', 'O', 'Ti'], product: { symbol: 'Sapphire', name: 'ã‚µãƒ•ã‚¡ã‚¤ã‚¢', atk: 4, hp: 9, skills: [{name:'é’ç‰', power:4, desc:'é«˜è€ä¹…'}] }},
            { ingredients: ['Si', 'O', 'O'], product: { symbol: 'SiO2', name: 'çŸ³è‹±(æ°´æ™¶)', atk: 3, hp: 6, skills: [{name:'åœ§é›»åŠ¹æœ', power:3, desc:'æ”»æ’ƒ'}, {name:'çµæ™¶åŒ–', power:2, type:'aoe', desc:'å…¨ä½“2ãƒ€ãƒ¡ãƒ¼ã‚¸'}] }},
            // é‡é‡‘å±
            { ingredients: ['Au'], product: { symbol: 'Au', name: 'é‡‘', atk: 6, hp: 6, skills: [{name:'ä¸å¤‰ã®è¼ã', power:6, desc:'ç‹æ°´ä»¥å¤–ç„¡æ•µã®æ”»æ’ƒ'}] }},
            { ingredients: ['Pt'], product: { symbol: 'Pt', name: 'ãƒ—ãƒ©ãƒãƒŠ', atk: 5, hp: 7, skills: [{name:'è§¦åª’ä½œç”¨', power:5, desc:'åå¿œã‚’ä¿ƒé€²ã™ã‚‹ä¸€æ’ƒ'}] }},
            { ingredients: ['W'], product: { symbol: 'W', name: 'ã‚¿ãƒ³ã‚°ã‚¹ãƒ†ãƒ³', atk: 7, hp: 8, ability:'ward', skills: [{name:'èç‚¹3422â„ƒ', power:7, desc:'ç†±ã«å¼·ã„ä¸€æ’ƒ'}] }},
            { ingredients: ['Ti'], product: { symbol: 'Ti', name: 'ãƒã‚¿ãƒ³', atk: 4, hp: 5, skills: [{name:'é«˜å¼·åº¦', power:4, desc:'è»½ãã¦å¼·ã„'}] }},
            // è²´ã‚¬ã‚¹ (2æšå¿…è¦)
            { ingredients: ['He', 'He'], product: { symbol: 'He', name: 'ãƒ˜ãƒªã‚¦ãƒ ', atk: 2, hp: 2, ability:'stealth', skills: [{name:'ä¸æ´»æ€§', power:2, desc:'æ½œä¼æ”»æ’ƒ'}] }},
            { ingredients: ['Ne', 'Ne'], product: { symbol: 'Ne', name: 'ãƒã‚ªãƒ³', atk: 3, hp: 3, ability:'stealth', skills: [{name:'ãƒã‚ªãƒ³ã‚µã‚¤ãƒ³', power:3, desc:'æ½œä¼æ”»æ’ƒ'}] }},
            { ingredients: ['Ar', 'Ar'], product: { symbol: 'Ar', name: 'ã‚¢ãƒ«ã‚´ãƒ³', atk: 4, hp: 4, ability:'stealth', skills: [{name:'ãƒ•ã‚£ãƒ©ãƒ¡ãƒ³ãƒˆä¿è­·', power:4, desc:'æ½œä¼æ”»æ’ƒ'}] }},
            // å±é™ºç‰©
            { ingredients: ['H', 'Cl', 'N', 'O', 'O', 'O'], product: { symbol: 'AquaRegia', name: 'ç‹æ°´', atk: 0, hp: 0, type:'spell', skills: [{name:'é‡‘æº¶ã‹ã—', power:99, type:'toxic', desc:'å˜ä½“ç¢ºå®šé™¤å»'}] }},
            { ingredients: ['H', 'H', 'S', 'O', 'O', 'O', 'O'], product: { symbol: 'H2SO4', name: 'æ¿ƒç¡«é…¸', atk: 0, hp: 0, type:'spell', skills: [{name:'è„±æ°´ä½œç”¨', power:5, type:'aoe', desc:'æ•µå…¨ä½“5ãƒ€ãƒ¡ãƒ¼ã‚¸'}] }},
            { ingredients: ['K', 'Mn', 'O', 'O', 'O', 'O'], product: { symbol: 'KMnO4', name: 'éãƒãƒ³ã‚¬ãƒ³é…¸K', atk: 0, hp: 0, type:'spell', skills: [{name:'å¼·åŠ›é…¸åŒ–', power:7, type:'damage', desc:'å˜ä½“7ãƒ€ãƒ¡ãƒ¼ã‚¸'}] }},
        ];

        // ãƒ‡ãƒƒã‚­æ§‹æˆ (è²´ã‚¬ã‚¹å¢—é‡)
        const DECKS = {
            aggro: { name: 'è¶…é€Ÿæ”»', elements: ['H', 'H', 'Cl', 'F', 'Na', 'O'], recipes: ['HCl', 'HF', 'NaH', 'H2O'] },
            counter: { name: 'ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼', elements: ['Ag', 'Cl', 'Fe', 'O', 'Cu', 'Zn', 'Hg'], recipes: ['AgCl', 'FeO', 'Fe2O3', 'Brass', 'Amalgam', 'CuO'] },
            toxic: { name: 'å®³æ‚ª', elements: ['C', 'O', 'S', 'H', 'Cl', 'Cd'], recipes: ['CO', 'H2S', 'Cl2', 'SO2', 'CdS'] },
            control: { name: 'ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«', elements: ['Al', 'O', 'H', 'Na', 'Cl', 'Ca'], recipes: ['Al2O3', 'NaOH', 'H2O', 'NaCl', 'Ca(OH)2'] },
            gemstone: { name: 'å®çŸ³', elements: ['C', 'Al', 'O', 'Si', 'Cr', 'Ti'], recipes: ['Diamond', 'Ruby', 'Sapphire', 'SiO2'] },
            heavy: { name: 'é‡é‡‘å±', elements: ['Au', 'Pt', 'W', 'Ti', 'Fe'], recipes: ['Au', 'Pt', 'W', 'Ti'] },
            noble: { name: 'è²´ã‚¬ã‚¹', elements: ['He', 'He', 'Ne', 'Ne', 'Ar', 'Ar'], recipes: ['He', 'Ne', 'Ar'] },
            hazard: { name: 'å±é™ºç‰©', elements: ['H', 'Cl', 'N', 'O', 'S', 'K', 'Mn'], recipes: ['AquaRegia', 'H2SO4', 'KMnO4'] }
        };

        let gs = {
            playerDeck: null, enemyDeck: null,
            playerPool: [], enemyPool: [],
            playerRecipes: [], enemyRecipes: [],
            turn: 1, isPlayerTurn: true, mp: 1, maxMp: 1,
            player: { hp: 25, hand: [], field: [] },
            enemy: { hp: 25, hand: [], field: [], mp: 1, maxMp: 1 },
            selectedHandIds: [], attackingUnit: null,
        };

        /* --- ã‚¹ã‚¿ãƒ¼ãƒˆå‡¦ç† --- */
        function startGame(playerDeckKey) {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('game-board').style.display = 'flex';
            document.getElementById('action-btns').style.display = 'flex';

            const pConf = DECKS[playerDeckKey];
            gs.playerPool = pConf.elements.map(sym => ELEM[sym]);
            gs.playerRecipes = RECIPES.filter(r => pConf.recipes.includes(r.product.symbol));

            // CPU Random
            const keys = Object.keys(DECKS);
            const cpuKey = keys[Math.floor(Math.random() * keys.length)];
            const eConf = DECKS[cpuKey];
            gs.enemyPool = eConf.elements.map(sym => ELEM[sym]);
            gs.enemyRecipes = RECIPES.filter(r => eConf.recipes.includes(r.product.symbol));
            
            document.getElementById('enemy-name').innerText = `CPU (${eConf.name})`;

            for(let i=0; i<5; i++) { drawCard(gs.player); drawCard(gs.enemy); }
            showMessage("DUEL START!");
            updateView();
        }

        function drawCard(target) {
            const pool = (target === gs.enemy) ? gs.enemyPool : gs.playerPool;
            if (target.hand.length >= MAX_HAND) {
                if(target === gs.enemy) target.hand.shift();
                else return null; 
            }
            const base = pool[Math.floor(Math.random() * pool.length)];
            const card = { ...base, id: Math.random().toString(36).substr(2, 9), type: 'element' };
            target.hand.push(card);
            return card;
        }

        function actionDraw() {
            if(!gs.isPlayerTurn || gs.mp < 1) { showMessage("MPä¸è¶³/æ‰‹ç•ªå¤–"); return; }
            gs.mp--;
            drawCard(gs.player);
            updateView();
        }

        function actionSynthesize() {
            if(!gs.isPlayerTurn) return;
            if(gs.selectedHandIds.length === 0) return;

            // å˜ä½“é‡‘å±ãªã© (1æšåˆæˆ)
            if(gs.selectedHandIds.length === 1) {
                const card = gs.player.hand.find(c => c.id === gs.selectedHandIds[0]);
                const singleRecipe = gs.playerRecipes.find(r => r.ingredients.length === 1 && r.ingredients[0] === card.symbol);
                if(singleRecipe) { processSynth(singleRecipe); return; }
            }

            const selCards = gs.player.hand.filter(c => gs.selectedHandIds.includes(c.id));
            const symbols = selCards.map(c => c.symbol).sort();
            const recipe = gs.playerRecipes.find(r => JSON.stringify(r.ingredients.sort()) === JSON.stringify(symbols));

            if(recipe) processSynth(recipe);
            else { showMessage("åå¿œã—ã¾ã›ã‚“"); gs.selectedHandIds = []; updateView(); }
        }

        function processSynth(recipe) {
            // ã‚¹ãƒšãƒ«
            if(recipe.product.type === 'spell') {
                const skill = recipe.product.skills[0];
                gs.player.hand = gs.player.hand.filter(c => !gs.selectedHandIds.includes(c.id));
                gs.selectedHandIds = [];
                if(gs.enemy.field.length > 0) {
                    const target = gs.enemy.field.reduce((a,b)=>a.currentHp>b.currentHp?a:b);
                    showMessage(`${skill.name} -> ${target.name}!`);
                    if(skill.type === 'toxic') target.currentHp = -99;
                    else target.currentHp -= skill.power;
                } else {
                    showMessage(`${skill.name} -> ãƒªãƒ¼ãƒ€ãƒ¼!`);
                    gs.enemy.hp -= skill.power;
                }
                checkGameEnd(); updateView(); return;
            }

            // ãƒ¦ãƒ‹ãƒƒãƒˆ
            if(gs.player.field.length >= MAX_FIELD) { showMessage("ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æº€å“¡"); return; }
            gs.player.hand = gs.player.hand.filter(c => !gs.selectedHandIds.includes(c.id));
            gs.selectedHandIds = [];
            const unit = { ...recipe.product, id: Math.random().toString(36).substr(2, 9), maxHp: recipe.product.hp, currentHp: recipe.product.hp, canAttack: recipe.product.ability === 'storm', type: 'unit' };
            gs.player.field.push(unit);
            showMessage(`å¬å–šï¼ ${unit.name}`);
            updateView();
        }

        /* --- ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ --- */
        function onHandClick(id) {
            if(!gs.isPlayerTurn) return;
            // è©³ç´°è¡¨ç¤º
            const card = gs.player.hand.find(c => c.id === id);
            if(card) showDetail(card);

            // é¸æŠ
            if(gs.selectedHandIds.includes(id)) gs.selectedHandIds = gs.selectedHandIds.filter(x => x !== id);
            else gs.selectedHandIds.push(id);
            updateView();
        }

        function onFieldCardClick(id, isPlayer) {
            if(!gs.isPlayerTurn) return;
            if(isPlayer) {
                const u = gs.player.field.find(x => x.id === id);
                if(u) showDetail(u);
                if(u && u.canAttack) {
                    gs.attackingUnit = u;
                    document.body.classList.add('targeting');
                    updateView(); // ã“ã“ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹
                }
            } else if(gs.attackingUnit) {
                const target = gs.enemy.field.find(x => x.id === id);
                if(target) showDetail(target);
                if(target.ability === 'stealth') { showMessage("æ½œä¼ä¸­ã§é¸ã¹ãªã„ï¼"); return; }
                prepareAttack(gs.attackingUnit, target, 'unit');
            } else {
                const target = gs.enemy.field.find(x => x.id === id);
                if(target) showDetail(target);
            }
        }

        function onLeaderClick(side) {
            if(!gs.isPlayerTurn || side !== 'enemy' || !gs.attackingUnit) return;
            prepareAttack(gs.attackingUnit, 'leader', 'leader');
        }

        function prepareAttack(attacker, target, type) {
            if(type === 'leader' || (type === 'unit' && target.ability !== 'ward')) {
                const guards = gs.enemy.field.filter(u => u.ability === 'ward' && u.ability !== 'stealth');
                if(guards.length > 0) { showMessage("å®ˆè­·ã«é˜»ã¾ã‚ŒãŸï¼"); return; }
            }
            if(attacker.skills.length > 1) openSkillModal(attacker, target);
            else executeSkill(attacker, target, attacker.skills[0]);
        }

        function openSkillModal(attacker, target) {
            const modal = document.getElementById('skill-modal');
            const list = document.getElementById('skill-list');
            list.innerHTML = '';
            attacker.skills.forEach(skill => {
                const btn = document.createElement('div');
                btn.className = 'skill-btn';
                let typeLabel = skill.type ? skill.type.toUpperCase() : 'NORMAL';
                btn.innerHTML = `<span class="skill-name">${skill.name} <span style="float:right; color:#e67e22">å¨åŠ›:${skill.power}</span></span><span class="skill-desc">${skill.desc}</span>`;
                btn.onclick = () => { executeSkill(attacker, target, skill); closeSkillModal(); };
                list.appendChild(btn);
            });
            modal.style.display = 'flex';
        }
        function closeSkillModal() { document.getElementById('skill-modal').style.display = 'none'; cancelAttack(); }

        function executeSkill(attacker, target, skill) {
            let log = `${skill.name}!`;
            if(skill.type === 'aoe') {
                gs.enemy.field.forEach(u => u.currentHp -= skill.power); gs.enemy.hp -= skill.power;
            } else if(skill.type === 'aoe_heal') {
                gs.enemy.field.forEach(u => u.currentHp -= skill.power); gs.player.hp += skill.power;
            } else if(skill.type === 'heal') {
                gs.player.hp += skill.power;
            } else {
                const dmg = skill.power;
                if(target === 'leader') gs.enemy.hp -= dmg;
                else {
                    const counter = target.atk;
                    if(skill.type === 'toxic' && dmg > 0) target.currentHp = -99;
                    else target.currentHp -= dmg;
                    if(target.currentHp <= 0 && target.ability === 'toxic' && counter > 0) attacker.currentHp = -99;
                    else attacker.currentHp -= counter;
                }
            }
            attacker.canAttack = false; showMessage(log); cancelAttack(); checkGameEnd(); updateView();
        }

        // â˜… ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ©Ÿèƒ½
        function cancelAttack() { 
            gs.attackingUnit = null; 
            document.body.classList.remove('targeting'); 
            updateView(); 
        }

        function checkGameEnd() {
            gs.player.field = gs.player.field.filter(u => u.currentHp > 0);
            gs.enemy.field = gs.enemy.field.filter(u => u.currentHp > 0);
            if(gs.enemy.hp <= 0) alert("VICTORY! åŒ–å­¦ã®å‹åˆ©ï¼");
            if(gs.player.hp <= 0) alert("DEFEAT... å®Ÿé¨“å¤±æ•—...");
        }

        function endTurn() {
            if(!gs.isPlayerTurn) return;
            gs.isPlayerTurn = false; cancelAttack(); document.getElementById('btn-end-turn').disabled = true;
            showMessage("ENEMY TURN"); setTimeout(cpuTurn, 1000);
        }

        async function cpuTurn() {
            if(gs.enemy.maxMp < 10) gs.enemy.maxMp++; gs.enemy.mp = gs.enemy.maxMp;
            drawCard(gs.enemy); updateView(); await sleep(800);
            
            let acted = true;
            while(acted && gs.enemy.field.length < MAX_FIELD) {
                acted = false;
                const handSym = gs.enemy.hand.map(c => c.symbol);
                for(const r of gs.enemyRecipes) {
                    if(r.product.type === 'spell') continue;
                    const ingredients = [...r.ingredients];
                    const tempHand = [...handSym];
                    let possible = true;
                    for(const ing of ingredients) {
                        const idx = tempHand.indexOf(ing);
                        if(idx === -1) { possible = false; break; }
                        tempHand.splice(idx, 1);
                    }
                    if(possible) {
                        for(const ing of r.ingredients) {
                            const idx = gs.enemy.hand.findIndex(c => c.symbol === ing);
                            gs.enemy.hand.splice(idx, 1);
                        }
                        const unit = { ...r.product, id: Math.random(), maxHp: r.product.hp, currentHp: r.product.hp, canAttack:false, type:'unit'};
                        gs.enemy.field.push(unit);
                        showMessage(`CPUå¬å–š: ${unit.name}`);
                        await sleep(800); updateView(); acted = true; break;
                    }
                }
            }
            gs.enemy.field.forEach(u => u.canAttack = true);
            for(const u of gs.enemy.field) {
                if(!u.canAttack) continue;
                const guards = gs.player.field.filter(g => g.ability === 'ward' && g.ability !== 'stealth');
                let target = 'leader';
                if(guards.length > 0) target = guards[0];
                if(target === 'leader') {
                    gs.player.hp -= u.skills[0].power; showMessage(`CPUæ”»æ’ƒ -> ãƒªãƒ¼ãƒ€ãƒ¼!`);
                } else {
                    const dmg = u.skills[0].power;
                    const toxic = u.skills[0].type === 'toxic';
                    if(toxic && dmg > 0) target.currentHp = -99; else target.currentHp -= dmg;
                    u.currentHp -= target.atk; showMessage(`CPUæ”»æ’ƒ -> ${target.name}!`);
                }
                checkGameEnd(); updateView(); await sleep(800);
            }
            startPlayerTurn();
        }

        function startPlayerTurn() {
            gs.turn++; if(gs.maxMp < 10) gs.maxMp++; gs.mp = gs.maxMp;
            gs.isPlayerTurn = true; document.getElementById('btn-end-turn').disabled = false;
            gs.player.field.forEach(u => u.canAttack = true);
            drawCard(gs.player); showMessage("YOUR TURN"); updateView();
        }
        const sleep = m => new Promise(r => setTimeout(r, m));

        function updateView() {
            document.getElementById('turn-display').innerText = `TURN ${gs.turn}`;
            document.getElementById('mp-display').innerText = `MP ${gs.mp}/${gs.maxMp}`;
            document.getElementById('player-hp').innerText = gs.player.hp;
            document.getElementById('enemy-hp').innerText = gs.enemy.hp;
            
            // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            const cancelBtn = document.getElementById('cancel-attack-btn');
            if(gs.attackingUnit) cancelBtn.style.display = 'block';
            else cancelBtn.style.display = 'none';

            renderCards('player-hand-area', gs.player.hand, 'hand');
            renderCards('player-field', gs.player.field, 'field', true);
            renderCards('enemy-field', gs.enemy.field, 'field', false);
            
            const eh = document.getElementById('enemy-hand-area'); eh.innerHTML = '';
            gs.enemy.hand.forEach(() => { const d = document.createElement('div'); d.className = 'card'; d.style.background='#34495e'; d.style.width='30px'; d.style.height='45px'; eh.appendChild(d); });
            updateHint();
        }

        function showDetail(card) {
            const p = document.getElementById('card-detail-panel'); p.style.display = 'flex';
            document.getElementById('detail-symbol').innerText = card.symbol;
            document.getElementById('detail-name').innerText = card.name;
            const stats = document.getElementById('detail-stats');
            const skills = document.getElementById('detail-skills');
            skills.innerHTML = '';

            if(card.type === 'element') {
                stats.innerHTML = `<span style="font-size:14px; color:#ccc">ç´ æã‚«ãƒ¼ãƒ‰</span>`;
                skills.innerHTML = `<div class="skill-item"><div class="skill-item-desc">ãƒ‡ãƒƒã‚­ç´ æã€‚åˆæˆã«ä½¿ç”¨ã—ã¾ã™ã€‚<br>ãƒ¬ã‚¢ãƒªãƒ†ã‚£: ${card.rarity}</div></div>`;
            } else {
                stats.innerHTML = `<span style="color:#e67e22">âš”ï¸ ${card.atk}</span> <span style="color:#2ecc71">â¤ï¸ ${card.currentHp}/${card.maxHp}</span>`;
                if(card.ability === 'ward') skills.innerHTML += `<div class="skill-item"><div class="skill-item-name">ğŸ›¡ï¸ å®ˆè­·</div><div class="skill-item-desc">ç›¸æ‰‹ã¯ã“ã‚Œä»¥å¤–ã‚’æ”»æ’ƒã§ããªã„</div></div>`;
                if(card.ability === 'toxic') skills.innerHTML += `<div class="skill-item"><div class="skill-item-name">â˜ ï¸ æ¯’</div><div class="skill-item-desc">ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆãŸæ•µã‚’å³æ­»ã•ã›ã‚‹</div></div>`;
                if(card.ability === 'storm') skills.innerHTML += `<div class="skill-item"><div class="skill-item-name">âš¡ ç–¾èµ°</div><div class="skill-item-desc">å‡ºã—ãŸã‚¿ãƒ¼ãƒ³ã«æ”»æ’ƒã§ãã‚‹</div></div>`;
                if(card.ability === 'stealth') skills.innerHTML += `<div class="skill-item"><div class="skill-item-name">ğŸ‘ï¸ æ½œä¼</div><div class="skill-item-desc">æ”»æ’ƒã™ã‚‹ã¾ã§é¸ã°ã‚Œãªã„</div></div>`;
                card.skills.forEach(s => {
                    let type = s.type ? s.type : 'é€šå¸¸';
                    skills.innerHTML += `<div class="skill-item"><div class="skill-item-name">${s.name} (å¨åŠ›:${s.power})</div><div class="skill-item-desc">${s.desc} [${type}]</div></div>`;
                });
            }
        }
        function hideDetail() { document.getElementById('card-detail-panel').style.display = 'none'; }

        function renderCards(id, cards, type, isPlayer) {
            const el = document.getElementById(id); el.innerHTML = '';
            cards.forEach(c => {
                const div = document.createElement('div'); div.className = 'card';
                
                // ã‚¿ãƒƒãƒ—ã§è©³ç´° (ã‚¹ãƒãƒ›å‘ã‘)
                div.onclick = (e) => {
                    e.stopPropagation();
                    if(type === 'hand') onHandClick(c.id);
                    if(type === 'field') onFieldCardClick(c.id, isPlayer);
                };

                if(type === 'hand' && gs.selectedHandIds.includes(c.id)) div.classList.add('selected');
                if(type === 'field' && c.canAttack && isPlayer) div.classList.add('can-attack');
                if(type === 'field' && !isPlayer && gs.attackingUnit && c.ability !== 'stealth') {
                    const hasWard = gs.enemy.field.some(u => u.ability === 'ward' && u.ability !== 'stealth');
                    if(!hasWard || c.ability === 'ward') div.classList.add('valid-target');
                }
                
                let content = '';
                if(c.type === 'element') {
                    content = `<div class="card-symbol">${c.symbol}</div><div class="card-name">${c.name}</div>`;
                } else {
                    let badges = `<div class="ability-container">`;
                    if(c.ability === 'ward') badges += `<div class="badge badge-ward">ğŸ›¡ï¸</div>`;
                    if(c.ability === 'toxic') badges += `<div class="badge badge-toxic">â˜ ï¸</div>`;
                    if(c.ability === 'storm') badges += `<div class="badge badge-storm">âš¡</div>`;
                    if(c.ability === 'stealth') badges += `<div class="badge badge-stealth">ğŸ‘ï¸</div>`;
                    badges += `</div>`;
                    content = `${badges}<div class="card-symbol" style="color:#3498db">${c.symbol}</div><div class="card-name">${c.name}</div><div class="stats"><span class="stat-atk">âš”ï¸${c.atk}</span><span class="stat-hp">â¤ï¸${c.currentHp}</span></div>`;
                }
                div.innerHTML = content;
                el.appendChild(div);
            });
        }

        function updateHint() {
            const list = document.getElementById('craftable-list'); list.innerHTML = '';
            if(!gs.isPlayerTurn) return;
            gs.playerRecipes.forEach(r => {
                const handSym = gs.player.hand.map(c => c.symbol);
                let possible = true;
                for(const ing of r.ingredients) {
                    const idx = handSym.indexOf(ing);
                    if(idx === -1) { possible = false; break; }
                    handSym.splice(idx, 1);
                }
                if(possible) {
                    const btn = document.createElement('div'); btn.className = 'craft-hint-btn';
                    let badges = '';
                    if(r.product.ability === 'ward') badges += 'ğŸ›¡ï¸';
                    if(r.product.ability === 'toxic') badges += 'â˜ ï¸';
                    if(r.product.ability === 'storm') badges += 'âš¡';
                    btn.innerHTML = `<div style="font-size:12px; font-weight:bold; color:#f1c40f;">âœ¨ ${r.product.name}</div><div style="font-size:10px; display:flex; gap:5px; margin-top:2px;"><span style="color:#e67e22;">âš”ï¸${r.product.atk}</span><span style="color:#2ecc71;">â¤ï¸${r.product.hp}</span><span>${badges}</span></div>`;
                    btn.onclick = () => autoSelect(r.ingredients);
                    list.appendChild(btn);
                }
            });
        }
        function autoSelect(ingredients) {
            gs.selectedHandIds = []; const tempHand = [...gs.player.hand];
            ingredients.forEach(ing => {
                const idx = tempHand.findIndex(c => c.symbol === ing);
                if(idx !== -1) { gs.selectedHandIds.push(tempHand[idx].id); tempHand.splice(idx, 1); }
            });
            updateView();
        }
        function showMessage(txt) { const box = document.getElementById('msg-box'); box.innerText = txt; box.style.opacity = 1; setTimeout(() => box.style.opacity = 0, 1500); }

    </script>
</body>
</html>