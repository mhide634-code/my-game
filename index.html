<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Chem-Verse: Fixed</title>
<link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&family=Orbitron:wght@700&display=swap" rel="stylesheet">
<style>
    :root { --bg:#1a1a1d; --acc:#f1c40f; --pri:#3498db; --dang:#e74c3c; --succ:#2ecc71; --n:#95a5a6; --r:#3498db; --sr:#9b59b6; --ssr:#f1c40f; }
    body { font-family:'M PLUS Rounded 1c',sans-serif; background:var(--bg); color:white; margin:0; user-select:none; overflow:hidden; height:100vh; width:100vw; -webkit-tap-highlight-color:transparent; }
    .screen { position:absolute; top:0; left:0; width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; background:linear-gradient(135deg,#0f0c29,#302b63,#24243e); z-index:100; transition:opacity 0.3s; }
    .hidden { display:none!important; opacity:0; pointer-events:none; }

    /* CSS Art */
    .css-art { width:100%; height:100%; position:relative; display:flex; justify-content:center; align-items:center; overflow:hidden; }
    .art-gas { background:linear-gradient(to top,#89f7fe,#66a6ff); } .art-gas::after { content:'‚òÅÔ∏è'; font-size:24px; filter:drop-shadow(0 0 5px white); animation:float 3s infinite ease-in-out; }
    .art-liq { background:linear-gradient(to bottom,#4facfe,#00f2fe); } .art-liq::after { content:'üíß'; font-size:24px; animation:bounce 2s infinite; }
    .art-sol { background:linear-gradient(to bottom,#e6b980,#eacda3); } .art-sol::after { content:'ü™®'; font-size:24px; }
    .art-met { background:linear-gradient(135deg,#f7971e,#ffd200); } .art-met::after { content:'‚ú®'; font-size:24px; text-shadow:0 0 5px white; }
    .art-tox { background:linear-gradient(to bottom,#f093fb,#f5576c); } .art-tox::after { content:'‚ò†Ô∏è'; font-size:24px; filter:drop-shadow(0 0 5px purple); }
    .art-H { background:linear-gradient(to top,#a1c4fd,#c2e9fb); } .art-H::after { content:'(‚Ä¢œâ‚Ä¢)'; font-size:12px; background:white; padding:4px; border-radius:50%; color:#333; }
    .art-Cl { background:linear-gradient(to top,#d4fc79,#96e6a1); } .art-Cl::after { content:'ü§¢'; font-size:24px; }
    .art-Au { background:radial-gradient(circle,#ffd700,#b8860b); } .art-Au::after { content:'üí∞'; font-size:28px; }
    @keyframes float { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-5px);} }
    @keyframes bounce { 0%,100%{transform:scale(1);} 50%{transform:scale(1.1);} }

    /* UI */
    #title-screen { background:radial-gradient(circle at center,#2c3e50,#000); }
    .logo { font-family:'Orbitron',sans-serif; font-size:40px; color:var(--acc); text-shadow:0 0 20px var(--acc); margin-bottom:20px; text-align:center; }
    .menu-btn { background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.3); color:white; padding:15px 40px; border-radius:30px; font-weight:bold; cursor:pointer; margin:10px; }
    
    #deck-screen { padding:20px; box-sizing:border-box; overflow-y:auto; display:block; }
    .d-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; padding-bottom:60px; }
    .d-card { background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); padding:15px; border-radius:12px; cursor:pointer; min-height:100px; display:flex; flex-direction:column; justify-content:space-between; }
    .d-title { font-weight:bold; color:var(--acc); margin-bottom:5px; } .d-desc { font-size:10px; color:#ccc; }
    .back-btn { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#333; padding:10px 30px; border-radius:20px; z-index:200; cursor:pointer;}

    #board { display:none; flex-direction:column; height:100vh; background:#111; position:relative; }
    #e-hand { height:10%; background:rgba(0,0,0,0.3); display:flex; justify-content:center; align-items:center; gap:2px; }
    #e-field { height:23%; border-bottom:2px solid #333; display:flex; justify-content:center; align-items:center; }
    #info { height:12%; background:rgba(20,20,30,0.9); display:flex; justify-content:space-between; align-items:center; padding:0 10px; z-index:10; border-top:1px solid #333; border-bottom:1px solid #333; }
    #p-field { height:23%; border-top:2px solid #333; display:flex; justify-content:center; align-items:center; }
    #p-hand { height:32%; background:rgba(0,0,0,0.2); overflow-x:auto; display:flex; align-items:center; padding-left:10px; gap:8px; }

    .card { width:70px; height:100px; background:#222; border-radius:8px; border:2px solid #555; margin:3px; position:relative; flex-shrink:0; box-shadow:0 4px 8px rgba(0,0,0,0.5); overflow:hidden; transition:transform 0.1s; }
    .card[data-r="N"]{border-color:var(--n);} .card[data-r="R"]{border-color:var(--r);box-shadow:0 0 5px var(--r);} .card[data-r="SR"]{border-color:var(--sr);box-shadow:0 0 8px var(--sr);} .card[data-r="SSR"]{border-color:var(--ssr);box-shadow:0 0 10px var(--ssr);animation:holo 3s infinite linear;}
    @keyframes holo { 0%{filter:brightness(1);} 50%{filter:brightness(1.3);} 100%{filter:brightness(1);} }

    .c-art { width:100%; height:55%; position:relative; }
    .c-info { height:45%; background:rgba(30,30,30,0.95); padding:2px; display:flex; flex-direction:column; justify-content:space-between; }
    .c-sym { font-size:14px; font-weight:bold; color:var(--pri); text-align:center; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:2; display:none; }
    .c-name { font-size:9px; text-align:center; white-space:nowrap; overflow:hidden; font-weight:bold; }
    .stats { display:flex; justify-content:space-between; padding:0 2px; font-weight:bold; font-size:10px; margin-bottom:2px; }
    .badges { position:absolute; top:2px; right:2px; display:flex; gap:1px; z-index:5; }
    .bdg { width:16px; height:16px; border-radius:50%; font-size:10px; display:flex; align-items:center; justify-content:center; border:1px solid white; }
    .bdg-w { background:var(--pri); } .bdg-t { background:#8e44ad; } .bdg-s { background:var(--acc); } .bdg-h { background:var(--n); }

    .card.sel { transform:translateY(-15px); border-color:var(--acc); box-shadow:0 0 15px var(--acc); z-index:10; }
    .card.atk { border-color:var(--succ); box-shadow:0 0 10px var(--succ); }
    .card.tgt { transform:scale(1.2); border-color:var(--dang); box-shadow:0 0 20px var(--dang); z-index:100; }

    .ldr { text-align:center; width:70px; } .ldr-n { font-size:10px; color:var(--acc); font-weight:bold; }
    .hp { width:38px; height:38px; line-height:38px; border-radius:50%; background:linear-gradient(135deg,#c0392b,#900); border:2px solid white; font-weight:bold; margin:0 auto; font-size:16px; box-shadow:0 0 5px red; }
    
    .acts { position:absolute; bottom:35%; right:10px; display:flex; flex-direction:column; gap:10px; z-index:50; }
    .g-btn { padding:10px 16px; border-radius:20px; border:none; font-weight:bold; color:white; font-size:12px; box-shadow:0 4px 8px rgba(0,0,0,0.5); cursor:pointer; }
    .b-dr { background:linear-gradient(to right,var(--succ),#27ae60); } .b-sy { background:linear-gradient(to right,var(--acc),#e67e22); color:#222; }
    #end-btn { padding:6px 12px; font-size:11px; background:#e67e22; border-radius:15px; border:none; color:white; font-weight:bold; cursor:pointer;}
    #end-btn:disabled { background:#555; color:#888; }
    #cancel-btn { display:none; position:absolute; top:60%; left:50%; transform:translate(-50%,-50%); background:var(--dang); color:white; padding:10px 20px; border-radius:20px; font-weight:bold; z-index:200; box-shadow:0 0 10px var(--dang); cursor:pointer; }

    #det-pan { position:absolute; top:15%; left:50%; transform:translateX(-50%); width:85%; max-width:320px; background:rgba(20,20,30,0.95); border:2px solid var(--acc); border-radius:12px; padding:20px; display:none; flex-direction:column; color:white; z-index:3000; box-shadow:0 0 30px rgba(0,0,0,0.8); }
    #hint-list { position:absolute; bottom:38%; left:10px; display:flex; flex-direction:column; gap:5px; z-index:40; pointer-events:none; }
    .hnt-btn { background:rgba(0,0,0,0.9); border:1px solid var(--acc); color:white; padding:8px 12px; border-radius:8px; pointer-events:auto; display:flex; flex-direction:column; min-width:120px; box-shadow:0 0 5px var(--acc); font-size:12px; cursor:pointer;}

    #sk-mod { display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:4000; flex-direction:column; justify-content:center; align-items:center; padding:20px; }
    .sk-btn { background:white; color:#333; padding:15px; border-radius:8px; border-left:8px solid var(--pri); width:100%; max-width:300px; margin-bottom:10px; font-weight:bold; cursor:pointer; }

    #msg { position:absolute; top:40%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.9); padding:15px 30px; border:2px solid white; border-radius:10px; font-weight:bold; font-size:20px; pointer-events:none; opacity:0; transition:0.3s; z-index:5000; white-space:nowrap; }
    #res-scr { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:6000; display:flex; flex-direction:column; align-items:center; justify-content:center; display:none;}
    .res-tit { font-size:48px; font-weight:bold; margin-bottom:20px; font-family:'Orbitron',sans-serif; }
    .res-w { color:var(--acc); text-shadow:0 0 20px var(--acc); } .res-l { color:var(--dang); text-shadow:0 0 20px var(--dang); }
    
    #error-display { position:fixed; top:0; left:0; width:100%; background:red; color:white; padding:10px; z-index:9999; display:none; text-align:center;}
</style>
</head>
<body>

<div id="error-display"></div>

<div id="title-screen" class="screen">
    <div class="logo">CHEM-VERSE</div>
    <div class="menu-btn" onclick="showDeck()" style="background:linear-gradient(90deg,#3498db,#2980b9);border:none;">CPUÂØæÊà¶</div>
    <div class="menu-btn" style="opacity:0.5">ÂØæ‰∫∫Êà¶ (Ê∫ñÂÇô‰∏≠)</div>
    <div class="menu-btn" style="opacity:0.5">„Ç´„Éº„ÉâÂõ≥Èëë (Ê∫ñÂÇô‰∏≠)</div>
</div>

<div id="deck-screen" class="screen hidden">
    <div class="deck-header">„Éá„ÉÉ„Ç≠„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
    <div class="d-grid" id="d-grid"></div>
    <div class="back-btn" onclick="showTitle()">Êàª„Çã</div>
</div>

<div id="board">
    <div id="e-hand"></div>
    <div id="e-field"></div>
    <div id="info">
        <div class="ldr" onclick="atkLdr('enemy')">
            <div style="font-size:24px">ü§ñ</div><div class="ldr-n" id="e-name">CPU</div><div id="e-hp" class="hp">25</div>
        </div>
        <div style="text-align:center">
            <div id="turn-disp" style="font-size:12px;color:#aaa">„Çø„Éº„É≥1</div>
            <div id="mp-disp" style="font-size:14px;font-weight:bold;color:var(--succ)">MP 1/1</div>
        </div>
        <button id="end-btn" onclick="endTurn()">ÁµÇ‰∫Ü</button>
        <div class="ldr" onclick="atkLdr('player')">
            <div id="p-hp" class="hp">25</div><div class="ldr-n">„ÅÇ„Å™„Åü</div><div style="font-size:24px">üßë‚Äçüî¨</div>
        </div>
    </div>
    <div id="hint-list"></div>
    <div id="p-field"></div>
    <div id="p-hand"></div>
    <div id="cancel-btn" onclick="cancelAtk()">‚ùå „Ç≠„É£„É≥„Çª„É´</div>
    
    <div id="det-pan" onclick="this.style.display='none'">
        <div style="text-align:right;font-size:20px">√ó</div>
        <div id="det-sym" style="font-size:40px;font-weight:bold;color:var(--pri);text-align:center"></div>
        <div id="det-name" style="font-size:18px;font-weight:bold;text-align:center;margin-bottom:10px"></div>
        <div id="det-st" style="text-align:center;font-size:18px;margin-bottom:10px"></div>
        <div id="det-desc" style="font-size:12px;line-height:1.5;color:#ccc;max-height:150px;overflow-y:auto"></div>
        <div style="text-align:center;margin-top:15px;font-size:10px;color:#666">(„Çø„ÉÉ„Éó„Åó„Å¶Èñâ„Åò„Çã)</div>
    </div>
</div>

<div class="acts" id="acts" style="display:none">
    <button class="g-btn b-dr" onclick="actDraw()">Ôºã „Éâ„É≠„Éº</button>
    <button class="g-btn b-sy" onclick="actSyn()">‚öóÔ∏è ÂêàÊàê</button>
</div>

<div id="sk-mod">
    <h3>ÊäÄ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h3>
    <div id="sk-list"></div>
    <button class="menu-btn" style="width:auto;padding:10px 20px" onclick="document.getElementById('sk-mod').style.display='none';cancelAtk()">„Ç≠„É£„É≥„Çª„É´</button>
</div>

<div id="res-scr">
    <div class="res-tit" id="res-tit">VICTORY</div>
    <div style="margin-bottom:30px;font-weight:bold" id="res-msg">ÂãùÂà©ÔºÅ</div>
    <div class="menu-btn" onclick="showTitle()">„Çø„Ç§„Éà„É´„Å∏Êàª„Çã</div>
</div>

<div id="msg"></div>

<script>
window.onerror = function(msg, url, line) {
    document.getElementById('error-display').style.display = 'block';
    document.getElementById('error-display').innerText = `Error: ${msg} (Line: ${line})`;
};

const MAX_H=10, MAX_F=5, INI_HP=25;

const EL = {
    H:{s:'H',n:'Ê∞¥Á¥†',r:'N',c:'art-H'}, He:{s:'He',n:'„Éò„É™„Ç¶„É†',r:'SR',c:'art-gas'}, Li:{s:'Li',n:'„É™„ÉÅ„Ç¶„É†',r:'R',c:'art-met'},
    B:{s:'B',n:'„Éõ„Ç¶Á¥†',r:'R',c:'art-sol'}, C:{s:'C',n:'ÁÇ≠Á¥†',r:'N',c:'art-sol'}, N:{s:'N',n:'Á™íÁ¥†',r:'N',c:'art-gas'},
    O:{s:'O',n:'ÈÖ∏Á¥†',r:'N',c:'art-gas'}, F:{s:'F',n:'„Éï„ÉÉÁ¥†',r:'SR',c:'art-tox'}, Ne:{s:'Ne',n:'„Éç„Ç™„É≥',r:'SR',c:'art-gas'},
    Na:{s:'Na',n:'„Éä„Éà„É™„Ç¶„É†',r:'N',c:'art-met'}, Mg:{s:'Mg',n:'„Éû„Ç∞„Éç„Ç∑„Ç¶„É†',r:'R',c:'art-met'}, Al:{s:'Al',n:'„Ç¢„É´„Éü„Éã„Ç¶„É†',r:'R',c:'art-met'},
    Si:{s:'Si',n:'„Ç±„Ç§Á¥†',r:'R',c:'art-sol'}, P:{s:'P',n:'„É™„É≥',r:'R',c:'art-sol'}, S:{s:'S',n:'Á°´ÈªÑ',r:'R',c:'art-sol'},
    Cl:{s:'Cl',n:'Â°©Á¥†',r:'N',c:'art-Cl'}, Ar:{s:'Ar',n:'„Ç¢„É´„Ç¥„É≥',r:'SR',c:'art-gas'}, K:{s:'K',n:'„Ç´„É™„Ç¶„É†',r:'N',c:'art-met'},
    Ca:{s:'Ca',n:'„Ç´„É´„Ç∑„Ç¶„É†',r:'R',c:'art-met'}, Ti:{s:'Ti',n:'„ÉÅ„Çø„É≥',r:'SR',c:'art-met'}, V:{s:'V',n:'„Éê„Éä„Ç∏„Ç¶„É†',r:'SR',c:'art-met'},
    Cr:{s:'Cr',n:'„ÇØ„É≠„É†',r:'SR',c:'art-met'}, Mn:{s:'Mn',n:'„Éû„É≥„Ç¨„É≥',r:'R',c:'art-met'}, Fe:{s:'Fe',n:'ÈâÑ',r:'N',c:'art-met'},
    Ni:{s:'Ni',n:'„Éã„ÉÉ„Ç±„É´',r:'R',c:'art-met'}, Cu:{s:'Cu',n:'ÈäÖ',r:'N',c:'art-met'}, Zn:{s:'Zn',n:'‰∫úÈâõ',r:'R',c:'art-met'},
    Ag:{s:'Ag',n:'ÈäÄ',r:'SR',c:'art-met'}, Cd:{s:'Cd',n:'„Ç´„Éâ„Éü„Ç¶„É†',r:'R',c:'art-tox'}, Sn:{s:'Sn',n:'„Çπ„Ç∫',r:'R',c:'art-met'},
    Ba:{s:'Ba',n:'„Éê„É™„Ç¶„É†',r:'R',c:'art-met'}, W:{s:'W',n:'„Çø„É≥„Ç∞„Çπ„ÉÜ„É≥',r:'SSR',c:'art-met'}, Pt:{s:'Pt',n:'„Éó„É©„ÉÅ„Éä',r:'SSR',c:'art-met'},
    Au:{s:'Au',n:'Èáë',r:'SSR',c:'art-Au'}, Hg:{s:'Hg',n:'Ê∞¥ÈäÄ',r:'SR',c:'art-liq'}, Pb:{s:'Pb',n:'Èâõ',r:'R',c:'art-met'}
};

const REC = [
    {i:['H','Cl'], p:{s:'HCl',n:'Â°©ÂåñÊ∞¥Á¥†',r:'R',a:5,h:1,c:'art-tox',sk:[{n:'Âº∑ÈÖ∏ËÖêÈ£ü',p:5,d:'È´òÁÅ´Âäõ'}]}},
    {i:['H','F'], p:{s:'HF',n:'„Éï„ÉÉÂåñÊ∞¥Á¥†',r:'SR',a:4,h:2,ab:'toxic',c:'art-tox',sk:[{n:'„Ç¨„É©„ÇπËÖêÈ£ü',p:4,d:'ÊîªÊíÉ'},{n:'ÁåõÊØí',p:0,t:'toxic',d:'ÂøÖÊÆ∫'}]}},
    {i:['Na','H'], p:{s:'NaH',n:'Ê∞¥Á¥†ÂåñNa',r:'R',a:3,h:1,ab:'storm',c:'art-sol',sk:[{n:'ÈÇÑÂÖÉ‰ΩúÁî®',p:3,d:'ÁñæËµ∞'}]}},
    {i:['H','H','O'], p:{s:'H2O',n:'Ê∞¥',r:'N',a:1,h:4,c:'art-liq',sk:[{n:'Ê∞¥ÊµÅ',p:1,d:'ÊîªÊíÉ'},{n:'Âä†Ê∞¥ÂàÜËß£',p:3,t:'heal',d:'HP3ÂõûÂæ©'}]}},
    {i:['Ag','Cl'], p:{s:'AgCl',n:'Â°©ÂåñÈäÄ',r:'SR',a:1,h:6,ab:'ward',c:'art-sol',sk:[{n:'ÁôΩËâ≤Ê≤àÊÆø',p:0,t:'guard',d:'ÂÆàË≠∑'}]}},
    {i:['Fe','O'], p:{s:'FeO',n:'ÈÖ∏ÂåñÈâÑ(II)',r:'N',a:3,h:5,c:'art-sol',sk:[{n:'ÈªíÈåÜ',p:3,d:'ÈÄöÂ∏∏ÊîªÊíÉ'}]}},
    {i:['Fe','O','O'], p:{s:'Fe2O3',n:'Ëµ§ÈåÜ',r:'R',a:2,h:8,ab:'ward',c:'art-sol',sk:[{n:'‰∏çÂãïÊÖã',p:2,d:'È´òËÄê‰πÖ'}]}},
    {i:['Cu','O'], p:{s:'CuO',n:'ÈÖ∏ÂåñÈäÖ(II)',r:'N',a:3,h:4,c:'art-sol',sk:[{n:'ÈªíËâ≤Á≤âÊú´',p:3,d:'ÊîªÊíÉ'}]}},
    {i:['Zn','Cu'], p:{s:'Brass',n:'ÈªÑÈäÖ',r:'R',a:4,h:5,c:'art-met',sk:[{n:'ÂêàÈáë„Ç¢„Çø„ÉÉ„ÇØ',p:4,d:'ÊîªÊíÉ'}]}},
    {i:['Hg','Zn'], p:{s:'Amalgam',n:'‰∫úÈâõ„Ç¢„Éû„É´„Ç¨„É†',r:'SR',a:3,h:6,ab:'ward',c:'art-met',sk:[{n:'„Ç¢„Éû„É´„Ç¨„É†Âåñ',p:3,d:'ÂÆàË≠∑'}]}},
    {i:['C','O'], p:{s:'CO',n:'‰∏ÄÈÖ∏ÂåñÁÇ≠Á¥†',r:'R',a:1,h:2,ab:'toxic',c:'art-gas',sk:[{n:'‰∏çÂÆåÂÖ®ÁáÉÁÑº',p:1,d:'ÊîªÊíÉ'},{n:'„Éò„É¢„Ç∞„É≠„Éì„É≥ÁµêÂêà',p:0,t:'toxic',d:'ÂøÖÊÆ∫'}]}},
    {i:['H','S'], p:{s:'H2S',n:'Á°´ÂåñÊ∞¥Á¥†',r:'R',a:2,h:3,ab:'toxic',c:'art-gas',sk:[{n:'ËÖêÂçµËá≠',p:2,d:'ÊîªÊíÉ'},{n:'Á°´Âåñ',p:0,t:'toxic',d:'ÂøÖÊÆ∫'}]}},
    {i:['Cl','Cl'], p:{s:'Cl2',n:'Â°©Á¥†„Ç¨„Çπ',r:'R',a:3,h:3,c:'art-gas',sk:[{n:'ÈÖ∏Âåñ‰ΩúÁî®',p:3,d:'ÊîªÊíÉ'},{n:'ÊØí„Ç¨„ÇπÊï£Â∏É',p:2,t:'aoe',d:'ÂÖ®‰Ωì2„ÉÄ„É°'}]}},
    {i:['S','O','O'], p:{s:'SO2',n:'‰∫åÈÖ∏ÂåñÁ°´ÈªÑ',r:'N',a:2,h:4,c:'art-gas',sk:[{n:'ÈÖ∏ÊÄßÈõ®',p:1,t:'aoe',d:'ÂÖ®‰Ωì1„ÉÄ„É°'}]}},
    {i:['Cd','S'], p:{s:'CdS',n:'Á°´Âåñ„Ç´„Éâ„Éü„Ç¶„É†',r:'SR',a:2,h:5,ab:'toxic',c:'art-tox',sk:[{n:'„Ç§„Çø„Ç§„Ç§„Çø„Ç§',p:0,t:'toxic',d:'ÁåõÊØí'}]}},
    {i:['Na','O','H'], p:{s:'NaOH',n:'Ê∞¥ÈÖ∏ÂåñNa',r:'R',a:3,h:3,c:'art-sol',sk:[{n:'ÊΩÆËß£',p:3,d:'ÊîªÊíÉ'},{n:'‰∏≠ÂíåÁÜ±',p:2,t:'aoe_heal',d:'ÂÖ®‰Ωì2„ÉÄ„É°/2ÂõûÂæ©'}]}},
    {i:['Al','O','O'], p:{s:'Al2O3',n:'„Ç¢„É´„Éü„Éä',r:'R',a:2,h:7,ab:'ward',c:'art-sol',sk:[{n:'„Ç¢„É´„Éû„Ç§„Éà',p:2,d:'ÂÆàË≠∑'}]}},
    {i:['Cl','Na'], p:{s:'NaCl',n:'Â°©ÂåñNa',r:'N',a:3,h:4,c:'art-sol',sk:[{n:'Â°©Âë≥',p:3,d:'ÈÄöÂ∏∏ÊîªÊíÉ'}]}},
    {i:['Ca','O','H','H'], p:{s:'Ca(OH)2',n:'Ê∂àÁü≥ÁÅ∞',r:'N',a:1,h:6,ab:'ward',c:'art-sol',sk:[{n:'Áü≥ÁÅ∞Ê∞¥',p:1,d:'ÊîªÊíÉ'},{n:'‰∏≠ÂíåÂèçÂøú',p:4,t:'heal',d:'HP4ÂõûÂæ©'}]}},
    {i:['C','C','C'], p:{s:'Diamond',n:'„ÉÄ„Ç§„É§„É¢„É≥„Éâ',r:'SSR',a:4,h:10,ab:'ward',c:'art-Au',sk:[{n:'ÊúÄÂº∑Á°¨Â∫¶',p:4,d:'ÈâÑÂ£Å'}]}},
    {i:['Al','O','O','Cr'], p:{s:'Ruby',n:'„É´„Éì„Éº',r:'SR',a:5,h:8,c:'art-sol',sk:[{n:'Ê∑±Á¥Ö„ÅÆËºù„Åç',p:5,d:'È´ò„Çπ„ÉÜ„Éº„Çø„Çπ'}]}},
    {i:['Al','O','Ti'], p:{s:'Sapphire',n:'„Çµ„Éï„Ç°„Ç§„Ç¢',r:'SR',a:4,h:9,c:'art-sol',sk:[{n:'ÈùíÁéâ',p:4,d:'È´òËÄê‰πÖ'}]}},
    {i:['Si','O','O'], p:{s:'SiO2',n:'Áü≥Ëã±',r:'N',a:3,h:6,c:'art-sol',sk:[{n:'ÁµêÊô∂Âåñ',p:2,t:'aoe',d:'ÂÖ®‰Ωì2„ÉÄ„É°'}]}},
    {i:['Au'], p:{s:'Au',n:'Èáë',r:'SSR',a:6,h:6,c:'art-Au',sk:[{n:'‰∏çÂ§â„ÅÆËºù„Åç',p:6,d:'È´òÁÅ´Âäõ'}]}},
    {i:['Pt'], p:{s:'Pt',n:'„Éó„É©„ÉÅ„Éä',r:'SSR',a:5,h:7,c:'art-met',sk:[{n:'Ëß¶Â™í‰ΩúÁî®',p:5,d:'ÊîªÊíÉ'}]}},
    {i:['W'], p:{s:'W',n:'„Çø„É≥„Ç∞„Çπ„ÉÜ„É≥',r:'SSR',a:7,h:8,ab:'ward',c:'art-met',sk:[{n:'ËûçÁÇπ3422‚ÑÉ',p:7,d:'ÊîªÊíÉ'}]}},
    {i:['Ti'], p:{s:'Ti',n:'„ÉÅ„Çø„É≥',r:'SR',a:4,h:5,c:'art-met',sk:[{n:'È´òÂº∑Â∫¶',p:4,d:'ÊîªÊíÉ'}]}},
    {i:['He','He'], p:{s:'He',n:'„Éò„É™„Ç¶„É†',r:'SR',a:2,h:2,ab:'stealth',c:'art-gas',sk:[{n:'‰∏çÊ¥ªÊÄß',p:2,d:'ÊΩú‰ºè'}]}},
    {i:['Ne','Ne'], p:{s:'Ne',n:'„Éç„Ç™„É≥',r:'SR',a:3,h:3,ab:'stealth',c:'art-gas',sk:[{n:'„Éç„Ç™„É≥„Çµ„Ç§„É≥',p:3,d:'ÊΩú‰ºè'}]}},
    {i:['Ar','Ar'], p:{s:'Ar',n:'„Ç¢„É´„Ç¥„É≥',r:'SR',a:4,h:4,ab:'stealth',c:'art-gas',sk:[{n:'„Éï„Ç£„É©„É°„É≥„Éà',p:4,d:'ÊΩú‰ºè'}]}},
    {i:['H','Cl','N','O','O','O'], p:{s:'AquaRegia',n:'ÁéãÊ∞¥',r:'SSR',a:0,h:0,type:'spell',c:'art-liq',sk:[{n:'ÈáëÊ∫∂„Åã„Åó',p:99,t:'toxic',d:'Á¢∫ÂÆöÈô§Âéª'}]}},
    {i:['H','H','S','O','O','O','O'], p:{s:'H2SO4',n:'ÊøÉÁ°´ÈÖ∏',r:'SR',a:0,h:0,type:'spell',c:'art-liq',sk:[{n:'ËÑ±Ê∞¥‰ΩúÁî®',p:5,t:'aoe',d:'ÂÖ®‰Ωì5„ÉÄ„É°'}]}},
    {i:['K','Mn','O','O','O','O'], p:{s:'KMnO4',n:'ÈÅé„Éû„É≥„Ç¨„É≥ÈÖ∏K',r:'SR',a:0,h:0,type:'spell',c:'art-sol',sk:[{n:'Âº∑ÂäõÈÖ∏Âåñ',p:7,t:'dmg',d:'7„ÉÄ„É°'}]}}
];

const DECKS = {
    aggro: {n:'Ë∂ÖÈÄüÊîª', d:'‰Ωé„Ç≥„Çπ„ÉàÈ´òÁÅ´Âäõ', e:['H','H','Cl','F','Na','O'], r:['HCl','HF','NaH','H2O']},
    counter: {n:'„Ç´„Ç¶„É≥„Çø„Éº', d:'ÂÆà„Å£„Å¶ÂèçÊíÉ', e:['Ag','Cl','Fe','O','Cu','Zn','Hg'], r:['AgCl','FeO','Fe2O3','Brass','Amalgam','CuO']},
    toxic: {n:'ÂÆ≥ÊÇ™(ÊØí)', d:'ÂøÖÊÆ∫„ÅßÂç≥Ê≠ª', e:['C','O','S','H','Cl','Cd'], r:['CO','H2S','Cl2','SO2','CdS']},
    control: {n:'„Ç≥„É≥„Éà„É≠„Éº„É´', d:'ÂõûÂæ©„Å®ÊîØÈÖç', e:['Al','O','H','Na','Cl','Ca'], r:['Al2O3','NaOH','H2O','NaCl','Ca(OH)2']},
    gemstone: {n:'ÂÆùÁü≥', d:'ÊúÄÂº∑„ÅÆÁ°¨Â∫¶', e:['C','C','C','Al','O','Si','Cr','Ti'], r:['Diamond','Ruby','Sapphire','SiO2']},
    heavy: {n:'ÈáçÈáëÂ±û', d:'ÂæåÂçäÊúÄÂº∑', e:['Au','Pt','W','Ti'], r:['Au','Pt','W','Ti']},
    noble: {n:'Ë≤¥„Ç¨„Çπ', d:'ÊΩú‰ºèÊîªÊíÉ', e:['He','He','Ne','Ne','Ar','Ar'], r:['He','Ne','Ar']},
    hazard: {n:'Âç±Èô∫Áâ©', d:'Èô§Âéª„Çπ„Éö„É´', e:['H','Cl','N','O','S','K','Mn'], r:['AquaRegia','H2SO4','KMnO4']}
};

let gs = {hp:INI_HP, eHp:INI_HP, hand:[], field:[], eHand:[], eField:[], turn:1, mp:1, maxMp:1, myTurn:true, sel:[], atk:null, pPool:[], ePool:[], pRec:[], eRec:[]};

window.onload = () => {
    try {
        const g = document.getElementById('d-grid');
        for(let k in DECKS) {
            const d = document.createElement('div'); d.className='d-card';
            d.innerHTML = `<div class="d-title">${DECKS[k].n}</div><div class="d-desc">${DECKS[k].d}</div>`;
            d.onclick = () => start(k);
            g.appendChild(d);
        }
        showTitle();
    } catch(e) { document.getElementById('error-display').style.display='block'; document.getElementById('error-display').innerText=e; }
};

function showTitle() { hide(); document.getElementById('title-screen').style.display='flex'; }
function showDeck() { hide(); document.getElementById('deck-screen').style.display='block'; }
function hide() { document.querySelectorAll('.screen').forEach(e=>e.style.display='none'); document.getElementById('board').style.display='none'; document.getElementById('acts').style.display='none'; document.getElementById('res-scr').style.display='none'; }

function start(key) {
    try {
        gs = {hp:INI_HP, eHp:INI_HP, hand:[], field:[], eHand:[], eField:[], turn:1, mp:1, maxMp:1, myTurn:true, sel:[], atk:null};
        gs.pPool = DECKS[key].e.map(s => EL[s]);
        gs.pRec = REC.filter(r => DECKS[key].r.includes(r.p.s));
        
        const eks = Object.keys(DECKS); const ek = eks[Math.floor(Math.random()*eks.length)];
        gs.ePool = DECKS[ek].e.map(s=>EL[s]);
        gs.eRec = REC.filter(r => DECKS[ek].r.includes(r.p.s));
        
        document.getElementById('e-name').innerText = `CPU (${DECKS[ek].n.split('(')[0]})`;
        hide(); document.getElementById('board').style.display='flex'; document.getElementById('acts').style.display='flex';
        
        for(let i=0; i<5; i++) { draw(true); draw(false); }
        upd(); msg("„Éê„Éà„É´ÈñãÂßãÔºÅ");
    } catch(e) { alert("Start Error: "+e); }
}

function draw(isP) {
    const p = isP ? gs.pPool : gs.ePool;
    const c = { ...p[Math.floor(Math.random()*p.length)], id:Math.random(), type:'el' };
    if(isP) { if(gs.hand.length<MAX_H) gs.hand.push(c); } else { if(gs.eHand.length<MAX_H) gs.eHand.push(c); }
}

function actDraw() { if(!gs.myTurn||gs.mp<1){msg("MP‰∏çË∂≥");return;} gs.mp--; draw(true); upd(); }

function actSyn() {
    if(!gs.myTurn || gs.sel.length<1) return;
    if(gs.sel.length===1) { // Single elem recipe check (Au etc)
        const c = gs.hand.find(x=>x.id===gs.sel[0]);
        const r = gs.pRec.find(x=>x.i.length===1 && x.i[0]===c.s);
        if(r) { doSyn(r); return; }
    }
    const sl = gs.hand.filter(c=>gs.sel.includes(c.id));
    const sy = sl.map(c=>c.s).sort();
    const r = gs.pRec.find(x=>JSON.stringify(x.i.sort())===JSON.stringify(sy));
    if(r) doSyn(r); else { msg("ÂèçÂøú„Åó„Åæ„Åõ„Çì"); gs.sel=[]; upd(); }
}

function doSyn(r) {
    if(r.p.type==='spell') {
        gs.hand = gs.hand.filter(c=>!gs.sel.includes(c.id)); gs.sel=[];
        if(gs.eField.length>0) { gs.eField[0].cur-=99; msg("Êïµ„ÇíÁ†¥Â£äÔºÅ"); } else { gs.eHp-=5; msg("„É™„Éº„ÉÄ„Éº„ÉÄ„É°ÔºÅ"); }
        chk(); upd(); return;
    }
    if(gs.field.length>=MAX_FIELD) { msg("Ê∫ÄÂì°"); return; }
    gs.hand = gs.hand.filter(c=>!gs.sel.includes(c.id)); gs.sel=[];
    const u = { ...r.p, id:Math.random(), max:r.p.h, cur:r.p.h, can:r.p.ab==='storm', type:'unit' };
    gs.field.push(u); msg("Âè¨ÂñöÔºÅ"); upd();
}

function hClick(id) {
    if(!gs.myTurn) return;
    const c = gs.hand.find(x=>x.id===id); shDet(c);
    if(gs.sel.includes(id)) gs.sel=gs.sel.filter(x=>x!==id); else gs.sel.push(id);
    upd();
}

function fClick(id, isP) {
    if(!gs.myTurn) return;
    if(isP) {
        const u = gs.field.find(x=>x.id===id); shDet(u);
        if(u&&u.can) { gs.atk=u; document.body.classList.add('targeting'); upd(); }
    } else if(gs.atk) {
        const t = gs.eField.find(x=>x.id===id);
        if(t.ab==='stealth') { msg("ÊΩú‰ºè‰∏≠"); return; }
        prepAtk(gs.atk, t, 'unit');
    } else {
        shDet(gs.eField.find(x=>x.id===id));
    }
}

function atkLdr(s) { if(s==='enemy'&&gs.atk) prepAtk(gs.atk, 'ldr', 'ldr'); }

function prepAtk(a, t, type) {
    if(type==='ldr' || (type==='unit'&&t.ab!=='ward')) {
        if(gs.eField.some(u=>u.ab==='ward'&&u.ab!=='stealth')) { msg("ÂÆàË≠∑„ÅÇ„Çä"); cancelAtk(); return; }
    }
    if(a.sk.length>1) openSk(a,t); else exeSk(a,t,a.sk[0]);
}

function openSk(a,t) {
    const m=document.getElementById('sk-mod'), l=document.getElementById('sk-list'); l.innerHTML='';
    a.sk.forEach(s=>{
        const b=document.createElement('div'); b.className='sk-btn';
        b.innerHTML=`${s.n} (Â®ÅÂäõ:${s.p})<br><span style='font-size:10px'>${s.d}</span>`;
        b.onclick=()=>{exeSk(a,t,s);m.style.display='none';}; l.appendChild(b);
    }); m.style.display='flex';
}

function exeSk(a,t,s) {
    let log=s.n;
    if(s.t==='aoe') { gs.eField.forEach(u=>u.cur-=s.p); gs.eHp-=s.p; }
    else if(s.t==='aoe_heal') { gs.eField.forEach(u=>u.cur-=s.p); gs.hp+=s.p; }
    else if(s.t==='heal') gs.hp+=s.p;
    else {
        let d=s.p; if(t==='ldr') gs.eHp-=d;
        else {
            if(s.t==='toxic'&&d>0) t.cur=-99; else t.cur-=d;
            if(t.cur<=0 && t.ab==='toxic' && t.a>0) a.cur=-99; else a.cur-=t.a; // counter
        }
    }
    a.can=false; msg(log); cancelAtk(); chk(); upd();
}

function cancelAtk() { gs.atk=null; document.body.classList.remove('targeting'); upd(); }
function chk() {
    gs.field=gs.field.filter(u=>u.cur>0); gs.eField=gs.eField.filter(u=>u.cur>0);
    if(gs.eHp<=0) res(true); else if(gs.hp<=0) res(false);
}
function res(w) {
    document.getElementById('res-scr').style.display='flex';
    const t=document.getElementById('res-tit'), m=document.getElementById('res-msg');
    if(w){t.innerText="VICTORY";t.className="res-tit res-w";m.innerText="ÂãùÂà©ÔºÅ";}
    else{t.innerText="DEFEAT";t.className="res-tit res-l";m.innerText="ÊïóÂåó...";}
}

function endTurn() { gs.myTurn=false; cancelAtk(); upd(); msg("Êïµ„Çø„Éº„É≥"); setTimeout(cpu,1000); }

async function cpu() {
    if(gs.maxMp<10) gs.maxMp++; gs.mp=gs.maxMp; draw(false); upd(); await new Promise(r=>setTimeout(r,500));
    // CPU Syn
    let act=true;
    while(act && gs.eField.length<MAX_FIELD) {
        act=false; const h=gs.eHand.map(c=>c.s);
        for(let r of gs.eRec) {
            if(r.p.type==='spell') continue;
            let ing=[...r.i], th=[...h], ok=true;
            for(let x of ing) { let idx=th.indexOf(x); if(idx<0){ok=false;break;} th.splice(idx,1); }
            if(ok) {
                for(let x of r.i) { let idx=gs.eHand.findIndex(c=>c.s===x); gs.eHand.splice(idx,1); }
                const u={...r.p, id:Math.random(), max:r.p.h, cur:r.p.h, can:false, type:'unit'};
                gs.eField.push(u); msg("CPUÂè¨Âñö"); upd(); await new Promise(r=>setTimeout(r,800));
                act=true; break;
            }
        }
    }
    // CPU Atk
    gs.eField.forEach(u=>u.can=true);
    for(let u of gs.eField) {
        if(!u.can) continue;
        let grd=gs.field.find(g=>g.ab==='ward'&&g.ab!=='stealth');
        let t=grd||'ldr';
        if(t==='ldr') { gs.hp-=u.sk[0].p; msg("CPUÊîªÊíÉ->Ldr"); }
        else {
            let d=u.sk[0].p; if(u.sk[0].t==='toxic'&&d>0) t.cur=-99; else t.cur-=d;
            u.cur-=t.a; msg("CPUÊîªÊíÉ->Unit");
        }
        chk(); upd(); await new Promise(r=>setTimeout(r,800));
    }
    gs.turn++; gs.myTurn=true; gs.field.forEach(u=>u.can=true); draw(true); msg("Ëá™„Çø„Éº„É≥"); upd();
}

function upd() {
    document.getElementById('turn-disp').innerText=`Turn ${gs.turn}`;
    document.getElementById('mp-disp').innerText=`MP ${gs.mp}/${gs.maxMp}`;
    document.getElementById('player-hp').innerText=gs.hp; document.getElementById('enemy-hp').innerText=gs.eHp;
    document.getElementById('cancel-btn').style.display=gs.atk?'block':'none';
    
    rend(document.getElementById('p-hand'), gs.hand, 'h', true);
    rend(document.getElementById('p-field'), gs.field, 'f', true);
    rend(document.getElementById('e-field'), gs.eField, 'f', false);
    const eh=document.getElementById('e-hand'); eh.innerHTML='';
    gs.eHand.forEach(()=>{ const d=document.createElement('div'); d.className='card'; d.style.background='#444'; d.style.width='30px'; d.style.height='45px'; eh.appendChild(d); });
    
    // Hint
    const hl=document.getElementById('craftable-list'); hl.innerHTML='';
    if(gs.myTurn) {
        gs.pRec.forEach(r=>{
            let h=gs.hand.map(c=>c.s), ok=true;
            for(let x of r.i) { let idx=h.indexOf(x); if(idx<0){ok=false;break;} h.splice(idx,1); }
            if(ok) {
                const b=document.createElement('div'); b.className='hnt-btn';
                b.innerHTML=`<div style="color:var(--acc);font-weight:bold">‚ú® ${r.p.n}</div>`;
                b.onclick=()=>{ gs.sel=[]; let th=[...gs.hand]; r.i.forEach(x=>{ let idx=th.findIndex(c=>c.s===x); gs.sel.push(th[idx].id); th.splice(idx,1); }); upd(); };
                hl.appendChild(b);
            }
        });
    }
}

function rend(el, l, t, isP) {
    el.innerHTML='';
    l.forEach(c=>{
        const d=document.createElement('div'); d.className='card'; d.setAttribute('data-r',c.r);
        let art=c.c||'art-sol';
        if(c.type==='el') d.innerHTML=`<div class="c-art ${art} css-art"></div><div class="c-info"><div class="c-sym" style="display:block;margin-top:5px;position:static">${c.s}</div><div class="c-name">${c.n}</div></div>`;
        else {
            let bdg=`<div class="badges">`;
            if(c.ab==='ward') bdg+=`<div class="bdg bdg-w">üõ°Ô∏è</div>`;
            if(c.ab==='toxic') bdg+=`<div class="bdg bdg-t">‚ò†Ô∏è</div>`;
            if(c.ab==='storm') bdg+=`<div class="bdg bdg-s">‚ö°</div>`;
            bdg+=`</div>`;
            d.innerHTML=`${bdg}<div class="c-art ${art} css-art"></div><div class="c-info"><div class="c-sym" style="display:block;color:var(--pri);position:static">${c.s}</div><div class="c-name">${c.n}</div><div class="stats"><span class="stat-atk">‚öîÔ∏è${c.a}</span><span class="stat-hp">‚ù§Ô∏è${c.cur}</span></div></div>`;
        }
        if(t==='h'&&gs.sel.includes(c.id)) d.classList.add('sel');
        if(t==='f'&&c.can&&isP) d.classList.add('atk');
        if(t==='f'&&!isP&&gs.atk) d.classList.add('tgt');
        d.onclick=(e)=>{e.stopPropagation(); if(t==='h') hClick(c.id); else fClick(c.id,isP); };
        el.appendChild(d);
    });
}

function shDet(c) {
    if(!c)return;
    const p=document.getElementById('det-pan'); p.style.display='flex';
    document.getElementById('det-sym').innerText=c.s; document.getElementById('det-name').innerText=c.n;
    if(c.type!=='el') {
        document.getElementById('det-st').innerHTML=`‚öîÔ∏è${c.a} <span style="margin-left:10px;color:var(--succ)">‚ù§Ô∏è${c.cur}/${c.max}</span>`;
        document.getElementById('det-desc').innerHTML=c.sk.map(s=>`<div><b>„Äê${s.n}„Äë</b> ${s.d}</div>`).join('');
    } else {
        document.getElementById('det-st').innerText=''; document.getElementById('det-desc').innerText='ÂêàÊàêÁ¥†Êùê';
    }
}

function msg(t) { const b=document.getElementById('msg'); b.innerText=t; b.style.opacity=1; setTimeout(()=>b.style.opacity=0,1500); }
</script>
</body>
</html>