<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <!-- removed maximum-scale and user-scalable to fix the reported warnings -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chem-Verse: Ultimate (‰øÆÊ≠£Áâà)</title>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <style>
        :root{
            --bg:#0b1020; --accent:#f1c40f; --primary:#3498db; --danger:#e74c3c; --success:#2ecc71;
            --rare-n:#95a5a6; --rare-r:#3498db; --rare-sr:#9b59b6; --rare-ssr:#f1c40f; --card-white:#fbfeff;
        }
        html,body{height:100%;margin:0;font-family:'M PLUS Rounded 1c',sans-serif;background:linear-gradient(135deg,#071027,#0b1020);color:#fff;overflow:hidden}
        .screen{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column}
        .hidden{display:none!important}
        /* Title */
        #title-screen{background:radial-gradient(circle at center,#162235 0%, #07070a 60%)}
        .game-logo{font-family:Orbitron, sans-serif;font-size:44px;color:var(--accent);text-shadow:0 8px 30px rgba(241,196,15,0.06)}
        .menu-container{display:flex;flex-direction:column;gap:12px}
        .menu-btn{padding:12px 18px;border-radius:24px;border:none;font-weight:900;cursor:pointer}
        .btn-p{background:linear-gradient(90deg,#2a7bd6,#3498db);color:white}
        .btn-pvp{background:linear-gradient(90deg,#e74c3c,#c0392b);color:white}
        /* Deck selector */
        .deck-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;width:92%;max-width:700px}
        .deck-card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);cursor:pointer}
        .deck-title{font-weight:900;color:var(--accent)}
        .deck-desc{color:#bfcbdc;font-size:12px;margin-top:6px}
        /* Board */
        #game-board{display:none;position:absolute;inset:0;padding:12px;box-sizing:border-box;flex-direction:column;align-items:center;justify-content:flex-start}
        #enemy-hand-area{height:80px;display:flex;align-items:center;gap:8px;justify-content:center;margin-top:12px;overflow:auto}
        #enemy-field{height:160px;display:flex;align-items:center;justify-content:center;gap:10px;margin-top:6px}
        #info-area{height:86px;width:100%;max-width:1100px;display:flex;align-items:center;justify-content:space-between;padding:8px;margin-top:8px}
        #player-field{height:160px;display:flex;align-items:center;justify-content:center;gap:10px;margin-top:6px}
        #player-hand-area{height:170px;display:flex;align-items:center;gap:8px;overflow:auto;margin-top:10px;padding-left:8px}
        /* card (B: TCG-like enhanced) */
        .card{width:96px;height:136px;border-radius:14px;background:linear-gradient(180deg,var(--card-white),#f0f6ff);color:#112;box-shadow:0 12px 30px rgba(2,10,30,0.6);border:2px solid rgba(0,0,0,0.06);position:relative;flex-shrink:0;overflow:hidden;transition:transform .12s, box-shadow .12s;cursor:pointer;display:flex;flex-direction:column}
        .card .card-art{height:64px;display:flex;align-items:center;justify-content:center;font-size:28px}
        .card .card-info{padding:6px;display:flex;flex-direction:column;gap:4px;flex:1}
        .card .card-symbol{font-weight:900;color:var(--primary);text-align:center}
        .card .card-name{font-size:12px;font-weight:900;text-align:center;color:#123}
        .card .stats{display:flex;justify-content:space-between;font-size:12px;font-weight:900;padding:0 6px}
        .stat-box{padding:2px 6px;border-radius:999px;font-size:12px}
        .stat-atk{background:linear-gradient(90deg,#f7b267,#f39c12);color:#221}
        .stat-hp{background:linear-gradient(90deg,#a0e6a0,#2ecc71);color:#062}
        .card[data-rarity="N"]{border-color:var(--rare-n)}
        .card[data-rarity="R"]{border-color:var(--rare-r)}
        .card[data-rarity="SR"]{border-color:var(--rare-sr)}
        .card[data-rarity="SSR"]{border-color:var(--rare-ssr);box-shadow:0 0 18px var(--rare-ssr)}
        .card.selected{box-shadow:0 18px 40px rgba(52,152,219,0.2);border-color:var(--primary);transform:translateY(-18px) scale(1.12)}
        .card.can-attack{box-shadow:0 10px 30px rgba(46, 204, 113, 0.12);border-color:var(--success)}
        /* badges */
        .ability-container{position:absolute;top:6px;right:6px;display:flex;gap:6px}
        .badge{width:20px;height:20px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:12px}
        /* detail panel */
        #card-detail-panel{position:fixed;top:8%;left:50%;transform:translateX(-50%);width:420px;max-width:92%;background:linear-gradient(180deg,#071027,#0b1020);border:2px solid var(--accent);border-radius:12px;padding:14px;display:none;z-index:9999;color:#fff}
        #card-detail-panel .detail-close{position:absolute;right:10px;top:6px;cursor:pointer;color:#999;font-size:20px}
        #card-detail-panel .detail-art{width:100%;height:160px;border-radius:8px;background:#0b1220;display:flex;align-items:center;justify-content:center;font-size:48px;margin-bottom:10px}
        #card-detail-panel .detail-skills{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;color:#ddd}
        /* small UI */
        .action-overlay{position:absolute;right:18px;top:80px;display:flex;flex-direction:column;gap:8px;z-index:50}
        .game-btn{padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:900}
        .pokedex-panel{position:absolute;right:18px;top:80px;width:340px;background:linear-gradient(180deg,#fff,#f8fbff);color:#112;border-radius:12px;padding:12px;box-shadow:0 12px 30px rgba(0,0,0,0.2);max-height:72vh;overflow:auto;z-index:60}
        /* responsive */
        @media(max-width:900px){ .deck-grid{grid-template-columns:repeat(1,1fr)} .card{width:84px;height:120px} #card-detail-panel{width:92%} }
    </style>
</head>
<body>

    <!-- TITLE -->
    <div id="title-screen" class="screen">
        <div style="text-align:center">
            <div class="game-logo">CHEM-VERSE</div>
            <div style="color:#bfcbdc;margin-bottom:20px">MUKI-COLLECT ‚Äî ÁÑ°Ê©ü„Ç≥„É¨„ÇØ„Éà</div>
        </div>
        <div class="menu-container">
            <button class="menu-btn btn-p" onclick="showDeckSelect('cpu')">CPUÂØæÊà¶</button>
            <button class="menu-btn btn-pvp" onclick="showDeckSelect('hotseat')">ÂØæ‰∫∫Êà¶Ôºà„Éõ„ÉÉ„Éà„Ç∑„Éº„ÉàÔºâ</button>
            <button class="menu-btn" onclick="togglePokedexFull()">Âõ≥Èëë</button>
        </div>
        <div style="margin-top:18px;width:92%;max-width:700px">
            <div style="display:flex;justify-content:center;margin-top:12px"><small style="color:#9fb0d6">„Éá„ÉÉ„Ç≠„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ</small></div>
            <div class="deck-grid" id="deck-grid-container" style="margin-top:12px"></div>
        </div>
    </div>

    <!-- GAME BOARD -->
    <div id="game-board" class="screen hidden" style="align-items:flex-start;padding-top:18px">
        <div id="enemy-hand-area"></div>
        <div id="enemy-field" class="area"></div>

        <div id="info-area">
            <div class="leader" id="leader-enemy" onclick="atkLdr('enemy')">
                <div class="avatar" style="font-size:28px">ü§ñ</div>
                <div id="enemy-name" style="font-weight:900;color:var(--accent)">CPU</div>
                <div id="enemy-hp" class="hp-circle">25</div>
            </div>

            <div style="text-align:center">
                <div id="turn-display" class="turn-info">„Çø„Éº„É≥ 1</div>
                <div id="mp-display" class="mp-bar">MP 1/1</div>
            </div>

            <div style="display:flex;align-items:center;gap:12px">
                <button id="btn-end-turn" class="menu-btn" onclick="endTurn()">„Çø„Éº„É≥ÁµÇ‰∫Ü</button>
                <div class="leader" id="leader-player" onclick="atkLdr('player')">
                    <div id="player-hp" class="hp-circle">25</div>
                    <div class="leader-name" style="font-weight:900;color:var(--accent)">„ÅÇ„Å™„Åü</div>
                    <div class="avatar" id="player-avatar" style="font-size:28px">üßë‚Äçüî¨</div>
                </div>
            </div>
        </div>

        <div id="craft-list" style="position:absolute;left:12px;top:45%;z-index:60"></div>

        <div id="player-field" class="area"></div>
        <div id="player-hand-area"></div>

        <div id="cancel-btn" onclick="cancelAtk()" style="display:none;position:fixed;left:50%;bottom:18%;transform:translateX(-50%);padding:10px 18px;background:#e74c3c;border-radius:12px;cursor:pointer;z-index:200">‚ùå „Ç≠„É£„É≥„Çª„É´</div>

        <div class="action-overlay">
            <button class="game-btn" onclick="actDraw()">Ôºã „Éâ„É≠„Éº</button>
            <button class="game-btn" onclick="actSyn()">‚öóÔ∏è ÂêàÊàê</button>
            <button class="game-btn" onclick="togglePokedexPanel()">Âõ≥Èëë</button>
        </div>

        <div class="pokedex-panel hidden" id="pokedexPanel">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                <div style="font-weight:900">Âõ≥Èëë</div>
                <button class="menu-btn" onclick="togglePokedexPanel()">Èñâ„Åò„Çã</button>
            </div>
            <div id="pokedexList"></div>
        </div>
    </div>

    <!-- Card detail -->
    <div id="card-detail-panel" onclick="hideDetail()">
        <div class="detail-close" onclick="hideDetail()">‚úï</div>
        <div class="detail-art" id="detail-art">?</div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
            <div style="font-weight:900" id="detail-name">Name</div>
            <div id="detail-rarity" style="font-weight:900;color:var(--accent)">R</div>
        </div>
        <div id="detail-stats" style="display:flex;justify-content:space-between;margin-bottom:8px">
            <div id="detail-atk">‚öîÔ∏è0</div>
            <div id="detail-hp">‚ù§Ô∏è0</div>
        </div>
        <div id="detail-skills" class="detail-skills"></div>
        <div style="text-align:center;color:#999;margin-top:8px;font-size:12px">(„Çø„ÉÉ„Éó„Åó„Å¶Èñâ„Åò„Çã)</div>
    </div>

    <!-- Full pokedex -->
    <div id="pokedex-screen" class="hidden screen" style="align-items:flex-start;padding:28px;box-sizing:border-box;z-index:4000">
        <div style="width:100%;max-width:1200px;color:white">
            <div style="display:flex;justify-content:space-between;align-items:center">
                <div style="font-size:20px;font-weight:900">Âõ≥Èëë</div>
                <div><button class="menu-btn" onclick="closeFullPokedex()">Èñâ„Åò„Çã</button></div>
            </div>
            <div id="pokedex-grid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:12px"></div>
        </div>
    </div>

    <div id="res-scr" class="hidden screen" style="background:rgba(0,0,0,0.95);z-index:6000">
        <div style="background:linear-gradient(180deg,#fff,#f7fbff);color:#112;padding:20px;border-radius:12px">
            <div id="res-tit" style="font-size:36px;font-weight:900">VICTORY</div>
            <div id="res-msg" style="margin-top:6px">„ÅÇ„Å™„Åü„ÅÆÂãùÂà©ÔºÅ</div>
            <div style="margin-top:10px"><button class="menu-btn btn-p" onclick="showTitle()">„Çø„Ç§„Éà„É´„Å∏Êàª„Çã</button></div>
        </div>
        <div id="confetti-container"></div>
    </div>

    <div id="msg-box" style="position:fixed;left:50%;top:48%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.8);padding:10px 18px;border-radius:10px;font-weight:900;color:#fff;opacity:0;z-index:5000"></div>

<script>
/* ===== constants and aliases to avoid name mismatches ===== */
const MAX_HAND = 10;
const MAX_FIELD = 5;
const INITIAL_HP = 25;
/* legacy aliases in case any old code references them */
const MAX_H = MAX_HAND, MAX_F = MAX_FIELD, INI_HP = INITIAL_HP;

/* ===== Data (kept structure similar to your REC/ELEM) ===== */
const ELEM = {
    H:{s:'H',n:'Ê∞¥Á¥†',r:'N',c:'art-gas'},
    He:{s:'He',n:'„Éò„É™„Ç¶„É†',r:'SR',c:'art-gas'},
    Li:{s:'Li',n:'„É™„ÉÅ„Ç¶„É†',r:'R',c:'art-met'},
    C:{s:'C',n:'ÁÇ≠Á¥†',r:'N',c:'art-solid'},
    O:{s:'O',n:'ÈÖ∏Á¥†',r:'N',c:'art-gas'},
    Cl:{s:'Cl',n:'Â°©Á¥†',r:'N',c:'art-toxic'},
    Na:{s:'Na',n:'„Éä„Éà„É™„Ç¶„É†',r:'N',c:'art-met'},
    Ag:{s:'Ag',n:'ÈäÄ',r:'SR',c:'art-metal'},
    Fe:{s:'Fe',n:'ÈâÑ',r:'N',c:'art-metal'},
    Cu:{s:'Cu',n:'ÈäÖ',r:'N',c:'art-metal'},
    Zn:{s:'Zn',n:'‰∫úÈâõ',r:'R',c:'art-metal'},
    F:{s:'F',n:'„Éï„ÉÉÁ¥†',r:'SR',c:'art-toxic'},
    S:{s:'S',n:'Á°´ÈªÑ',r:'R',c:'art-solid'},
    Cd:{s:'Cd',n:'„Ç´„Éâ„Éü„Ç¶„É†',r:'R',c:'art-toxic'},
    Al:{s:'Al',n:'„Ç¢„É´„Éü„Éã„Ç¶„É†',r:'R',c:'art-metal'},
    Si:{s:'Si',n:'„Ç±„Ç§Á¥†',r:'R',c:'art-solid'},
    Au:{s:'Au',n:'Èáë',r:'SSR',c:'art-metal'},
    Pt:{s:'Pt',n:'„Éó„É©„ÉÅ„Éä',r:'SSR',c:'art-metal'},
    W:{s:'W',n:'„Çø„É≥„Ç∞„Çπ„ÉÜ„É≥',r:'SSR',c:'art-metal'},
    Ne:{s:'Ne',n:'„Éç„Ç™„É≥',r:'SR',c:'art-gas'},
    Ar:{s:'Ar',n:'„Ç¢„É´„Ç¥„É≥',r:'SR',c:'art-gas'},
    Hg:{s:'Hg',n:'Ê∞¥ÈäÄ',r:'SR',c:'art-toxic'}
};

/* REC: ingredients array i, product p (p has fields s, n, r, a, h, ab(optional), sk(array)) */
const REC = [
    {i:['H','Cl'], p:{s:'HCl', n:'Â°©ÂåñÊ∞¥Á¥†', r:'R', a:5, h:1, c:'art-toxic', sk:[{n:'Âº∑ÈÖ∏ËÖêÈ£ü', p:5, d:'È´òÁÅ´Âäõ„ÅÆÈÖ∏ÊîªÊíÉ'}]}},
    {i:['H','F'], p:{s:'HF', n:'„Éï„ÉÉÂåñÊ∞¥Á¥†', r:'SR', a:4, h:2, ab:'tox', c:'art-toxic', sk:[{n:'„Ç¨„É©„ÇπËÖêÈ£ü', p:4, d:'ÈÄöÂ∏∏ÊîªÊíÉ'},{n:'ÁåõÊØí', p:0, t:'tox', d:'Ëß¶„Çå„Çã„Å®Âç±Èô∫(ÂøÖÊÆ∫)'}]}},
    {i:['Na','H'], p:{s:'NaH', n:'Ê∞¥Á¥†ÂåñNa', r:'R', a:3, h:1, ab:'stm', c:'art-solid', sk:[{n:'ÈÇÑÂÖÉ‰ΩúÁî®', p:3, d:'ÁñæËµ∞:Âç≥ÊîªÊíÉÂèØËÉΩ'}]}},
    {i:['H','H','O'], p:{s:'H2O', n:'Ê∞¥', r:'N', a:1, h:4, c:'art-liquid', sk:[{n:'Ê∞¥ÊµÅ', p:1, d:'ÊîªÊíÉ'},{n:'Âä†Ê∞¥ÂàÜËß£', p:3, t:'heal', d:'„É™„Éº„ÉÄ„Éº„Çí3ÂõûÂæ©'}]}},
    {i:['Ag','Cl'], p:{s:'AgCl', n:'Â°©ÂåñÈäÄ', r:'SR', a:1, h:6, ab:'wrd', c:'art-solid', sk:[{n:'ÁôΩËâ≤Ê≤àÊÆø', p:0, t:'grd', d:'ÂÆàË≠∑:Â£Å„Å´„Å™„Çã'}]}},
    {i:['C','O'], p:{s:'CO', n:'‰∏ÄÈÖ∏ÂåñÁÇ≠Á¥†', r:'R', a:1, h:2, ab:'tox', c:'art-gas', sk:[{n:'‰∏çÂÆåÂÖ®ÁáÉÁÑº', p:1, d:'ÊîªÊíÉ'},{n:'„Éò„É¢„Ç∞„É≠„Éì„É≥ÁµêÂêà', p:0, t:'tox', d:'ÂøÖÊÆ∫:Âç≥Ê≠ª„Åï„Åõ„Çã'}]}},
    {i:['Cl','Cl'], p:{s:'Cl2', n:'Â°©Á¥†„Ç¨„Çπ', r:'R', a:3, h:3, c:'art-gas', sk:[{n:'ÊØí„Ç¨„ÇπÊï£Â∏É', p:2, t:'aoe', d:'ÊïµÂÖ®‰Ωì„Å´2„ÉÄ„É°„Éº„Ç∏'}]}},
    {i:['C','C','C'], p:{s:'Diamond', n:'„ÉÄ„Ç§„É§„É¢„É≥„Éâ', r:'SSR', a:4, h:10, ab:'wrd', c:'art-solid', sk:[{n:'„É¢„Éº„ÇπÁ°¨Â∫¶10', p:4, d:'ÊúÄÂº∑„ÅÆÁ°¨Â∫¶'}]}},
    {i:['Au'], p:{s:'Au', n:'Èáë', r:'SSR', a:6, h:6, c:'art-metal', sk:[{n:'‰∏çÂ§â„ÅÆËºù„Åç', p:6, d:'ÁéãÊ∞¥‰ª•Â§ñÁÑ°Êïµ„ÅÆÊîªÊíÉ'}]}},
    {i:['H','Cl','N','O','O','O'], p:{s:'AquaRegia', n:'ÁéãÊ∞¥', r:'SSR', a:0, h:0, tp:'spl', c:'art-liquid', sk:[{n:'ÈáëÊ∫∂„Åã„Åó', p:99, t:'tox', d:'Âçò‰ΩìÁ¢∫ÂÆöÈô§Âéª'}]}},
    {i:['H','H','S','O','O','O','O'], p:{s:'H2SO4', n:'ÊøÉÁ°´ÈÖ∏', r:'SR', a:0, h:0, tp:'spl', c:'art-liquid', sk:[{n:'ËÑ±Ê∞¥‰ΩúÁî®', p:5, t:'aoe', d:'ÊïµÂÖ®‰Ωì5„ÉÄ„É°„Éº„Ç∏'}]}},
    {i:['K','Mn','O','O','O','O'], p:{s:'KMnO4', n:'ÈÅé„Éû„É≥„Ç¨„É≥ÈÖ∏K', r:'SR', a:0, h:0, tp:'spl', c:'art-solid', sk:[{n:'Âº∑ÂäõÈÖ∏Âåñ', p:7, t:'damage', d:'Âçò‰Ωì7„ÉÄ„É°„Éº„Ç∏'}]}}
];

/* DECKS: recipe identifiers are product symbols (p.s) */
const DECKS = {
    aggro:{n:'Ë∂ÖÈÄüÊîª', d:'È´òÁÅ´Âäõ„Éª‰ΩéËÄê‰πÖ', e:['H','H','Cl','F','Na','O'], r:['HCl','HF','NaH','H2O']},
    counter:{n:'„Ç´„Ç¶„É≥„Çø„Éº', d:'ÂÆà„Å£„Å¶ÂèçÊíÉ', e:['Ag','Cl','Fe','O','Cu','Zn','Hg'], r:['AgCl']},
    toxic:{n:'ÂÆ≥ÊÇ™', d:'ÂøÖÊÆ∫„ÅßÂç≥Ê≠ª', e:['C','O','S','H','Cl','Cd'], r:['CO','Cl2']},
    control:{n:'„Ç≥„É≥„Éà„É≠„Éº„É´', d:'ÂõûÂæ©„Å®ÊîØÈÖç', e:['Al','O','H','Na','Cl','Ca'], r:[]},
    gemstone:{n:'ÂÆùÁü≥', d:'ÊúÄÂº∑„ÅÆÁ°¨Â∫¶', e:['C','Al','O','Si','Cr','Ti'], r:['Diamond']},
    heavy:{n:'ÈáçÈáëÂ±û', d:'ÂæåÂçäÊúÄÂº∑', e:['Au','Pt','W','Ti'], r:['Au']},
    noble:{n:'Ë≤¥„Ç¨„Çπ', d:'ÊΩú‰ºèÊîªÊíÉ', e:['He','He','Ne','Ne','Ar','Ar'], r:['He','Ne','Ar']},
    hazard:{n:'Âç±Èô∫Áâ©', d:'Èô§Âéª„Çπ„Éö„É´', e:['H','Cl','N','O','S','K','Mn'], r:['AquaRegia','H2SO4','KMnO4']}
};

/* ===== game state ===== */
let gs = {
    mode: 'cpu',
    p1: null,
    p2: null,
    turn: 1,
    isP1Turn: true,
    active: null,
    other: null,
    sel: [],
    atk: null
};
let p1Key = null;

/* ===== helpers ===== */
function uid(){ return Math.random().toString(36).slice(2,10); }
const sleep = m => new Promise(r=>setTimeout(r,m));

/* ===== UI init ===== */
window.onload = () => {
    buildDeckGrid();
    buildLibrary();
    renderPokedexPanel();
    showTitle();
};

function buildDeckGrid(){
    const g = document.getElementById('deck-grid-container');
    g.innerHTML = '';
    Object.keys(DECKS).forEach(k=>{
        const d = document.createElement('div'); d.className='deck-card';
        d.innerHTML = `<div class="deck-title">${DECKS[k].n}</div><div class="deck-desc">${DECKS[k].d}</div>`;
        d.onclick = ()=> deckSelected(k);
        g.appendChild(d);
    });
}

/* ===== screen switches ===== */
function hideAll(){
    document.querySelectorAll('.screen').forEach(s=>s.classList.add('hidden'));
    document.getElementById('game-board').style.display = 'none';
    document.getElementById('pokedexPanel')?.classList.add('hidden');
    document.getElementById('res-scr').classList.add('hidden');
}
function showTitle(){ hideAll(); document.getElementById('title-screen').classList.remove('hidden'); }
function showDeckSelect(mode){ gs.mode = mode; hideAll(); document.getElementById('title-screen').classList.remove('hidden'); /* title already contains deck list */ }
function togglePokedexPanel(){ const p = document.getElementById('pokedexPanel'); if(!p) return; p.classList.toggle('hidden'); renderPokedexPanel(); }
function togglePokedexFull(){ hideAll(); document.getElementById('pokedex-screen').classList.remove('hidden'); renderFullPokedex(); }
function closeFullPokedex(){ document.getElementById('pokedex-screen').classList.add('hidden'); showTitle(); }

/* ===== deck selection flow ===== */
function deckSelected(key){
    if(gs.mode === 'cpu'){
        startGame(key, null);
    } else {
        if(!p1Key){
            p1Key = key;
            document.querySelector('#title-screen .game-logo').innerText = "PLAYER1 ÈÅ∏ÊäûÂÆå‰∫Ü";
            alert("Player 1 ÈÅ∏ÊäûÂÆå‰∫Ü„ÄÇÊ¨°„ÅØ Player 2 „ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
        } else {
            startGame(p1Key, key);
            p1Key = null;
        }
    }
}

/* ===== start/reset game ===== */
function startGame(k1, k2){
    const createPlayer = (key, name) => {
        const pool = (DECKS[key] && DECKS[key].e) ? DECKS[key].e.map(s => ELEM[s] || {s:s,n:s,r:'N',c:''}) : [];
        const rec = REC.filter(r => DECKS[key] && DECKS[key].r.includes(r.p.s));
        return { name, hp: INITIAL_HP, mp:1, maxMp:1, pool, rec, h:[], f:[] };
    };

    gs.p1 = createPlayer(k1, 'Player 1');
    if(gs.mode === 'cpu'){
        const keys = Object.keys(DECKS);
        const ek = keys[Math.floor(Math.random()*keys.length)];
        gs.p2 = createPlayer(ek, `CPU (${DECKS[ek].n})`);
    } else {
        gs.p2 = createPlayer(k2, 'Player 2');
    }

    gs.turn = 1; gs.isP1Turn = true; gs.active = gs.p1; gs.other = gs.p2; gs.sel=[]; gs.atk=null;

    // initial draw
    for(let i=0;i<5;i++){ drawCard(gs.p1); drawCard(gs.p2); }

    hideAll();
    document.getElementById('game-board').style.display = 'flex';
    upd();
    showMessage('„Éê„Éà„É´ÈñãÂßãÔºÅ');
}

/* ===== core actions ===== */
function drawCard(player){
    if(!player || !player.pool) return null;
    if(player.h.length >= MAX_HAND) return null;
    const base = player.pool[Math.floor(Math.random()*player.pool.length)] || {s:'??',n:'‰∏çÊòé',r:'N',c:''};
    const card = {...base, id:uid(), type:'el'};
    player.h.push(card);
    unlockPokedex(card.s);
    return card;
}
function actDraw(){
    if(gs.active.mp < 1){ showMessage('MP‰∏çË∂≥'); return; }
    gs.active.mp--;
    drawCard(gs.active);
    upd();
}
function actSyn(){
    if(gs.sel.length === 0){ showMessage('Á¥†Êùê„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ'); return; }
    const selected = gs.active.h.filter(c => gs.sel.includes(c.id));
    const symbols = selected.map(c=>c.s).slice().sort();
    // single ingredient
    if(selected.length === 1){
        const r = gs.active.rec.find(x => x.i.length === 1 && x.i[0] === symbols[0]);
        if(r){ doSyn(r); return; }
    }
    // general match
    const r = gs.active.rec.find(x => JSON.stringify(x.i.slice().sort()) === JSON.stringify(symbols));
    if(r) doSyn(r);
    else { showMessage('ÂèçÂøú„Åó„Åæ„Åõ„Çì'); gs.sel=[]; upd(); }
}
function doSyn(r){
    // consume
    gs.active.h = gs.active.h.filter(c => !gs.sel.includes(c.id));
    gs.sel = [];
    // spell?
    if(r.p.tp === 'spl'){
        const skill = r.p.sk[0];
        if(gs.other.f.length > 0){
            const target = gs.other.f.reduce((a,b)=> (a.cur||a.h) > (b.cur||b.h) ? a : b);
            if(skill.t === 'tox') target.cur = -99;
            else target.cur = (target.cur || target.h) - (skill.p || 0);
            showMessage(`${skill.n} -> ${target.n || target.s}`);
        } else {
            gs.other.hp -= (skill.p || 0);
            showMessage(`${skill.n} -> „É™„Éº„ÉÄ„Éº`);
        }
        unlockPokedex(r.p.s);
        chk(); upd(); return;
    }
    // summon unit
    if(gs.active.f.length >= MAX_FIELD){ showMessage('„Éï„Ç£„Éº„É´„ÉâÊ∫ÄÂì°'); return; }
    const unit = {...r.p, id:uid(), max:r.p.h, cur:r.p.h, can: r.p.ab === 'stm', type:'unit' };
    gs.active.f.push(unit);
    unlockPokedex(unit.s);
    showMessage(`Âè¨Âñö: ${unit.n}`);
    upd();
}

/* ===== UI interactions ===== */
function onHandClick(id){
    if(!gs.active) return;
    const card = gs.active.h.find(c => c.id === id);
    if(card) showDetail(card, true);
    if(gs.sel.includes(id)) gs.sel = gs.sel.filter(x=>x!==id);
    else gs.sel.push(id);
    upd();
}
function onFieldClick(id, isPlayer){
    if(isPlayer){
        const u = gs.active.f.find(x=>x.id===id);
        if(!u) return;
        showDetail(u, false);
        if(u && u.can){ gs.atk = u; document.getElementById('cancel-btn').style.display='block'; upd(); }
    } else {
        if(gs.atk){
            const t = gs.other.f.find(x=>x.id===id);
            if(!t) return;
            if(t.ab === 'stl'){ showMessage('ÊΩú‰ºè‰∏≠ÔºÅ'); return; }
            prepareAttack(gs.atk, t, 'unit');
        } else {
            const ot = gs.other.f.find(x=>x.id===id);
            if(ot) showDetail(ot, false);
        }
    }
}
function onLeaderClick(side){
    if(!gs.atk) return;
    if(side === 'enemy' && gs.active === gs.p1) prepareAttack(gs.atk, 'leader', 'leader');
}

/* ===== detail panel (fixed IDs) ===== */
function showDetail(card, isElement){
    const panel = document.getElementById('card-detail-panel');
    if(!panel) return;
    panel.style.display = 'block';
    document.getElementById('detail-art').innerText = card.s || card.symbol || '?';
    document.getElementById('detail-name').innerText = card.n || card.name || (card.s || '');
    document.getElementById('detail-rarity').innerText = card.r || card.rarity || '';
    // stats
    if(card.type === 'el' || isElement){
        document.getElementById('detail-atk').innerText = 'Á¥†Êùê';
        document.getElementById('detail-hp').innerText = '';
        document.getElementById('detail-skills').innerHTML = '<div style="color:#bbb">ÂêàÊàêÁ¥†Êùê„Å®„Åó„Å¶‰ΩøÁî®„Åó„Åæ„Åô„ÄÇ</div>';
    } else {
        document.getElementById('detail-atk').innerText = `‚öîÔ∏è ${card.a || card.atk || 0}`;
        document.getElementById('detail-hp').innerText = `‚ù§Ô∏è ${card.cur || card.h || 0}/${card.max || card.h || 0}`;
        const skills = card.sk || card.skills || [];
        document.getElementById('detail-skills').innerHTML = skills.map(s => `<div style="margin-bottom:6px"><b>${s.n}</b> (${s.p || s.power}) ‚Äî ${s.d || s.desc || ''}</div>`).join('');
    }
}
function hideDetail(){ const p=document.getElementById('card-detail-panel'); if(p) p.style.display='none'; }

/* ===== attack and skills ===== */
function prepareAttack(attacker, target, type){
    if(type === 'leader' || (type === 'unit' && target.ability !== 'wrd')){
        const guards = gs.other.f.filter(u => u.ab === 'wrd' && u.ab !== 'stl');
        if(guards.length>0){ showMessage('ÂÆàË≠∑„Å´Èòª„Åæ„Çå„ÅüÔºÅ'); cancelAtk(); return; }
    }
    const skills = attacker.sk || attacker.skills || [];
    if(skills && skills.length > 1) openSkillModal(attacker, target);
    else executeSkill(attacker, target, skills && skills[0] ? skills[0] : {n:'ÈÄöÂ∏∏ÊîªÊíÉ', p: attacker.a || 1});
}
function openSkillModal(attacker, target){
    const modal = document.getElementById('skill-modal'); if(!modal) return;
    const list = document.getElementById('skill-list'); if(!list) return;
    list.innerHTML = '';
    (attacker.sk||attacker.skills||[]).forEach(s=>{
        const btn = document.createElement('div'); btn.className='sk-btn'; btn.innerText = `${s.n} (${s.p||0})`;
        btn.onclick = ()=>{ executeSkill(attacker, target, s); modal.classList.add('hidden'); };
        list.appendChild(btn);
    });
    modal.classList.remove('hidden');
}
function executeSkill(attacker, target, skill){
    if(!attacker) return;
    const name = skill.n || 'ÊäÄ';
    if(skill.t === 'aoe'){ gs.other.f.forEach(u=>u.cur -= (skill.p||0)); gs.other.hp -= (skill.p||0); }
    else if(skill.t === 'aoe_heal'){ gs.other.f.forEach(u=>u.cur -= (skill.p||0)); gs.active.hp += (skill.p||0); }
    else if(skill.t === 'heal'){ gs.active.hp += (skill.p||0); }
    else {
        const dmg = skill.p || 0;
        if(target === 'leader'){ gs.other.hp -= dmg; }
        else {
            if(skill.t === 'tox' && dmg > 0) target.cur = -99;
            else target.cur -= dmg;
            const counter = target.a || 0;
            if(target.cur <= 0 && target.ab === 'tox' && counter > 0) attacker.cur = -99;
            else attacker.cur -= counter;
        }
    }
    attacker.can = false;
    showMessage(`${attacker.n || attacker.s} „ÅÆ ${name}ÔºÅ`);
    cancelAtk();
    chk(); upd();
}

/* ===== turn / CPU flow ===== */
function cancelAtk(){ gs.atk = null; document.getElementById('cancel-btn').style.display='none'; upd(); }
function endTurn(){
    cancelAtk();
    if(gs.mode === 'cpu'){ showMessage('Êïµ„ÅÆ„Çø„Éº„É≥'); setTimeout(cpuTurn, 900); }
    else {
        // hotseat: swap active/other
        if(!gs.p2){ showMessage('ÂØæÊà¶Áõ∏Êâã„Åå„ÅÑ„Åæ„Åõ„Çì'); return; }
        gs.isP1Turn = !gs.isP1Turn;
        gs.active = gs.isP1Turn ? gs.p1 : gs.p2;
        gs.other  = gs.isP1Turn ? gs.p2 : gs.p1;
        gs.turn++;
        if(gs.active.maxMp < 10) gs.active.maxMp++;
        gs.active.mp = gs.active.maxMp;
        gs.active.f.forEach(u => u.can = true);
        drawCard(gs.active);
        showMessage(`${gs.active.name} „ÅÆ„Çø„Éº„É≥`);
        upd();
    }
}

async function cpuTurn(){
    // simple CPU performing draws/summons/attacks
    const e = gs.p2;
    if(e.maxMp < 10) e.maxMp++;
    e.mp = e.maxMp;
    drawCard(e); upd(); await sleep(600);

    let acted = true;
    while(acted && e.f.length < MAX_FIELD){
        acted = false;
        const handSymbols = e.h.map(c=>c.s);
        for(const r of e.rec){
            if(r.p.tp === 'spl') continue;
            const needed = [...r.i];
            const temp = [...handSymbols];
            let ok = true;
            for(const ing of needed){
                const idx = temp.indexOf(ing);
                if(idx === -1){ ok = false; break; }
                temp.splice(idx,1);
            }
            if(ok){
                // remove used cards
                for(const ing of r.i){
                    const idx = e.h.findIndex(c=>c.s === ing);
                    if(idx>=0) e.h.splice(idx,1);
                }
                const unit = {...r.p, id:uid(), max:r.p.h, cur:r.p.h, can:false, type:'unit'};
                e.f.push(unit);
                unlockPokedex(unit.s);
                showMessage(`CPU Âè¨Âñö: ${unit.n}`);
                acted = true; upd(); await sleep(700); break;
            }
        }
    }

    // attacks
    e.f.forEach(u => u.can = true);
    for(const u of e.f){
        if(!u.can) continue;
        const guard = gs.p1.f.find(g => g.ab === 'wrd' && g.ab !== 'stl');
        if(guard){
            // attack guard
            const dmg = (u.sk && u.sk[0] ? u.sk[0].p : u.a) || 1;
            if(u.sk && u.sk[0] && u.sk[0].t === 'tox' && dmg>0) guard.cur = -99;
            else guard.cur -= dmg;
            u.cur -= guard.a || 0;
            showMessage(`CPU -> ${guard.n||guard.s}`);
        } else {
            const dmg = (u.sk && u.sk[0] ? u.sk[0].p : u.a) || 1;
            if(u.sk && u.sk[0] && u.sk[0].t === 'tox' && dmg>0) gs.p1.hp -= 9999; // instant kill style
            else gs.p1.hp -= dmg;
            showMessage('CPU -> „É™„Éº„ÉÄ„Éº');
        }
        chk(); upd(); await sleep(700);
    }

    // restore to player
    gs.turn++; if(gs.p1.maxMp < 10) gs.p1.maxMp++; gs.p1.mp = gs.p1.maxMp;
    gs.p1.f.forEach(u=>u.can = true);
    drawCard(gs.p1); showMessage('„ÅÇ„Å™„Åü„ÅÆ„Çø„Éº„É≥'); upd();
}

/* ===== end game & helpers ===== */
function chk(){
    gs.active.f = (gs.active.f || []).filter(u => (u.cur || u.h) > 0);
    gs.other.f  = (gs.other.f  || []).filter(u => (u.cur || u.h) > 0);
    if(gs.other.hp <= 0){ showResult(true); return true; }
    if(gs.active.hp <= 0){ showResult(false); return true; }
    return false;
}
function showResult(win){
    document.getElementById('res-scr').classList.remove('hidden');
    const t = document.getElementById('res-tit'), m = document.getElementById('res-msg');
    if(gs.mode === 'cpu'){
        if(win){ t.innerText='VICTORY'; t.style.color = '#f1c40f'; m.innerText='ÂãùÂà©ÔºÅ'; createConfetti(); }
        else { t.innerText='DEFEAT'; t.style.color = '#e74c3c'; m.innerText='ÊïóÂåó...'; }
    } else {
        t.innerText='WINNER'; m.innerText = (win ? gs.active.name : gs.other.name) + ' „ÅÆÂãùÂà©ÔºÅ'; createConfetti();
    }
}

/* ===== rendering/updating UI ===== */
function upd(){
    const p = gs.active, e = gs.other;
    if(!p || !e) return;

    // turn / mp / hp
    document.getElementById('turn-display').innerText = `Turn ${gs.turn}`;
    document.getElementById('mp-display').innerText = `MP ${p.mp || 0}/${p.maxMp || 0}`;
    document.getElementById('player-hp').innerText = p.hp;
    document.getElementById('enemy-hp').innerText = e.hp;

    // ‚Üê„Åì„Åì„Çí‰øÆÊ≠£
    var enemyNameEl = document.getElementById('enemy-name');
    if (enemyNameEl) enemyNameEl.innerText = e.name || '';

    var leaderNameEl = document.querySelector('#leader-player .leader-name');
    if (leaderNameEl) leaderNameEl.innerText = p.name || '„ÅÇ„Å™„Åü';

    // hands / fields
    renderCards('player-hand-area', p.h, 'hand', true);
    renderCards('player-field', p.f, 'field', true);
    renderCards('enemy-field', e.f, 'field', false);

    // enemy hidden hand
    const eh = document.getElementById('enemy-hand-area');
    eh.innerHTML = '';
    (e.h || []).forEach(()=>{
        const d = document.createElement('div');
        d.className='card';
        d.style.width='36px';
        d.style.height='58px';
        d.style.background='#34495e';
        eh.appendChild(d);
    });

    // craft list
    const craftEl = document.getElementById('craft-list');
    if (craftEl) craftEl.innerHTML = '';

    if(gs.mode === 'cpu' && !gs.isP1Turn) return;

    (gs.active.rec || []).forEach(r=>{
        const handSymbols = (gs.active.h||[]).map(c=>c.s);
        let ok = true;
        const tmp = handSymbols.slice();
        for(const ing of r.i){
            const idx = tmp.indexOf(ing);
            if(idx === -1){ ok=false; break; }
            tmp.splice(idx,1);
        }
        if(ok){
            const btn = document.createElement('div');
            btn.className='craft-btn';
            btn.style.marginBottom='6px';
            btn.innerHTML =
                `<div style="font-weight:900;color:var(--accent)">${r.p.n}</div>
                 <div style="font-size:12px">‚öîÔ∏è ${r.p.a||0} ‚ù§Ô∏è ${r.p.h||0}</div>`;
            btn.onclick = ()=>{
                gs.sel = [];
                const th = gs.active.h.slice();
                r.i.forEach(ing=>{
                    const idx = th.findIndex(c=>c.s === ing);
                    if(idx !== -1){
                        gs.sel.push(th[idx].id);
                        th.splice(idx,1);
                    }
                });
                upd();
            };
            craftEl.appendChild(btn);
        }
    });
}


/* helper to render lists of cards */
function renderCards(containerId, cards, type, isPlayer){
    const el = document.getElementById(containerId);
    if(!el) return;
    el.innerHTML = '';
    (cards||[]).forEach(c=>{
        const cardEl = document.createElement('div'); cardEl.className='card';
        cardEl.setAttribute('data-rarity', c.r || c.rarity || 'N');
        // content
        if(c.type === 'el' || !c.type){
            cardEl.innerHTML = `<div class="card-art">${c.s}</div><div class="card-info"><div class="card-symbol">${c.s}</div><div class="card-name">${c.n}</div></div>`;
        } else {
            let badges = `<div class="ability-container">`;
            if(c.ab === 'wrd' || c.ability === 'ward') badges += `<div class="badge">üõ°</div>`;
            if(c.ab === 'tox' || c.ability === 'toxic') badges += `<div class="badge">‚ò†Ô∏è</div>`;
            if(c.ab === 'stm' || c.ability === 'storm') badges += `<div class="badge">‚ö°</div>`;
            if(c.ab === 'stl' || c.ability === 'stealth') badges += `<div class="badge">üëÅÔ∏è</div>`;
            badges += `</div>`;
            cardEl.innerHTML = `${badges}<div class="card-art">${c.s}</div><div class="card-info"><div class="card-symbol">${c.s}</div><div class="card-name">${c.n}</div><div class="stats"><div class="stat-box stat-atk">‚öîÔ∏è${c.a||0}</div><div class="stat-box stat-hp">‚ù§Ô∏è${c.cur||c.h||0}</div></div></div>`;
        }
        // classes for selectable/attackable
        if(type === 'hand' && gs.sel.includes(c.id)) cardEl.classList.add('selected');
        if(type === 'field' && isPlayer && c.can) cardEl.classList.add('can-attack');
        if(type === 'field' && !isPlayer && gs.atk && c.ab !== 'stl') cardEl.classList.add('valid-target');

        // click handlers
        cardEl.onclick = (ev) => {
            ev.stopPropagation();
            // find by id presence
            const inHand = (gs.active.h || []).some(x=>x.id === c.id);
            const inActiveField = (gs.active.f || []).some(x=>x.id === c.id);
            const inOtherField = (gs.other.f || []).some(x=>x.id === c.id);
            if(inHand) onHandClick(c.id);
            else if(inActiveField) onFieldClick(c.id, true);
            else if(inOtherField) onFieldClick(c.id, false);
            else showDetail(c, c.type==='el');
        };
        el.appendChild(cardEl);
    });
}

/* ===== library / pokedex ===== */
function buildLibrary(){
    const grid = document.getElementById('pokedex-grid');
    // left blank until toggled; also fill small lib
    const lib = document.getElementById('pokedexList');
    if(lib){
        Object.keys(ELEM).forEach(k=>{
            const e = ELEM[k];
            const ent = document.createElement('div'); ent.style.display='flex'; ent.style.gap='8px'; ent.style.alignItems='center'; ent.style.padding='6px'; ent.style.borderBottom='1px solid #eee';
            const mini = document.createElement('div'); mini.style.width='36px'; mini.style.height='36px'; mini.style.borderRadius='6px'; mini.style.background='#fff'; mini.style.color='#222'; mini.style.display='flex'; mini.style.alignItems='center'; mini.style.justifyContent='center'; mini.innerText = e.s;
            const txt = document.createElement('div'); txt.innerHTML = `<div style="font-weight:900">${e.n} (${e.s})</div><div style="color:#666">„É¨„Ç¢Â∫¶: ${e.r}</div>`;
            ent.appendChild(mini); ent.appendChild(txt);
            lib.appendChild(ent);
        });
    }
}
function renderPokedexPanel(){
    const list = document.getElementById('pokedexList');
    if(!list) return;
    list.innerHTML = '';
    Object.keys(ELEM).forEach(k=>{
        const e = ELEM[k];
        const ent = document.createElement('div'); ent.className='pokedex-entry'; ent.style.display='flex'; ent.style.gap='8px'; ent.style.alignItems='center'; ent.style.padding='8px'; ent.style.borderRadius='8px'; ent.style.background='linear-gradient(180deg,#fff,#f1f7ff)'; ent.style.marginBottom='8px';
        const mini = document.createElement('div'); mini.className='mini-art'; mini.style.width='56px'; mini.style.height='56px'; mini.style.borderRadius='8px'; mini.style.display='flex'; mini.style.alignItems='center'; mini.style.justifyContent='center'; mini.style.fontSize='26px'; mini.innerText=e.s;
        const txt = document.createElement('div'); txt.innerHTML = `<div style="font-weight:900">${e.n} (${e.s})</div><div style="color:#666">„É¨„Ç¢Â∫¶: ${e.r}</div>`;
        ent.appendChild(mini); ent.appendChild(txt); list.appendChild(ent);
    });
}
function renderFullPokedex(){
    const grid = document.getElementById('pokedex-grid'); if(!grid) return;
    grid.innerHTML = '';
    Object.keys(ELEM).forEach(k=>{
        const e = ELEM[k];
        const c = document.createElement('div'); c.style.background='linear-gradient(180deg,#fff,#f1f7ff)'; c.style.color='#112'; c.style.padding='8px'; c.style.borderRadius='10px'; c.style.display='flex'; c.style.flexDirection='column'; c.style.alignItems='center';
        const mini = document.createElement('div'); mini.className='mini-art'; mini.style.width='72px'; mini.style.height='72px'; mini.style.borderRadius='8px'; mini.style.display='flex'; mini.style.alignItems='center'; mini.style.justifyContent='center'; mini.style.fontSize='28px'; mini.innerText=e.s;
        const nm = document.createElement('div'); nm.style.fontWeight='900'; nm.style.marginTop='6px'; nm.innerText = `${e.n} (${e.s})`;
        const sub = document.createElement('div'); sub.style.color='#556'; sub.style.fontSize='13px'; sub.style.marginTop='6px'; sub.innerText = `„É¨„Ç¢Â∫¶: ${e.r}`;
        c.appendChild(mini); c.appendChild(nm); c.appendChild(sub); grid.appendChild(c);
    });
}

/* ===== misc UI ===== */
let msgTimer = null;
function showMessage(t, time=1200){ const m=document.getElementById('msg-box'); if(!m) return; m.innerText=t; m.style.opacity=1; if(msgTimer) clearTimeout(msgTimer); msgTimer=setTimeout(()=>m.style.opacity=0,time); }
function showMessageImmediate(t){ showMessage(t,1200); }
function unlockPokedex(sym){ /* simple: nothing fancy here; could store to localStorage if desired */ }

/* confetti */
function createConfetti(){ const c=document.getElementById('confetti-container'); if(!c) return; c.innerHTML=''; for(let i=0;i<40;i++){ const d=document.createElement('div'); d.className='confetti'; d.style.left=(Math.random()*80+10)+'vw'; d.style.backgroundColor=`hsl(${Math.random()*360},80%,60%)`; d.style.width='10px'; d.style.height='10px'; d.style.position='absolute'; d.style.top='0'; c.appendChild(d);} }

/* ===== keyboard: ensure nothing causes error when clicking empty areas ===== */
document.addEventListener('click', (e)=>{ /* click on body hides detail */ });

</script>
</body>
</html>
